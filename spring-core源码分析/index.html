<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <title>Spring Core源码分析 &middot; 狄俊&#39;s blog</title>
    <meta name="generator" content="Hugo 0.75.1" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="author" content="狄俊">
    
      <meta name="description" content="">
    
    
    <link rel="canonical" href="https://dijun.cf/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <link rel="icon" href="https://dijun.cf/favicon.ico">
    <link rel="apple-touch-icon" href="https://dijun.cf/apple-touch-icon.png"/>
    <link rel="stylesheet" href="https://dijun.cf/css/style.css">
    <link rel="stylesheet" href="https://dijun.cf/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://dijun.cf/css/monokai.css">
    <link rel="stylesheet" href="https://dijun.cf/fancybox/jquery.fancybox.css">
    
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <meta property="og:title" content="Spring Core源码分析" />
<meta property="og:description" content="基本
本部分从最基本的Spring开始。配置文件:
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;    
&lt;beans&gt;    
    &lt;bean class=&#34;base.SimpleBean&#34;&gt;&lt;/bean&gt;
&lt;/beans&gt;
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dijun.cf/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" />
<meta property="article:published_time" content="2018-06-06T11:50:05+00:00" />
<meta property="article:modified_time" content="2018-06-06T11:50:05+00:00" />

    
    <meta itemprop="name" content="Spring Core源码分析">
<meta itemprop="description" content="基本
本部分从最基本的Spring开始。配置文件:
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;    
&lt;beans&gt;    
    &lt;bean class=&#34;base.SimpleBean&#34;&gt;&lt;/bean&gt;
&lt;/beans&gt;
">
<meta itemprop="datePublished" content="2018-06-06T11:50:05+00:00" />
<meta itemprop="dateModified" content="2018-06-06T11:50:05+00:00" />
<meta itemprop="wordCount" content="4176">



<meta itemprop="keywords" content="spring," />

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring Core源码分析"/>
<meta name="twitter:description" content="基本
本部分从最基本的Spring开始。配置文件:
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;    
&lt;beans&gt;    
    &lt;bean class=&#34;base.SimpleBean&#34;&gt;&lt;/bean&gt;
&lt;/beans&gt;
"/>

    

    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
</head>
<body>
<div class="container">


<div id="container">
	<header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="https://dijun.cf" id="logo">
          
          <i class="logo" style="background-image: url('https://dijun.cf/images/logo.png')"></i>
          
          <span class="site-title">狄俊&#39;s blog</span>
      </a>
      <nav id="main-nav">
          
          
          <a class="main-nav-link" href="https://dijun.cf/">Home</a>
          
          
          
          <a class="main-nav-link" href="https://dijun.cf/categories/">Categories</a>
          
          
          
          <a class="main-nav-link" href="https://dijun.cf/tags/">Tags</a>
          
          

          

          
          
          
          
          
          
          
      </nav>
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://dijun.cf/images/avatar.png"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
              <input type="search" name="q" class="search-form-input" placeholder="Search">
              <button type="submit" class="search-form-submit">
              </button>
              <input type="hidden" name="sitesearch" value="https://dijun.cf" />
         </form>
        </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tbody>
          <tr>
          
          
          <td><a class="main-nav-link" href="https://dijun.cf/">Home</a></td>
          
          
          
          <td><a class="main-nav-link" href="https://dijun.cf/categories/">Categories</a></td>
          
          
          
          <td><a class="main-nav-link" href="https://dijun.cf/tags/">Tags</a></td>
          
          

          

          
          
          
          
          
          
          
          <td>
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
          <input type="search" name="q" class="search-form-input" placeholder="Search">
          <input type="hidden" name="sitesearch" value="https://dijun.cf" />
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</header>

   	
   	<div class="outer">
   	
    	<aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      <img id="avatar" src="https://dijun.cf/images/avatar.png">
      <h2 id="name">狄俊</h2>
      <h3 id="title">Java &amp; Big Data Engineer</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Shanghai</span>
      
          <a id="follow" href="https://dijun.cf">
              Follow
          </a>
      
    </div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        22
        <span>Posts</span>
      </div>
      <div class="article-info-block">
        
          5
        
        <span>
            Tags
        </span>
      </div>
    </div>
    <div class="profile-block social-links">
      <table>
        <tr>
          



















































          <td><a href="https://dijun.cf/index.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></td>
        </tr>
      </table>
    </div>
  </div>
</aside>

    

    <section id="main">
    
    <article id="page-undefined" class="article article-type-page" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
            
            <img src="/banners/banner3.jpg" class="article-banner">
        

        <header class="article-header">
    <a href="https://dijun.cf/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
    <h1 class="article-title" itemprop="name">
        Spring Core源码分析
    </h1>
    </a>
    <div class="article-meta">

        
        <div class="article-date">
            <i class="fa fa-calendar"></i>
            <time datetime="2018-06-06 11:50:05 &#43;0000 UTC" itemprop="datePublished">2018-06-06</time>
            &middot;
            4176
            words
            &middot;
            20
            minute read
        </div>
        
        
            
            
            <div class="article-category">
                <i class="fa fa-folder"></i>
                
                
                <a class="article-category-link" href="https://dijun.cf/categories/spring">spring</a>
                
                
            </div>
            
        

        
            
            
            <div class="article-category">
                <i class="fa fa-tags"></i>
                
                
                <a class="article-category-link" href="https://dijun.cf/tags/spring">spring</a>
                
                
            </div>
            
        
    </div>
</header>

        <div class="article-entry" itemprop="articleBody">
            <h1 id="基本">基本</h1>
<p>本部分从最基本的Spring开始。配置文件:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>    
<span style="color:#f92672">&lt;beans&gt;</span>    
    <span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.SimpleBean&#34;</span><span style="color:#f92672">&gt;&lt;/bean&gt;</span>
<span style="color:#f92672">&lt;/beans&gt;</span>
</code></pre></div><p>启动代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ClassPathXmlApplicationContext context <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClassPathXmlApplicationContext<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;config.xml&#34;</span><span style="color:#f92672">);</span>
    SimpleBean bean <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>SimpleBean<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    bean<span style="color:#f92672">.</span><span style="color:#a6e22e">send</span><span style="color:#f92672">();</span>
    context<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>SimpleBean:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SimpleBean</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">send</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;I am send method from SimpleBean!&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="classpathxmlapplicationcontext">ClassPathXmlApplicationContext</h2>
<p>整个继承体系如下:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ResourceLoader.jpg" alt="ResourceLoader继承体系"></p>
<p>ResourceLoader代表了<strong>加载资源的一种方式，正是策略模式的实现</strong>。</p>
<p>构造器源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ClassPathXmlApplicationContext</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> configLocations<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> refresh<span style="color:#f92672">,</span> ApplicationContext 	         parent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//null
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>parent<span style="color:#f92672">);</span>
    setConfigLocations<span style="color:#f92672">(</span>configLocations<span style="color:#f92672">);</span>
    <span style="color:#75715e">//默认true
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>refresh<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        refresh<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="构造器">构造器</h3>
<p>首先看父类构造器，沿着继承体系一直向上调用，直到AbstractApplicationContext:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">AbstractApplicationContext</span><span style="color:#f92672">(</span>ApplicationContext parent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">();</span>
    setParent<span style="color:#f92672">(</span>parent<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">AbstractApplicationContext</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">resourcePatternResolver</span> <span style="color:#f92672">=</span> getResourcePatternResolver<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>getResourcePatternResolver:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> ResourcePatternResolver <span style="color:#a6e22e">getResourcePatternResolver</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> PathMatchingResourcePatternResolver<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>PathMatchingResourcePatternResolver支持Ant风格的路径解析。</p>
<h3 id="设置配置文件路径">设置配置文件路径</h3>
<p>即AbstractRefreshableConfigApplicationContext.setConfigLocations:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setConfigLocations</span><span style="color:#f92672">(</span>String<span style="color:#f92672">...</span> locations<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>locations <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">noNullElements</span><span style="color:#f92672">(</span>locations<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Config locations must not be null&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">configLocations</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[</span>locations<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">];</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> locations<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">configLocations</span><span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> resolvePath<span style="color:#f92672">(</span>locations<span style="color:#f92672">[</span>i<span style="color:#f92672">]).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">configLocations</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>resolvePath:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">resolvePath</span><span style="color:#f92672">(</span>String path<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> getEnvironment<span style="color:#f92672">().</span><span style="color:#a6e22e">resolveRequiredPlaceholders</span><span style="color:#f92672">(</span>path<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>此方法的目的在于将占位符(placeholder)解析成实际的地址。比如可以这么写: <code>new ClassPathXmlApplicationContext(&quot;classpath:config.xml&quot;);</code>那么classpath:就是需要被解析的。</p>
<p>getEnvironment方法来自于ConfigurableApplicationContext接口，源码很简单，如果为空就调用createEnvironment创建一个。AbstractApplicationContext.createEnvironment:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> ConfigurableEnvironment <span style="color:#a6e22e">createEnvironment</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> StandardEnvironment<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="environment接口">Environment接口</h4>
<p>继承体系:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Environment.jpg" alt="Environment继承体系"></p>
<p>Environmen接口**代表了当前应用所处的环境。**从此接口的方法可以看出，其主要和profile、Property相关。</p>
<h5 id="profile">Profile</h5>
<p>Spring Profile特性是从3.1开始的，其主要是为了解决这样一种问题: 线上环境和测试环境使用不同的配置或是数据库或是其它。有了Profile便可以在 不同环境之间无缝切换。**Spring容器管理的所有bean都是和一个profile绑定在一起的。**使用了Profile的配置文件示例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;beans</span> <span style="color:#a6e22e">profile=</span><span style="color:#e6db74">&#34;develop&#34;</span><span style="color:#f92672">&gt;</span>  
    <span style="color:#f92672">&lt;context:property-placeholder</span> <span style="color:#a6e22e">location=</span><span style="color:#e6db74">&#34;classpath*:jdbc-develop.properties&#34;</span><span style="color:#f92672">/&gt;</span>  
<span style="color:#f92672">&lt;/beans&gt;</span>  
<span style="color:#f92672">&lt;beans</span> <span style="color:#a6e22e">profile=</span><span style="color:#e6db74">&#34;production&#34;</span><span style="color:#f92672">&gt;</span>  
    <span style="color:#f92672">&lt;context:property-placeholder</span> <span style="color:#a6e22e">location=</span><span style="color:#e6db74">&#34;classpath*:jdbc-production.properties&#34;</span><span style="color:#f92672">/&gt;</span>  
<span style="color:#f92672">&lt;/beans&gt;</span>  
<span style="color:#f92672">&lt;beans</span> <span style="color:#a6e22e">profile=</span><span style="color:#e6db74">&#34;test&#34;</span><span style="color:#f92672">&gt;</span>  
    <span style="color:#f92672">&lt;context:property-placeholder</span> <span style="color:#a6e22e">location=</span><span style="color:#e6db74">&#34;classpath*:jdbc-test.properties&#34;</span><span style="color:#f92672">/&gt;</span>  
<span style="color:#f92672">&lt;/beans&gt;</span>
</code></pre></div><p>在启动代码中可以用如下代码设置活跃(当前使用的)Profile:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">context<span style="color:#f92672">.</span><span style="color:#a6e22e">getEnvironment</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setActiveProfiles</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;dev&#34;</span><span style="color:#f92672">);</span>
</code></pre></div><p>当然使用的方式还有很多(比如注解)，参考:</p>
<p><a href="http://radiumxie.iteye.com/blog/1851919">spring3.1 profile 配置不同的环境</a></p>
<p><a href="http://www.mkyong.com/spring/spring-profiles-example/">Spring Profiles example</a></p>
<h5 id="property">Property</h5>
<p>这里的Property指的是程序运行时的一些参数，引用注释:</p>
<blockquote>
<blockquote>
<p>properties files, JVM system properties, system environment variables, JNDI, servlet context parameters, ad-hoc Properties objects,Maps, and so on.</p>
</blockquote>
</blockquote>
<h4 id="environment构造器">Environment构造器</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> MutablePropertySources propertySources <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MutablePropertySources<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">logger</span><span style="color:#f92672">);</span>
<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">AbstractEnvironment</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    customizePropertySources<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">propertySources</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="propertysources接口">PropertySources接口</h5>
<p>继承体系:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/PropertySources.jpg" alt="PropertySources继承体系"></p>
<p>此接口实际上是PropertySource的容器，默认的MutablePropertySources实现内部含有一个CopyOnWriteArrayList作为存储载体。</p>
<p>StandardEnvironment.customizePropertySources:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/** System environment property source name: {@value} */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;systemEnvironment&#34;</span><span style="color:#f92672">;</span>
<span style="color:#75715e">/** JVM system properties property source name: {@value} */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;systemProperties&#34;</span><span style="color:#f92672">;</span>
<span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">customizePropertySources</span><span style="color:#f92672">(</span>MutablePropertySources propertySources<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    propertySources<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> MapPropertySource
        <span style="color:#f92672">(</span>SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME<span style="color:#f92672">,</span> getSystemProperties<span style="color:#f92672">()));</span>
    propertySources<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> SystemEnvironmentPropertySource
        <span style="color:#f92672">(</span>SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME<span style="color:#f92672">,</span> getSystemEnvironment<span style="color:#f92672">()));</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="propertysource接口">PropertySource接口</h5>
<p>PropertySource接口代表了键值对的Property来源。继承体系：</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/PropertySource.jpg" alt="PropertySource继承体系"></p>
<p>AbstractEnvironment.getSystemProperties:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getSystemProperties</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">)</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperties</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>AccessControlException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">)</span> <span style="color:#66d9ef">new</span> ReadOnlySystemAttributesMap<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">getSystemAttribute</span><span style="color:#f92672">(</span>String attributeName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">return</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span>attributeName<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>AccessControlException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>logger<span style="color:#f92672">.</span><span style="color:#a6e22e">isInfoEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                        logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span>format<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Caught AccessControlException when accessing system &#34;</span> <span style="color:#f92672">+</span>
                                <span style="color:#e6db74">&#34;property [%s]; its value will be returned [null]. Reason: %s&#34;</span><span style="color:#f92672">,</span>
                                attributeName<span style="color:#f92672">,</span> ex<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">()));</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">};</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这里的实现很有意思，如果安全管理器阻止获取全部的系统属性，那么会尝试获取单个属性的可能性，如果还不行就抛异常了。</p>
<p>getSystemEnvironment方法也是一个套路，不过最终调用的是System.getenv，可以获取jvm和OS的一些版本信息。</p>
<h4 id="路径placeholder处理">路径Placeholder处理</h4>
<p>AbstractEnvironment.resolveRequiredPlaceholders:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">resolveRequiredPlaceholders</span><span style="color:#f92672">(</span>String text<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IllegalArgumentException <span style="color:#f92672">{</span>
    <span style="color:#75715e">//text即配置文件路径，比如classpath:config.xml
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">propertyResolver</span><span style="color:#f92672">.</span><span style="color:#a6e22e">resolveRequiredPlaceholders</span><span style="color:#f92672">(</span>text<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>propertyResolver是一个PropertySourcesPropertyResolver对象:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ConfigurablePropertyResolver propertyResolver <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">new</span> PropertySourcesPropertyResolver<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">propertySources</span><span style="color:#f92672">);</span>
</code></pre></div><h5 id="propertyresolver接口">PropertyResolver接口</h5>
<p>PropertyResolver继承体系(排除Environment分支):</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/PropertyResolver.jpg" alt="PropertyResolver继承体系"></p>
<p>此接口正是用来解析PropertyResource。</p>
<h5 id="解析">解析</h5>
<p>AbstractPropertyResolver.resolveRequiredPlaceholders:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">resolveRequiredPlaceholders</span><span style="color:#f92672">(</span>String text<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IllegalArgumentException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">strictHelper</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">strictHelper</span> <span style="color:#f92672">=</span> createPlaceholderHelper<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> doResolvePlaceholders<span style="color:#f92672">(</span>text<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">strictHelper</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> PropertyPlaceholderHelper <span style="color:#a6e22e">createPlaceholderHelper</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> ignoreUnresolvablePlaceholders<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//三个参数分别是${, }, :
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> PropertyPlaceholderHelper<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">placeholderPrefix</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">placeholderSuffix</span><span style="color:#f92672">,</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">valueSeparator</span><span style="color:#f92672">,</span> ignoreUnresolvablePlaceholders<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>doResolvePlaceholders：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">doResolvePlaceholders</span><span style="color:#f92672">(</span>String text<span style="color:#f92672">,</span> PropertyPlaceholderHelper helper<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//PlaceholderResolver接口依然是策略模式的体现
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> helper<span style="color:#f92672">.</span><span style="color:#a6e22e">replacePlaceholders</span><span style="color:#f92672">(</span>text<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> PropertyPlaceholderHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">PlaceholderResolver</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">resolvePlaceholder</span><span style="color:#f92672">(</span>String placeholderName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> getPropertyAsRawString<span style="color:#f92672">(</span>placeholderName<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>其实代码执行到这里的时候还没有进行xml配置文件的解析，那么这里的解析placeHolder是什么意思呢，原因在于可以这么写:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">System<span style="color:#f92672">.</span><span style="color:#a6e22e">setProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;spring&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;classpath&#34;</span><span style="color:#f92672">);</span>
ClassPathXmlApplicationContext context <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClassPathXmlApplicationContext<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;${spring}:config.xml&#34;</span><span style="color:#f92672">);</span>
SimpleBean bean <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>SimpleBean<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</code></pre></div><p>这样就可以正确解析。placeholder的替换其实就是字符串操作，这里只说一下正确的属性是怎么来的。实现的关键在于PropertySourcesPropertyResolver.getProperty:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">getPropertyAsRawString</span><span style="color:#f92672">(</span>String key<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> getProperty<span style="color:#f92672">(</span>key<span style="color:#f92672">,</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">protected</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> T <span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span>String key<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> targetValueType<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> resolveNestedPlaceholders<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">propertySources</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>PropertySource<span style="color:#f92672">&lt;?&gt;</span> propertySource <span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">propertySources</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Object value <span style="color:#f92672">=</span> propertySource<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> value<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>很明显了，就是从System.getProperty和System.getenv获取，但是由于环境变量是无法自定义的，所以其实此处只能通过System.setProperty指定。</p>
<p>注意，classpath:XXX这种写法的classpath前缀到目前为止还没有被处理。</p>
<h2 id="refresh">refresh</h2>
<p>Spring bean解析就在此方法，所以单独提出来。</p>
<p>AbstractApplicationContext.refresh:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">refresh</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> BeansException<span style="color:#f92672">,</span> IllegalStateException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">startupShutdownMonitor</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Prepare this context for refreshing.
</span><span style="color:#75715e"></span>        prepareRefresh<span style="color:#f92672">();</span>
        <span style="color:#75715e">// Tell the subclass to refresh the internal bean factory.
</span><span style="color:#75715e"></span>        ConfigurableListableBeanFactory beanFactory <span style="color:#f92672">=</span> obtainFreshBeanFactory<span style="color:#f92672">();</span>
        <span style="color:#75715e">// Prepare the bean factory for use in this context.
</span><span style="color:#75715e"></span>        prepareBeanFactory<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Allows post-processing of the bean factory in context subclasses.
</span><span style="color:#75715e"></span>            postProcessBeanFactory<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">);</span>
            <span style="color:#75715e">// Invoke factory processors registered as beans in the context.
</span><span style="color:#75715e"></span>            invokeBeanFactoryPostProcessors<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">);</span>
            <span style="color:#75715e">// Register bean processors that intercept bean creation.
</span><span style="color:#75715e"></span>            registerBeanPostProcessors<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">);</span>
            <span style="color:#75715e">// Initialize message source for this context.
</span><span style="color:#75715e"></span>            initMessageSource<span style="color:#f92672">();</span>
            <span style="color:#75715e">// Initialize event multicaster for this context.
</span><span style="color:#75715e"></span>            initApplicationEventMulticaster<span style="color:#f92672">();</span>
            <span style="color:#75715e">// Initialize other special beans in specific context subclasses.
</span><span style="color:#75715e"></span>            onRefresh<span style="color:#f92672">();</span>
            <span style="color:#75715e">// Check for listener beans and register them.
</span><span style="color:#75715e"></span>            registerListeners<span style="color:#f92672">();</span>
            <span style="color:#75715e">// Instantiate all remaining (non-lazy-init) singletons.
</span><span style="color:#75715e"></span>            finishBeanFactoryInitialization<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">);</span>
            <span style="color:#75715e">// Last step: publish corresponding event.
</span><span style="color:#75715e"></span>            finishRefresh<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>BeansException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Destroy already created singletons to avoid dangling resources.
</span><span style="color:#75715e"></span>            destroyBeans<span style="color:#f92672">();</span>
            <span style="color:#75715e">// Reset &#39;active&#39; flag.
</span><span style="color:#75715e"></span>            cancelRefresh<span style="color:#f92672">(</span>ex<span style="color:#f92672">);</span>
            <span style="color:#75715e">// Propagate exception to caller.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">throw</span> ex<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Reset common introspection caches in Spring&#39;s core, since we
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// might not ever need metadata for singleton beans anymore...
</span><span style="color:#75715e"></span>            resetCommonCaches<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="preparerefresh">prepareRefresh</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">prepareRefresh</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">startupDate</span> <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">closed</span><span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">active</span><span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">// Initialize any placeholder property sources in the context environment
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//空实现
</span><span style="color:#75715e"></span>    initPropertySources<span style="color:#f92672">();</span>
    <span style="color:#75715e">// Validate that all properties marked as required are resolvable
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// see ConfigurablePropertyResolver#setRequiredProperties
</span><span style="color:#75715e"></span>    getEnvironment<span style="color:#f92672">().</span><span style="color:#a6e22e">validateRequiredProperties</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// Allow for the collection of early ApplicationEvents,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// to be published once the multicaster is available...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">earlyApplicationEvents</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedHashSet<span style="color:#f92672">&lt;</span>ApplicationEvent<span style="color:#f92672">&gt;();</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="属性校验">属性校验</h4>
<p>AbstractEnvironment.validateRequiredProperties:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">validateRequiredProperties</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> MissingRequiredPropertiesException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">propertyResolver</span><span style="color:#f92672">.</span><span style="color:#a6e22e">validateRequiredProperties</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>AbstractPropertyResolver.validateRequiredProperties:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">validateRequiredProperties</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    MissingRequiredPropertiesException ex <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MissingRequiredPropertiesException<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String key <span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">requiredProperties</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span>key<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            ex<span style="color:#f92672">.</span><span style="color:#a6e22e">addMissingRequiredProperty</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>ex<span style="color:#f92672">.</span><span style="color:#a6e22e">getMissingRequiredProperties</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> ex<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>requiredProperties是通过setRequiredProperties方法设置的，保存在一个list里面，默认是空的，也就是不需要校验任何属性。</p>
<h3 id="beanfactory创建">BeanFactory创建</h3>
<p>由obtainFreshBeanFactory调用AbstractRefreshableApplicationContext.refreshBeanFactory:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">refreshBeanFactory</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> BeansException <span style="color:#f92672">{</span>
    <span style="color:#75715e">//如果已经存在，那么销毁之前的
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasBeanFactory<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        destroyBeans<span style="color:#f92672">();</span>
        closeBeanFactory<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">//创建了一个DefaultListableBeanFactory对象
</span><span style="color:#75715e"></span>    DefaultListableBeanFactory beanFactory <span style="color:#f92672">=</span> createBeanFactory<span style="color:#f92672">();</span>
    beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">setSerializationId</span><span style="color:#f92672">(</span>getId<span style="color:#f92672">());</span>
    customizeBeanFactory<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">);</span>
    loadBeanDefinitions<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactoryMonitor</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span> <span style="color:#f92672">=</span> beanFactory<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="beanfactory接口">BeanFactory接口</h4>
<p>此接口实际上就是Bean容器，其继承体系:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/BeanFactory.jpg" alt="BeanFactory继承体系"></p>
<h4 id="beanfactory定制">BeanFactory定制</h4>
<p>AbstractRefreshableApplicationContext.customizeBeanFactory方法用于给子类提供一个自由配置的机会，默认实现:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">customizeBeanFactory</span><span style="color:#f92672">(</span>DefaultListableBeanFactory beanFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">allowBeanDefinitionOverriding</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//默认false，不允许覆盖
</span><span style="color:#75715e"></span>        beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">setAllowBeanDefinitionOverriding</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">allowBeanDefinitionOverriding</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">allowCircularReferences</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//默认false，不允许循环引用
</span><span style="color:#75715e"></span>        beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">setAllowCircularReferences</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">allowCircularReferences</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="bean加载">Bean加载</h4>
<p>AbstractXmlApplicationContext.loadBeanDefinitions，这个便是核心的bean加载了:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loadBeanDefinitions</span><span style="color:#f92672">(</span>DefaultListableBeanFactory beanFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// Create a new XmlBeanDefinitionReader for the given BeanFactory.
</span><span style="color:#75715e"></span>    XmlBeanDefinitionReader beanDefinitionReader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> XmlBeanDefinitionReader<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">);</span>
    <span style="color:#75715e">// Configure the bean definition reader with this context&#39;s
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// resource loading environment.
</span><span style="color:#75715e"></span>    beanDefinitionReader<span style="color:#f92672">.</span><span style="color:#a6e22e">setEnvironment</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getEnvironment</span><span style="color:#f92672">());</span>
    beanDefinitionReader<span style="color:#f92672">.</span><span style="color:#a6e22e">setResourceLoader</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    beanDefinitionReader<span style="color:#f92672">.</span><span style="color:#a6e22e">setEntityResolver</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ResourceEntityResolver<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">));</span>
    <span style="color:#75715e">// Allow a subclass to provide custom initialization of the reader,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// then proceed with actually loading the bean definitions.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//默认空实现
</span><span style="color:#75715e"></span>    initBeanDefinitionReader<span style="color:#f92672">(</span>beanDefinitionReader<span style="color:#f92672">);</span>
    loadBeanDefinitions<span style="color:#f92672">(</span>beanDefinitionReader<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="entityresolver">EntityResolver</h5>
<p>此处只说明用到的部分继承体系:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/EntityResolver.jpg" alt="EntityResolver继承体系"></p>
<p>EntityResolver接口在org.xml.sax中定义。DelegatingEntityResolver用于schema和dtd的解析。</p>
<h5 id="beandefinitionreader">BeanDefinitionReader</h5>
<p>继承体系:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/BeanDefinitionReader.jpg" alt="BeanDefinitionReader继承体系"></p>
<h5 id="路径解析ant">路径解析(Ant)</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loadBeanDefinitions</span><span style="color:#f92672">(</span>XmlBeanDefinitionReader reader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Resource<span style="color:#f92672">[]</span> configResources <span style="color:#f92672">=</span> getConfigResources<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>configResources <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        reader<span style="color:#f92672">.</span><span style="color:#a6e22e">loadBeanDefinitions</span><span style="color:#f92672">(</span>configResources<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    String<span style="color:#f92672">[]</span> configLocations <span style="color:#f92672">=</span> getConfigLocations<span style="color:#f92672">();</span>
    <span style="color:#75715e">//here
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>configLocations <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        reader<span style="color:#f92672">.</span><span style="color:#a6e22e">loadBeanDefinitions</span><span style="color:#f92672">(</span>configLocations<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>AbstractBeanDefinitionReader.loadBeanDefinitions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">loadBeanDefinitions</span><span style="color:#f92672">(</span>String<span style="color:#f92672">...</span> locations<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> BeanDefinitionStoreException <span style="color:#f92672">{</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">notNull</span><span style="color:#f92672">(</span>locations<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Location array must not be null&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">int</span> counter <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String location <span style="color:#f92672">:</span> locations<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        counter <span style="color:#f92672">+=</span> loadBeanDefinitions<span style="color:#f92672">(</span>location<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> counter<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>之后调用:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">//第二个参数为空
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">loadBeanDefinitions</span><span style="color:#f92672">(</span>String location<span style="color:#f92672">,</span> Set<span style="color:#f92672">&lt;</span>Resource<span style="color:#f92672">&gt;</span> actualResources<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ResourceLoader resourceLoader <span style="color:#f92672">=</span> getResourceLoader<span style="color:#f92672">();</span>
    <span style="color:#75715e">//参见ResourceLoader类图，ClassPathXmlApplicationContext实现了此接口
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resourceLoader <span style="color:#66d9ef">instanceof</span> ResourcePatternResolver<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Resource pattern matching available.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            Resource<span style="color:#f92672">[]</span> resources <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>ResourcePatternResolver<span style="color:#f92672">)</span> resourceLoader<span style="color:#f92672">).</span><span style="color:#a6e22e">getResources</span><span style="color:#f92672">(</span>location<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">int</span> loadCount <span style="color:#f92672">=</span> loadBeanDefinitions<span style="color:#f92672">(</span>resources<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>actualResources <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Resource resource <span style="color:#f92672">:</span> resources<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    actualResources<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>resource<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span> loadCount<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BeanDefinitionStoreException<span style="color:#f92672">(</span>
                    <span style="color:#e6db74">&#34;Could not resolve bean definition resource pattern [&#34;</span> <span style="color:#f92672">+</span> location <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;]&#34;</span><span style="color:#f92672">,</span> ex<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Can only load single resources by absolute URL.
</span><span style="color:#75715e"></span>        Resource resource <span style="color:#f92672">=</span> resourceLoader<span style="color:#f92672">.</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span>location<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">int</span> loadCount <span style="color:#f92672">=</span> loadBeanDefinitions<span style="color:#f92672">(</span>resource<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>actualResources <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            actualResources<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>resource<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> loadCount<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>getResource的实现在AbstractApplicationContext：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Resource<span style="color:#f92672">[]</span> <span style="color:#a6e22e">getResources</span><span style="color:#f92672">(</span>String locationPattern<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
    <span style="color:#75715e">//构造器中初始化，PathMatchingResourcePatternResolver对象
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">resourcePatternResolver</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getResources</span><span style="color:#f92672">(</span>locationPattern<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>PathMatchingResourcePatternResolver是ResourceLoader继承体系的一部分。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Resource<span style="color:#f92672">[]</span> <span style="color:#a6e22e">getResources</span><span style="color:#f92672">(</span>String locationPattern<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">notNull</span><span style="color:#f92672">(</span>locationPattern<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Location pattern must not be null&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">//classpath:
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>locationPattern<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span>CLASSPATH_ALL_URL_PREFIX<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// a class path resource (multiple resources for same name possible)
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//matcher是一个AntPathMatcher对象
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>getPathMatcher<span style="color:#f92672">().</span><span style="color:#a6e22e">isPattern</span><span style="color:#f92672">(</span>locationPattern
            <span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>CLASSPATH_ALL_URL_PREFIX<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">())))</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// a class path resource pattern
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> findPathMatchingResources<span style="color:#f92672">(</span>locationPattern<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// all class path resources with the given name
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> findAllClassPathResources<span style="color:#f92672">(</span>locationPattern
                <span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>CLASSPATH_ALL_URL_PREFIX<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()));</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Only look for a pattern after a prefix here
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// (to not get fooled by a pattern symbol in a strange prefix).
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> prefixEnd <span style="color:#f92672">=</span> locationPattern<span style="color:#f92672">.</span><span style="color:#a6e22e">indexOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;:&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> 1<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>getPathMatcher<span style="color:#f92672">().</span><span style="color:#a6e22e">isPattern</span><span style="color:#f92672">(</span>locationPattern<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>prefixEnd<span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// a file pattern
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> findPathMatchingResources<span style="color:#f92672">(</span>locationPattern<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// a single resource with the given name
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Resource<span style="color:#f92672">[]</span> <span style="color:#f92672">{</span>getResourceLoader<span style="color:#f92672">().</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span>locationPattern<span style="color:#f92672">)};</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>isPattern:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isPattern</span><span style="color:#f92672">(</span>String path<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>path<span style="color:#f92672">.</span><span style="color:#a6e22e">indexOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;*&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span>1 <span style="color:#f92672">||</span> path<span style="color:#f92672">.</span><span style="color:#a6e22e">indexOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;?&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出配置文件路径是支持ant风格的，也就是可以这么写:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">new</span> ClassPathXmlApplicationContext<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;con*.xml&#34;</span><span style="color:#f92672">);</span>
</code></pre></div><p>具体怎么解析ant风格的就不写了。</p>
<h5 id="配置文件加载">配置文件加载</h5>
<p>入口方法在AbstractBeanDefinitionReader的217行:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">//加载
</span><span style="color:#75715e"></span>Resource<span style="color:#f92672">[]</span> resources <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>ResourcePatternResolver<span style="color:#f92672">)</span> resourceLoader<span style="color:#f92672">).</span><span style="color:#a6e22e">getResources</span><span style="color:#f92672">(</span>location<span style="color:#f92672">);</span>
<span style="color:#75715e">//解析
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> loadCount <span style="color:#f92672">=</span> loadBeanDefinitions<span style="color:#f92672">(</span>resources<span style="color:#f92672">);</span>
</code></pre></div><p>最终逐个调用XmlBeanDefinitionReader的loadBeanDefinitions方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">loadBeanDefinitions</span><span style="color:#f92672">(</span>Resource resource<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> loadBeanDefinitions<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> EncodedResource<span style="color:#f92672">(</span>resource<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Resource是代表一种资源的接口，其类图:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Resource.jpg" alt="Resource类图"></p>
<p>EncodedResource扮演的其实是一个装饰器的模式，为InputStreamSource添加了字符编码(虽然默认为null)。这样为我们自定义xml配置文件的编码方式提供了机会。</p>
<p>之后关键的源码只有两行:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">loadBeanDefinitions</span><span style="color:#f92672">(</span>EncodedResource encodedResource<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> BeanDefinitionStoreException <span style="color:#f92672">{</span>
    InputStream inputStream <span style="color:#f92672">=</span> encodedResource<span style="color:#f92672">.</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getInputStream</span><span style="color:#f92672">();</span>
    InputSource inputSource <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InputSource<span style="color:#f92672">(</span>inputStream<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> doLoadBeanDefinitions<span style="color:#f92672">(</span>inputSource<span style="color:#f92672">,</span> encodedResource<span style="color:#f92672">.</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>InputSource是org.xml.sax的类。</p>
<p>doLoadBeanDefinitions：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">doLoadBeanDefinitions</span><span style="color:#f92672">(</span>InputSource inputSource<span style="color:#f92672">,</span> Resource resource<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Document doc <span style="color:#f92672">=</span> doLoadDocument<span style="color:#f92672">(</span>inputSource<span style="color:#f92672">,</span> resource<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> registerBeanDefinitions<span style="color:#f92672">(</span>doc<span style="color:#f92672">,</span> resource<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>doLoadDocument:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> Document <span style="color:#a6e22e">doLoadDocument</span><span style="color:#f92672">(</span>InputSource inputSource<span style="color:#f92672">,</span> Resource resource<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">documentLoader</span><span style="color:#f92672">.</span><span style="color:#a6e22e">loadDocument</span><span style="color:#f92672">(</span>inputSource<span style="color:#f92672">,</span> getEntityResolver<span style="color:#f92672">(),</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">errorHandler</span><span style="color:#f92672">,</span>
        getValidationModeForResource<span style="color:#f92672">(</span>resource<span style="color:#f92672">),</span> isNamespaceAware<span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>documentLoader是一个DefaultDocumentLoader对象，此类是DocumentLoader接口的唯一实现。getEntityResolver方法返回ResourceEntityResolver，上面说过了。errorHandler是一个SimpleSaxErrorHandler对象。</p>
<p>校验模型其实就是确定xml文件使用xsd方式还是dtd方式来校验，忘了的话左转度娘。Spring会通过读取xml文件的方式判断应该采用哪种。</p>
<p>NamespaceAware默认false，因为默认配置了校验为true。</p>
<p>DefaultDocumentLoader.loadDocument:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Document <span style="color:#a6e22e">loadDocument</span><span style="color:#f92672">(</span>InputSource inputSource<span style="color:#f92672">,</span> EntityResolver entityResolver<span style="color:#f92672">,</span>
    ErrorHandler errorHandler<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> validationMode<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> namespaceAware<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//这里就是老套路了，可以看出，Spring还是使用了dom的方式解析，即一次全部load到内存
</span><span style="color:#75715e"></span>    DocumentBuilderFactory factory <span style="color:#f92672">=</span> createDocumentBuilderFactory<span style="color:#f92672">(</span>validationMode<span style="color:#f92672">,</span> namespaceAware<span style="color:#f92672">);</span>
    DocumentBuilder builder <span style="color:#f92672">=</span> createDocumentBuilder<span style="color:#f92672">(</span>factory<span style="color:#f92672">,</span> entityResolver<span style="color:#f92672">,</span> errorHandler<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> builder<span style="color:#f92672">.</span><span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>inputSource<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>createDocumentBuilderFactory比较有意思:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> DocumentBuilderFactory <span style="color:#a6e22e">createDocumentBuilderFactory</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> validationMode<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> namespaceAware<span style="color:#f92672">{</span>
    DocumentBuilderFactory factory <span style="color:#f92672">=</span> DocumentBuilderFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">();</span>
    factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setNamespaceAware</span><span style="color:#f92672">(</span>namespaceAware<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>validationMode <span style="color:#f92672">!=</span> XmlValidationModeDetector<span style="color:#f92672">.</span><span style="color:#a6e22e">VALIDATION_NONE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//此方法设为true仅对dtd有效，xsd(schema)无效
</span><span style="color:#75715e"></span>        factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setValidating</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>validationMode <span style="color:#f92672">==</span> XmlValidationModeDetector<span style="color:#f92672">.</span><span style="color:#a6e22e">VALIDATION_XSD</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Enforce namespace aware for XSD...
</span><span style="color:#75715e"></span>             <span style="color:#75715e">//开启xsd(schema)支持
</span><span style="color:#75715e"></span>            factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setNamespaceAware</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
             <span style="color:#75715e">//这个也是Java支持Schema的套路，可以问度娘
</span><span style="color:#75715e"></span>            factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setAttribute</span><span style="color:#f92672">(</span>SCHEMA_LANGUAGE_ATTRIBUTE<span style="color:#f92672">,</span> XSD_SCHEMA_LANGUAGE<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> factory<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="bean解析">Bean解析</h5>
<p>XmlBeanDefinitionReader.registerBeanDefinitions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">registerBeanDefinitions</span><span style="color:#f92672">(</span>Document doc<span style="color:#f92672">,</span> Resource resource<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    BeanDefinitionDocumentReader documentReader <span style="color:#f92672">=</span> createBeanDefinitionDocumentReader<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">int</span> countBefore <span style="color:#f92672">=</span> getRegistry<span style="color:#f92672">().</span><span style="color:#a6e22e">getBeanDefinitionCount</span><span style="color:#f92672">();</span>
    documentReader<span style="color:#f92672">.</span><span style="color:#a6e22e">registerBeanDefinitions</span><span style="color:#f92672">(</span>doc<span style="color:#f92672">,</span> createReaderContext<span style="color:#f92672">(</span>resource<span style="color:#f92672">));</span>
    <span style="color:#66d9ef">return</span> getRegistry<span style="color:#f92672">().</span><span style="color:#a6e22e">getBeanDefinitionCount</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> countBefore<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>createBeanDefinitionDocumentReader:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> BeanDefinitionDocumentReader <span style="color:#a6e22e">createBeanDefinitionDocumentReader</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> BeanDefinitionDocumentReader<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cast</span>
      <span style="color:#75715e">//反射
</span><span style="color:#75715e"></span>      <span style="color:#f92672">(</span>BeanUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">instantiateClass</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">documentReaderClass</span><span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>documentReaderClass默认是DefaultBeanDefinitionDocumentReader，这其实也是策略模式，通过setter方法可以更换其实现。</p>
<p>注意cast方法，代替了强转。</p>
<p>createReaderContext：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> XmlReaderContext <span style="color:#a6e22e">createReaderContext</span><span style="color:#f92672">(</span>Resource resource<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> XmlReaderContext<span style="color:#f92672">(</span>resource<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">problemReporter</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">eventListener</span><span style="color:#f92672">,</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sourceExtractor</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> getNamespaceHandlerResolver<span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>problemReporter是一个FailFastProblemReporter对象。</p>
<p>eventListener是EmptyReaderEventListener对象，此类里的方法都是空实现。</p>
<p>sourceExtractor是NullSourceExtractor对象，直接返回空，也是空实现。</p>
<p>getNamespaceHandlerResolver默认返回DefaultNamespaceHandlerResolver对象，用来获取xsd对应的处理器。</p>
<p>XmlReaderContext的作用感觉就是这一堆参数的容器，糅合到一起传给DocumentReader，并美其名为Context。可以看出，Spring中到处都是策略模式，大量操作被抽象成接口。</p>
<p>DefaultBeanDefinitionDocumentReader.registerBeanDefinitions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerBeanDefinitions</span><span style="color:#f92672">(</span>Document doc<span style="color:#f92672">,</span> XmlReaderContext readerContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">readerContext</span> <span style="color:#f92672">=</span> readerContext<span style="color:#f92672">;</span>
    Element root <span style="color:#f92672">=</span> doc<span style="color:#f92672">.</span><span style="color:#a6e22e">getDocumentElement</span><span style="color:#f92672">();</span>
    doRegisterBeanDefinitions<span style="color:#f92672">(</span>root<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>doRegisterBeanDefinitions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doRegisterBeanDefinitions</span><span style="color:#f92672">(</span>Element root<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    BeanDefinitionParserDelegate parent <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span> <span style="color:#f92672">=</span> createDelegate<span style="color:#f92672">(</span>getReaderContext<span style="color:#f92672">(),</span> root<span style="color:#f92672">,</span> parent<span style="color:#f92672">);</span>
    <span style="color:#75715e">//默认的命名空间即
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//http://www.springframework.org/schema/beans
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isDefaultNamespace</span><span style="color:#f92672">(</span>root<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//检查profile属性
</span><span style="color:#75715e"></span>        String profileSpec <span style="color:#f92672">=</span> root<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>PROFILE_ATTRIBUTE<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasText</span><span style="color:#f92672">(</span>profileSpec<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">//profile属性可以以,分割
</span><span style="color:#75715e"></span>            String<span style="color:#f92672">[]</span> specifiedProfiles <span style="color:#f92672">=</span> StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">tokenizeToStringArray</span><span style="color:#f92672">(</span>
                    profileSpec<span style="color:#f92672">,</span> BeanDefinitionParserDelegate<span style="color:#f92672">.</span><span style="color:#a6e22e">MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>getReaderContext<span style="color:#f92672">().</span><span style="color:#a6e22e">getEnvironment</span><span style="color:#f92672">().</span><span style="color:#a6e22e">acceptsProfiles</span><span style="color:#f92672">(</span>specifiedProfiles<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    preProcessXml<span style="color:#f92672">(</span>root<span style="color:#f92672">);</span>
    parseBeanDefinitions<span style="color:#f92672">(</span>root<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span><span style="color:#f92672">);</span>
    postProcessXml<span style="color:#f92672">(</span>root<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span> <span style="color:#f92672">=</span> parent<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>delegate的作用在于处理beans标签的嵌套，其实Spring配置文件是可以写成这样的:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>    
<span style="color:#f92672">&lt;beans&gt;</span>    
    <span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.SimpleBean&#34;</span><span style="color:#f92672">&gt;&lt;/bean&gt;</span>
    <span style="color:#f92672">&lt;beans&gt;</span>
        <span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;java.lang.Object&#34;</span><span style="color:#f92672">&gt;&lt;/bean&gt;</span>
    <span style="color:#f92672">&lt;/beans&gt;</span>
<span style="color:#f92672">&lt;/beans&gt;</span>
</code></pre></div><p>xml(schema)的命名空间其实类似于java的报名，命名空间采用URL，比如Spring的是这样:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>    
<span style="color:#f92672">&lt;beans</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://www.springframework.org/schema/beans&#34;</span><span style="color:#f92672">&gt;&lt;/beans&gt;</span>
</code></pre></div><p>xmlns属性就是xml规范定义的用来设置命名空间的。这样设置了之后其实里面的bean元素全名就相当于<code>http://www.springframework.org/schema/beans:bean</code>，可以有效的防止命名冲突。命名空间可以通过规范定义的org.w3c.dom.Node.getNamespaceURI方法获得。</p>
<p>注意一下profile的检查, AbstractEnvironment.acceptsProfiles:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">acceptsProfiles</span><span style="color:#f92672">(</span>String<span style="color:#f92672">...</span> profiles<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">notEmpty</span><span style="color:#f92672">(</span>profiles<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Must specify at least one profile&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String profile <span style="color:#f92672">:</span> profiles<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasLength</span><span style="color:#f92672">(</span>profile<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> profile<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">(</span>0<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;!&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isProfileActive<span style="color:#f92672">(</span>profile<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>1<span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isProfileActive<span style="color:#f92672">(</span>profile<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>原理很简单，注意从源码可以看出，<strong>profile属性支持!取反</strong>。</p>
<p>preProcessXml方法是个空实现，供子类去覆盖，<strong>目的在于给子类一个把我们自定义的标签转为Spring标准标签的机会</strong>, 想的真周到。</p>
<p>DefaultBeanDefinitionDocumentReader.parseBeanDefinitions：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">parseBeanDefinitions</span><span style="color:#f92672">(</span>Element root<span style="color:#f92672">,</span> BeanDefinitionParserDelegate delegate<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>delegate<span style="color:#f92672">.</span><span style="color:#a6e22e">isDefaultNamespace</span><span style="color:#f92672">(</span>root<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        NodeList nl <span style="color:#f92672">=</span> root<span style="color:#f92672">.</span><span style="color:#a6e22e">getChildNodes</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> nl<span style="color:#f92672">.</span><span style="color:#a6e22e">getLength</span><span style="color:#f92672">();</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            Node node <span style="color:#f92672">=</span> nl<span style="color:#f92672">.</span><span style="color:#a6e22e">item</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node <span style="color:#66d9ef">instanceof</span> Element<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Element ele <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Element<span style="color:#f92672">)</span> node<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>delegate<span style="color:#f92672">.</span><span style="color:#a6e22e">isDefaultNamespace</span><span style="color:#f92672">(</span>ele<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    parseDefaultElement<span style="color:#f92672">(</span>ele<span style="color:#f92672">,</span> delegate<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    delegate<span style="color:#f92672">.</span><span style="color:#a6e22e">parseCustomElement</span><span style="color:#f92672">(</span>ele<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        delegate<span style="color:#f92672">.</span><span style="color:#a6e22e">parseCustomElement</span><span style="color:#f92672">(</span>root<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可见，对于非默认命名空间的元素交由delegate处理。</p>
<h4 id="默认命名空间解析">默认命名空间解析</h4>
<p>即import, alias, bean, 嵌套的beans四种元素。parseDefaultElement:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">parseDefaultElement</span><span style="color:#f92672">(</span>Element ele<span style="color:#f92672">,</span> BeanDefinitionParserDelegate delegate<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//&#34;import&#34;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>delegate<span style="color:#f92672">.</span><span style="color:#a6e22e">nodeNameEquals</span><span style="color:#f92672">(</span>ele<span style="color:#f92672">,</span> IMPORT_ELEMENT<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        importBeanDefinitionResource<span style="color:#f92672">(</span>ele<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>delegate<span style="color:#f92672">.</span><span style="color:#a6e22e">nodeNameEquals</span><span style="color:#f92672">(</span>ele<span style="color:#f92672">,</span> ALIAS_ELEMENT<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        processAliasRegistration<span style="color:#f92672">(</span>ele<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>delegate<span style="color:#f92672">.</span><span style="color:#a6e22e">nodeNameEquals</span><span style="color:#f92672">(</span>ele<span style="color:#f92672">,</span> BEAN_ELEMENT<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        processBeanDefinition<span style="color:#f92672">(</span>ele<span style="color:#f92672">,</span> delegate<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>delegate<span style="color:#f92672">.</span><span style="color:#a6e22e">nodeNameEquals</span><span style="color:#f92672">(</span>ele<span style="color:#f92672">,</span> NESTED_BEANS_ELEMENT<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// recurse
</span><span style="color:#75715e"></span>        doRegisterBeanDefinitions<span style="color:#f92672">(</span>ele<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="import">import</h5>
<p>写法示例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;import</span> <span style="color:#a6e22e">resource=</span><span style="color:#e6db74">&#34;CTIContext.xml&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;import</span> <span style="color:#a6e22e">resource=</span><span style="color:#e6db74">&#34;customerContext.xml&#34;</span> <span style="color:#f92672">/&gt;</span>
</code></pre></div><p>importBeanDefinitionResource套路和之前的配置文件加载完全一样，不过注意被import进来的文件是先于当前文件 被解析的。</p>
<h5 id="alias">alias</h5>
<p>加入有一个bean名为componentA-dataSource，但是另一个组件想以componentB-dataSource的名字使用，就可以这样定义:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;alias</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;componentA-dataSource&#34;</span> <span style="color:#a6e22e">alias=</span><span style="color:#e6db74">&#34;componentB-dataSource&#34;</span><span style="color:#f92672">/&gt;</span>
</code></pre></div><p>processAliasRegistration核心源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processAliasRegistration</span><span style="color:#f92672">(</span>Element ele<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String name <span style="color:#f92672">=</span> ele<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>NAME_ATTRIBUTE<span style="color:#f92672">);</span>
    String alias <span style="color:#f92672">=</span> ele<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>ALIAS_ATTRIBUTE<span style="color:#f92672">);</span>
    getReaderContext<span style="color:#f92672">().</span><span style="color:#a6e22e">getRegistry</span><span style="color:#f92672">().</span><span style="color:#a6e22e">registerAlias</span><span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> alias<span style="color:#f92672">);</span>
    getReaderContext<span style="color:#f92672">().</span><span style="color:#a6e22e">fireAliasRegistered</span><span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> alias<span style="color:#f92672">,</span> extractSource<span style="color:#f92672">(</span>ele<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>从前面的源码可以发现，registry其实就是DefaultListableBeanFactory，它实现了BeanDefinitionRegistry接口。registerAlias方法的实现在SimpleAliasRegistry:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerAlias</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">,</span> String alias<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">hasText</span><span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;&#39;name&#39; must not be empty&#34;</span><span style="color:#f92672">);</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">hasText</span><span style="color:#f92672">(</span>alias<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;&#39;alias&#39; must not be empty&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">//名字和别名一样
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>alias<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>name<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//ConcurrentHashMap
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">aliasMap</span><span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>alias<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        String registeredName <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">aliasMap</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>alias<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>registeredName <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>registeredName<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>name<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// An existing alias - no need to re-register
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>allowAliasOverriding<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException
                    <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Cannot register alias &#39;&#34;</span> <span style="color:#f92672">+</span> alias <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39; for name &#39;&#34;</span> <span style="color:#f92672">+</span>
                    name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;: It is already registered for name &#39;&#34;</span> <span style="color:#f92672">+</span> registeredName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;.&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        checkForAliasCircle<span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> alias<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">aliasMap</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>alias<span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>所以别名关系的保存使用Map完成，key为别名，value为本来的名字。</p>
<h5 id="bean">bean</h5>
<p>bean节点是Spring最最常见的节点了。</p>
<p>DefaultBeanDefinitionDocumentReader.processBeanDefinition:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processBeanDefinition</span><span style="color:#f92672">(</span>Element ele<span style="color:#f92672">,</span> BeanDefinitionParserDelegate delegate<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    BeanDefinitionHolder bdHolder <span style="color:#f92672">=</span> delegate<span style="color:#f92672">.</span><span style="color:#a6e22e">parseBeanDefinitionElement</span><span style="color:#f92672">(</span>ele<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bdHolder <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        bdHolder <span style="color:#f92672">=</span> delegate<span style="color:#f92672">.</span><span style="color:#a6e22e">decorateBeanDefinitionIfRequired</span><span style="color:#f92672">(</span>ele<span style="color:#f92672">,</span> bdHolder<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Register the final decorated instance.
</span><span style="color:#75715e"></span>            BeanDefinitionReaderUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">registerBeanDefinition</span>
                <span style="color:#f92672">(</span>bdHolder<span style="color:#f92672">,</span> getReaderContext<span style="color:#f92672">().</span><span style="color:#a6e22e">getRegistry</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>BeanDefinitionStoreException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            getReaderContext<span style="color:#f92672">().</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to register bean definition with name &#39;&#34;</span> <span style="color:#f92672">+</span>
                    bdHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;&#34;</span><span style="color:#f92672">,</span> ele<span style="color:#f92672">,</span> ex<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// Send registration event.
</span><span style="color:#75715e"></span>        getReaderContext<span style="color:#f92672">().</span><span style="color:#a6e22e">fireComponentRegistered</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> BeanComponentDefinition<span style="color:#f92672">(</span>bdHolder<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h6 id="id--name处理">id &amp; name处理</h6>
<p>最终调用BeanDefinitionParserDelegate.parseBeanDefinitionElement(Element ele, BeanDefinition containingBean)，源码较长，分部分说明。</p>
<p>首先获取到id和name属性，<strong>name属性支持配置多个，以逗号分隔，如果没有指定id，那么将以第一个name属性值代替。id必须是唯一的，name属性其实是alias的角色，可以和其它的bean重复，如果name也没有配置，那么其实什么也没做</strong>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">String id <span style="color:#f92672">=</span> ele<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>ID_ATTRIBUTE<span style="color:#f92672">);</span>
String nameAttr <span style="color:#f92672">=</span> ele<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>NAME_ATTRIBUTE<span style="color:#f92672">);</span>
List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> aliases <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;();</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasLength</span><span style="color:#f92672">(</span>nameAttr<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//按,分隔
</span><span style="color:#75715e"></span>    String<span style="color:#f92672">[]</span> nameArr <span style="color:#f92672">=</span> StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">tokenizeToStringArray</span>
        <span style="color:#f92672">(</span>nameAttr<span style="color:#f92672">,</span> MULTI_VALUE_ATTRIBUTE_DELIMITERS<span style="color:#f92672">);</span>
    aliases<span style="color:#f92672">.</span><span style="color:#a6e22e">addAll</span><span style="color:#f92672">(</span>Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span>nameArr<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
String beanName <span style="color:#f92672">=</span> id<span style="color:#f92672">;</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasText</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>aliases<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//name的第一个值作为id
</span><span style="color:#75715e"></span>    beanName <span style="color:#f92672">=</span> aliases<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">//默认null
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>containingBean <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//校验id是否已重复，如果重复直接抛异常
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//校验是通过内部一个HashSet完成的，出现过的id都会保存进此Set
</span><span style="color:#75715e"></span>    checkNameUniqueness<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> aliases<span style="color:#f92672">,</span> ele<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h6 id="beanname生成">beanName生成</h6>
<p>如果name和id属性都没有指定，那么Spring会自己生成一个, BeanDefinitionParserDelegate.parseBeanDefinitionElement:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">beanName <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">readerContext</span><span style="color:#f92672">.</span><span style="color:#a6e22e">generateBeanName</span><span style="color:#f92672">(</span>beanDefinition<span style="color:#f92672">);</span>
String beanClassName <span style="color:#f92672">=</span> beanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanClassName</span><span style="color:#f92672">();</span>
aliases<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>beanClassName<span style="color:#f92672">);</span>
</code></pre></div><p>可见，Spring同时会把类名作为其别名。</p>
<p>最终调用的是BeanDefinitionReaderUtils.generateBeanName:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">generateBeanName</span><span style="color:#f92672">(</span>
        BeanDefinition definition<span style="color:#f92672">,</span> BeanDefinitionRegistry registry<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> isInnerBean<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String generatedBeanName <span style="color:#f92672">=</span> definition<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanClassName</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>generatedBeanName <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>definition<span style="color:#f92672">.</span><span style="color:#a6e22e">getParentName</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            generatedBeanName <span style="color:#f92672">=</span> definition<span style="color:#f92672">.</span><span style="color:#a6e22e">getParentName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;$child&#34;</span><span style="color:#f92672">;</span>
             <span style="color:#75715e">//工厂方法产生的bean
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>definition<span style="color:#f92672">.</span><span style="color:#a6e22e">getFactoryBeanName</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            generatedBeanName <span style="color:#f92672">=</span> definition<span style="color:#f92672">.</span><span style="color:#a6e22e">getFactoryBeanName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;$created&#34;</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    String id <span style="color:#f92672">=</span> generatedBeanName<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isInnerBean<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Inner bean: generate identity hashcode suffix.
</span><span style="color:#75715e"></span>        id <span style="color:#f92672">=</span> generatedBeanName <span style="color:#f92672">+</span> GENERATED_BEAN_NAME_SEPARATOR <span style="color:#f92672">+</span> 
            ObjectUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getIdentityHexString</span><span style="color:#f92672">(</span>definition<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Top-level bean: use plain class name.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Increase counter until the id is unique.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> counter <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
         <span style="color:#75715e">//用类名#自增的数字命名
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>counter <span style="color:#f92672">==</span> <span style="color:#f92672">-</span>1 <span style="color:#f92672">||</span> registry<span style="color:#f92672">.</span><span style="color:#a6e22e">containsBeanDefinition</span><span style="color:#f92672">(</span>id<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            counter<span style="color:#f92672">++;</span>
            id <span style="color:#f92672">=</span> generatedBeanName <span style="color:#f92672">+</span> GENERATED_BEAN_NAME_SEPARATOR <span style="color:#f92672">+</span> counter<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> id<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h6 id="bean解析-1">bean解析</h6>
<p>还是分部分说明(parseBeanDefinitionElement)。</p>
<p>首先获取到bean的class属性和parent属性，配置了parent之后，当前bean会继承父bean的属性。之后根据class和parent创建BeanDefinition对象。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">String className <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ele<span style="color:#f92672">.</span><span style="color:#a6e22e">hasAttribute</span><span style="color:#f92672">(</span>CLASS_ATTRIBUTE<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    className <span style="color:#f92672">=</span> ele<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>CLASS_ATTRIBUTE<span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
String parent <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ele<span style="color:#f92672">.</span><span style="color:#a6e22e">hasAttribute</span><span style="color:#f92672">(</span>PARENT_ATTRIBUTE<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    parent <span style="color:#f92672">=</span> ele<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>PARENT_ATTRIBUTE<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
AbstractBeanDefinition bd <span style="color:#f92672">=</span> createBeanDefinition<span style="color:#f92672">(</span>className<span style="color:#f92672">,</span> parent<span style="color:#f92672">);</span>
</code></pre></div><p>BeanDefinition的创建在BeanDefinitionReaderUtils.createBeanDefinition:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> AbstractBeanDefinition <span style="color:#a6e22e">createBeanDefinition</span><span style="color:#f92672">(</span>
        String parentName<span style="color:#f92672">,</span> String className<span style="color:#f92672">,</span> ClassLoader classLoader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    GenericBeanDefinition bd <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> GenericBeanDefinition<span style="color:#f92672">();</span>
    bd<span style="color:#f92672">.</span><span style="color:#a6e22e">setParentName</span><span style="color:#f92672">(</span>parentName<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>className <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>classLoader <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            bd<span style="color:#f92672">.</span><span style="color:#a6e22e">setBeanClass</span><span style="color:#f92672">(</span>ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span>className<span style="color:#f92672">,</span> classLoader<span style="color:#f92672">));</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            bd<span style="color:#f92672">.</span><span style="color:#a6e22e">setBeanClassName</span><span style="color:#f92672">(</span>className<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> bd<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>之后是解析bean的其它属性，其实就是读取其配置，调用相应的setter方法保存在BeanDefinition中:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">parseBeanDefinitionAttributes<span style="color:#f92672">(</span>ele<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> containingBean<span style="color:#f92672">,</span> bd<span style="color:#f92672">);</span>
</code></pre></div><p>之后解析bean的decription子元素:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;b&#34;</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;one, two&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.SimpleBean&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;description&gt;</span>SimpleBean<span style="color:#f92672">&lt;/description&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div><p>就仅仅是个描述。</p>
<p>然后是meta子元素的解析，meta元素在xml配置文件里是这样的:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;b&#34;</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;one, two&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.SimpleBean&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;meta</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;name&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;skywalker&#34;</span><span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div><p>注释上说，这样可以将任意的元数据附到对应的bean definition上。解析过程源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">parseMetaElements</span><span style="color:#f92672">(</span>Element ele<span style="color:#f92672">,</span> BeanMetadataAttributeAccessor attributeAccessor<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    NodeList nl <span style="color:#f92672">=</span> ele<span style="color:#f92672">.</span><span style="color:#a6e22e">getChildNodes</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> nl<span style="color:#f92672">.</span><span style="color:#a6e22e">getLength</span><span style="color:#f92672">();</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
        Node node <span style="color:#f92672">=</span> nl<span style="color:#f92672">.</span><span style="color:#a6e22e">item</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isCandidateElement<span style="color:#f92672">(</span>node<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> nodeNameEquals<span style="color:#f92672">(</span>node<span style="color:#f92672">,</span> META_ELEMENT<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            Element metaElement <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Element<span style="color:#f92672">)</span> node<span style="color:#f92672">;</span>
            String key <span style="color:#f92672">=</span> metaElement<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>KEY_ATTRIBUTE<span style="color:#f92672">);</span>
            String value <span style="color:#f92672">=</span> metaElement<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>VALUE_ATTRIBUTE<span style="color:#f92672">);</span>
             <span style="color:#75715e">//就是一个key, value的载体，无他
</span><span style="color:#75715e"></span>            BeanMetadataAttribute attribute <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BeanMetadataAttribute<span style="color:#f92672">(</span>key<span style="color:#f92672">,</span> value<span style="color:#f92672">);</span>
             <span style="color:#75715e">//sourceExtractor默认是NullSourceExtractor，返回的是空
</span><span style="color:#75715e"></span>            attribute<span style="color:#f92672">.</span><span style="color:#a6e22e">setSource</span><span style="color:#f92672">(</span>extractSource<span style="color:#f92672">(</span>metaElement<span style="color:#f92672">));</span>
            attributeAccessor<span style="color:#f92672">.</span><span style="color:#a6e22e">addMetadataAttribute</span><span style="color:#f92672">(</span>attribute<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>AbstractBeanDefinition继承自BeanMetadataAttributeAccessor类，底层使用了一个LinkedHashMap保存metadata。这个metadata具体是做什么暂时还不知道。</p>
<p>lookup-method解析：</p>
<p>此标签的作用在于当一个bean的某个方法被设置为lookup-method后，<strong>每次调用此方法时，都会返回一个新的指定bean的对象</strong>。用法示例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;apple&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;cn.com.willchen.test.di.Apple&#34;</span> <span style="color:#a6e22e">scope=</span><span style="color:#e6db74">&#34;prototype&#34;</span><span style="color:#f92672">/&gt;</span>
<span style="color:#75715e">&lt;!--水果盘--&gt;</span>
<span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;fruitPlate&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;cn.com.willchen.test.di.FruitPlate&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;lookup-method</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;getFruit&#34;</span> <span style="color:#a6e22e">bean=</span><span style="color:#e6db74">&#34;apple&#34;</span><span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div><p>数据保存在Set中，对应的类是MethodOverrides。可以参考:</p>
<p><a href="http://www.cnblogs.com/ViviChan/p/4981619.html">Spring - lookup-method方式实现依赖注入</a></p>
<p>replace-mothod解析:</p>
<p>此标签用于替换bean里面的特定的方法实现，替换者必须实现Spring的MethodReplacer接口，有点像aop的意思。</p>
<p>配置文件示例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;replacer&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;springroad.deomo.chap4.MethodReplace&#34;</span> <span style="color:#f92672">/&gt;</span>  
<span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;testBean&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;springroad.deomo.chap4.LookupMethodBean&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;replaced-method</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;test&#34;</span> <span style="color:#a6e22e">replacer=</span><span style="color:#e6db74">&#34;replacer&#34;</span><span style="color:#f92672">&gt;</span>
        <span style="color:#f92672">&lt;arg-type</span> <span style="color:#a6e22e">match=</span><span style="color:#e6db74">&#34;String&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/replaced-method&gt;</span>  
<span style="color:#f92672">&lt;/bean&gt;</span> 
</code></pre></div><p>arg-type的作用是指定替换方法的参数类型，因为接口的定义参数都是Object的。参考: <a href="http://blog.csdn.net/lee576/article/details/8725548">SPRING.NET 1.3.2 学习20&ndash;方法注入之替换方法注入</a></p>
<p>解析之后将数据放在ReplaceOverride对象中，里面有一个LinkedList<!-- raw HTML omitted -->专门用于保存arg-type。</p>
<p>构造参数(constructor-arg)解析:</p>
<p>作用一目了然，使用示例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.SimpleBean&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;constructor-arg&gt;</span>
        <span style="color:#f92672">&lt;value</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;java.lang.String&#34;</span><span style="color:#f92672">&gt;</span>Cat<span style="color:#f92672">&lt;/value&gt;</span>
    <span style="color:#f92672">&lt;/constructor-arg&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div><p>type一般不需要指定，除了泛型集合那种。除此之外，constructor-arg还支持name, index, ref等属性，可以具体的指定参数的位置等。构造参数解析后保存在BeanDefinition内部一个ConstructorArgumentValues对象中。如果设置了index属性，那么以Map&lt;Integer, ValueHolder&gt;的形式保存，反之，以List<!-- raw HTML omitted -->的形式保存。</p>
<p>property解析:</p>
<p>非常常用的标签，用以为bean的属性赋值，支持value和ref两种形式，示例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.SimpleBean&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;name&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;skywalker&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div><p>value和ref属性不能同时出现，如果是ref，那么将其值保存在不可变的RuntimeBeanReference对象中，其实现了BeanReference接口，此接口只有一个getBeanName方法。如果是value，那么将其值保存在TypedStringValue对象中。最终将对象保存在BeanDefinition内部一个MutablePropertyValues对象中(内部以ArrayList实现)。</p>
<p>qualifier解析:</p>
<p>配置示例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.Student&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;name&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;skywalker&#34;</span><span style="color:#f92672">&gt;&lt;/property&gt;</span>
    <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;age&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;12&#34;</span><span style="color:#f92672">&gt;&lt;/property&gt;</span>
    <span style="color:#f92672">&lt;qualifier</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;org.springframework.beans.factory.annotation.Qualifier&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;student&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>	
<span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.Student&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;name&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;seaswalker&#34;</span><span style="color:#f92672">&gt;&lt;/property&gt;</span>
    <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;age&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;15&#34;</span><span style="color:#f92672">&gt;&lt;/property&gt;</span>
    <span style="color:#f92672">&lt;qualifier</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;student_2&#34;</span><span style="color:#f92672">&gt;&lt;/qualifier&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
<span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.SimpleBean&#34;</span> <span style="color:#f92672">/&gt;</span>
</code></pre></div><p>SimpleBean部分源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Autowired</span>
<span style="color:#a6e22e">@Qualifier</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;student&#34;</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">private</span> Student student<span style="color:#f92672">;</span>
</code></pre></div><p>此标签和@Qualifier, @Autowired两个注解一起使用才有作用。@Autowired注解采用按类型查找的方式进行注入，如果找到多个需要类型的bean便会报错，有了@Qualifier标签就可以再按照此注解指定的名称查找。两者结合相当于实现了按类型+名称注入。type属性可以不指定，因为默认就是那个。qualifier标签可以有attribute子元素，比如:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;qualifier</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;org.springframework.beans.factory.annotation.Qualifier&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;student&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;attribute</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/qualifier&gt;</span>
</code></pre></div><p>貌似是用来在qualifier也区分不开的时候使用。attribute键值对保存在BeanMetadataAttribute对象中。整个qualifier保存在AutowireCandidateQualifier对象中。</p>
<h6 id="bean装饰">Bean装饰</h6>
<p>这部分是针对其它schema的属性以及子节点，比如:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.Student&#34;</span> <span style="color:#a6e22e">primary=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;context:property-override</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div><p>没见过这种用法，留个坑。</p>
<h6 id="bean注册">Bean注册</h6>
<p>BeanDefinitionReaderUtils.registerBeanDefinition:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerBeanDefinition</span><span style="color:#f92672">(</span>
    BeanDefinitionHolder definitionHolder<span style="color:#f92672">,</span> BeanDefinitionRegistry registry<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// Register bean definition under primary name.
</span><span style="color:#75715e"></span>    String beanName <span style="color:#f92672">=</span> definitionHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanName</span><span style="color:#f92672">();</span>
    registry<span style="color:#f92672">.</span><span style="color:#a6e22e">registerBeanDefinition</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> definitionHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanDefinition</span><span style="color:#f92672">());</span>
    <span style="color:#75715e">// Register aliases for bean name, if any.
</span><span style="color:#75715e"></span>    String<span style="color:#f92672">[]</span> aliases <span style="color:#f92672">=</span> definitionHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getAliases</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>aliases <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String alias <span style="color:#f92672">:</span> aliases<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            registry<span style="color:#f92672">.</span><span style="color:#a6e22e">registerAlias</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> alias<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>registry其实就是DefaultListableBeanFactory对象，registerBeanDefinition方法主要就干了这么两件事:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerBeanDefinition</span><span style="color:#f92672">(</span>String beanName<span style="color:#f92672">,</span> BeanDefinition beanDefinition<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanDefinitionMap</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> beanDefinition<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanDefinitionNames</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>一个是Map，另一个是List，一目了然。registerAlias方法的实现在其父类SimpleAliasRegistry，就是把键值对放在了一个ConcurrentHashMap里。</p>
<p>ComponentRegistered事件触发:</p>
<p>默认是个空实现，前面说过了。</p>
<h6 id="beandefiniton数据结构">BeanDefiniton数据结构</h6>
<p>BeanDefiniton数据结构如下图:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/BeanDefinition.jpg" alt="BeanDefinition数据结构"></p>
<h5 id="beans">beans</h5>
<p>beans元素的嵌套直接递归调用DefaultBeanDefinitionDocumentReader.parseBeanDefinitions。</p>
<h4 id="其它命名空间解析">其它命名空间解析</h4>
<p>入口在DefaultBeanDefinitionDocumentReader.parseBeanDefinitions-&gt;BeanDefinitionParserDelegate.parseCustomElement(第二个参数为空):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> BeanDefinition <span style="color:#a6e22e">parseCustomElement</span><span style="color:#f92672">(</span>Element ele<span style="color:#f92672">,</span> BeanDefinition containingBd<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String namespaceUri <span style="color:#f92672">=</span> getNamespaceURI<span style="color:#f92672">(</span>ele<span style="color:#f92672">);</span>
    NamespaceHandler handler <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">readerContext</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getNamespaceHandlerResolver</span><span style="color:#f92672">().</span><span style="color:#a6e22e">resolve</span><span style="color:#f92672">(</span>namespaceUri<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> handler<span style="color:#f92672">.</span><span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>ele<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ParserContext<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">readerContext</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> containingBd<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>NamespaceHandlerResolver由XmlBeanDefinitionReader初始化，是一个DefaultNamespaceHandlerResolver对象，也是NamespaceHandlerResolver接口的唯一实现。</p>
<p>其resolve方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> NamespaceHandler <span style="color:#a6e22e">resolve</span><span style="color:#f92672">(</span>String namespaceUri<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> handlerMappings <span style="color:#f92672">=</span> getHandlerMappings<span style="color:#f92672">();</span>
    Object handlerOrClassName <span style="color:#f92672">=</span> handlerMappings<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>namespaceUri<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>handlerOrClassName <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>handlerOrClassName <span style="color:#66d9ef">instanceof</span> NamespaceHandler<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>NamespaceHandler<span style="color:#f92672">)</span> handlerOrClassName<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        String className <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>String<span style="color:#f92672">)</span> handlerOrClassName<span style="color:#f92672">;</span>
        Class<span style="color:#f92672">&lt;?&gt;</span> handlerClass <span style="color:#f92672">=</span> ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span>className<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">classLoader</span><span style="color:#f92672">);</span>
        NamespaceHandler namespaceHandler <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>NamespaceHandler<span style="color:#f92672">)</span> BeanUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">instantiateClass</span><span style="color:#f92672">(</span>handlerClass<span style="color:#f92672">);</span>
        namespaceHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">init</span><span style="color:#f92672">();</span>
        handlerMappings<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>namespaceUri<span style="color:#f92672">,</span> namespaceHandler<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> namespaceHandler<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>容易看出，Spring其实使用了一个Map了保存其映射关系，key就是命名空间的uri，value是<strong>NamespaceHandler对象或是Class完整名，如果发现是类名，那么用反射的方法进行初始化，如果是NamespaceHandler对象，那么直接返回</strong>。</p>
<p>NamespaceHandler映射关系来自于各个Spring jar包下的META-INF/spring.handlers文件，以spring-context包为例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">http\://www.springframework.org/schema/context=org.springframework.context.config.ContextNamespaceHandler
http\://www.springframework.org/schema/jee=org.springframework.ejb.config.JeeNamespaceHandler
http\://www.springframework.org/schema/lang=org.springframework.scripting.config.LangNamespaceHandler
http\://www.springframework.org/schema/task=org.springframework.scheduling.config.TaskNamespaceHandler
http\://www.springframework.org/schema/cache=org.springframework.cache.config.CacheNamespaceHandler
</code></pre></div><h5 id="namespacehandler继承体系">NamespaceHandler继承体系</h5>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/NamespaceHandler.jpg" alt="NamespaceHandler继承体系"></p>
<h5 id="init">init</h5>
<p>resolve中调用了其init方法，此方法用以向NamespaceHandler对象注册BeanDefinitionParser对象。<strong>此接口用以解析顶层(beans下)的非默认命名空间元素，比如<code>&lt;context:annotation-config /&gt;</code></strong>。</p>
<p>所以这样逻辑就很容易理解了: <strong>每种子标签的解析仍是策略模式的体现，init负责向父类NamespaceHandlerSupport注册不同的策略，由父类的NamespaceHandlerSupport.parse方法根据具体的子标签调用相应的策略完成解析的过程</strong>。</p>
<p>此部分较为重要，所以重新开始大纲。</p>
<h5 id="beanfactory数据结构">BeanFactory数据结构</h5>
<p>BeanDefinition在BeanFactory中的主要数据结构如下图:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Beanfactory_structure.jpg" alt="Beanfactory数据结构"></p>
<h3 id="preparebeanfactory">prepareBeanFactory</h3>
<p>此方法负责对BeanFactory进行一些特征的设置工作，&ldquo;特征&quot;包含这么几个方面:</p>
<h4 id="beanexpressionresolver">BeanExpressionResolver</h4>
<p>此接口只有一个实现: StandardBeanExpressionResolver。接口只含有一个方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Object <span style="color:#a6e22e">evaluate</span><span style="color:#f92672">(</span>String value<span style="color:#f92672">,</span> BeanExpressionContext evalContext<span style="color:#f92672">)</span>
</code></pre></div><p>prepareBeanFactory将一个此对象放入BeanFactory:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">setBeanExpressionResolver</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> 						 			StandardBeanExpressionResolver<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanClassLoader</span><span style="color:#f92672">()));</span>
</code></pre></div><p>StandardBeanExpressionResolver对象内部有一个关键的成员: SpelExpressionParser,其整个类图:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ExpressionParser.jpg" alt="ExpressionParser继承体系"></p>
<p>这便是Spring3.0开始出现的Spel表达式的解释器。</p>
<h4 id="propertyeditorregistrar">PropertyEditorRegistrar</h4>
<p>此接口用于向Spring注册java.beans.PropertyEditor，只有一个方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">registerCustomEditors<span style="color:#f92672">(</span>PropertyEditorRegistry registry<span style="color:#f92672">)</span>
</code></pre></div><p>实现也只有一个: ResourceEditorRegistrar。</p>
<p>在编写xml配置时，我们设置的值都是字符串形式，所以在使用时肯定需要转为我们需要的类型，PropertyEditor接口正是定义了这么个东西。</p>
<p>prepareBeanFactory:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">addPropertyEditorRegistrar</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ResourceEditorRegistrar<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> getEnvironment<span style="color:#f92672">()));</span>
</code></pre></div><p>BeanFactory也暴露了registerCustomEditors方法用以添加自定义的转换器，所以这个地方是组合模式的体现。</p>
<p>我们有两种方式可以添加自定义PropertyEditor:</p>
<ul>
<li>
<p>通过<code>context.getBeanFactory().registerCustomEditor</code></p>
</li>
<li>
<p>通过Spring配置文件:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;org.springframework.beans.factory.config.CustomEditorConfigurer&#34;</span><span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;customEditors&#34;</span><span style="color:#f92672">&gt;</span>
          <span style="color:#f92672">&lt;map&gt;</span>
              <span style="color:#f92672">&lt;entry</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;base.Cat&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;base.CatEditor&#34;</span> <span style="color:#f92672">/&gt;</span> 
      <span style="color:#f92672">&lt;/map&gt;</span>
  <span style="color:#f92672">&lt;/property&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div></li>
</ul>
<p>参考: <a href="http://blog.csdn.net/zhoudaxia/article/details/36247883">深入理解JavaBean(2)：属性编辑器PropertyEditor</a></p>
<h4 id="环境注入">环境注入</h4>
<p>在Spring中我们自己的bean可以通过实现EnvironmentAware等一系列Aware接口获取到Spring内部的一些对象。prepareBeanFactory:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">addBeanPostProcessor</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ApplicationContextAwareProcessor<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">));</span>
</code></pre></div><p>ApplicationContextAwareProcessor核心的invokeAwareInterfaces方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invokeAwareInterfaces</span><span style="color:#f92672">(</span>Object bean<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#66d9ef">instanceof</span> Aware<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#66d9ef">instanceof</span> EnvironmentAware<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#f92672">((</span>EnvironmentAware<span style="color:#f92672">)</span> bean<span style="color:#f92672">).</span><span style="color:#a6e22e">setEnvironment</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationContext</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getEnvironment</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#66d9ef">instanceof</span> EmbeddedValueResolverAware<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#f92672">((</span>EmbeddedValueResolverAware<span style="color:#f92672">)</span> bean<span style="color:#f92672">).</span><span style="color:#a6e22e">setEmbeddedValueResolver</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">embeddedValueResolver</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">//....
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="依赖解析忽略">依赖解析忽略</h4>
<p>此部分设置哪些接口在进行依赖注入的时候应该被忽略:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">ignoreDependencyInterface</span><span style="color:#f92672">(</span>ResourceLoaderAware<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">ignoreDependencyInterface</span><span style="color:#f92672">(</span>ApplicationEventPublisherAware<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">ignoreDependencyInterface</span><span style="color:#f92672">(</span>MessageSourceAware<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">ignoreDependencyInterface</span><span style="color:#f92672">(</span>ApplicationContextAware<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">ignoreDependencyInterface</span><span style="color:#f92672">(</span>EnvironmentAware<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</code></pre></div><h4 id="bean伪装">bean伪装</h4>
<p>有些对象并不在BeanFactory中，但是我们依然想让它们可以被装配，这就需要伪装一下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">registerResolvableDependency</span><span style="color:#f92672">(</span>BeanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> beanFactory<span style="color:#f92672">);</span>
beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">registerResolvableDependency</span><span style="color:#f92672">(</span>ResourceLoader<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">registerResolvableDependency</span><span style="color:#f92672">(</span>ApplicationEventPublisher<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">registerResolvableDependency</span><span style="color:#f92672">(</span>ApplicationContext<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
</code></pre></div><p>伪装关系保存在一个Map&lt;Class&lt;?&gt;, Object&gt;里。</p>
<h4 id="loadtimeweaver">LoadTimeWeaver</h4>
<p>如果配置了此bean，那么：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">containsBean</span><span style="color:#f92672">(</span>LOAD_TIME_WEAVER_BEAN_NAME<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">addBeanPostProcessor</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> LoadTimeWeaverAwareProcessor<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">));</span>
    <span style="color:#75715e">// Set a temporary ClassLoader for type matching.
</span><span style="color:#75715e"></span>    beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">setTempClassLoader</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ContextTypeMatchClassLoader<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanClassLoader</span><span style="color:#f92672">()));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这个东西具体是干什么的在后面context:load-time-weaver中说明。</p>
<h4 id="注册环境">注册环境</h4>
<p>源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">containsLocalBean</span><span style="color:#f92672">(</span>ENVIRONMENT_BEAN_NAME<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">registerSingleton</span><span style="color:#f92672">(</span>ENVIRONMENT_BEAN_NAME<span style="color:#f92672">,</span> getEnvironment<span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">containsLocalBean</span><span style="color:#f92672">(</span>SYSTEM_PROPERTIES_BEAN_NAME<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">registerSingleton</span><span style="color:#f92672">(</span>SYSTEM_PROPERTIES_BEAN_NAME<span style="color:#f92672">,</span> getEnvironment<span style="color:#f92672">().</span><span style="color:#a6e22e">getSystemProperties</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">containsLocalBean</span><span style="color:#f92672">(</span>SYSTEM_ENVIRONMENT_BEAN_NAME<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">registerSingleton</span><span style="color:#f92672">(</span>SYSTEM_ENVIRONMENT_BEAN_NAME<span style="color:#f92672">,</span> getEnvironment<span style="color:#f92672">().</span>
        getSystemEnvironment<span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>containsLocalBean特殊之处在于不会去父BeanFactory寻找。</p>
<h3 id="postprocessbeanfactory">postProcessBeanFactory</h3>
<p>此方法允许子类在所有的bean尚未初始化之前注册BeanPostProcessor。空实现且没有子类覆盖。</p>
<h3 id="invokebeanfactorypostprocessors">invokeBeanFactoryPostProcessors</h3>
<p>BeanFactoryPostProcessor接口允许我们在bean正是初始化之前改变其值。此接口只有一个方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">postProcessBeanFactory</span><span style="color:#f92672">(</span>ConfigurableListableBeanFactory beanFactory<span style="color:#f92672">);</span>
</code></pre></div><p>有两种方式可以向Spring添加此对象:</p>
<ul>
<li>
<p>通过代码的方式:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">context<span style="color:#f92672">.</span><span style="color:#a6e22e">addBeanFactoryPostProcessor</span>
</code></pre></div></li>
<li>
<p>通过xml配置的方式:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.SimpleBeanFactoryPostProcessor&#34;</span> <span style="color:#f92672">/&gt;</span>
</code></pre></div></li>
</ul>
<p>注意此时尚未进行bean的初始化工作，初始化是在后面的finishBeanFactoryInitialization进行的，所以在BeanFactoryPostProcessor对象中获取bean会导致提前初始化。</p>
<p>此方法的关键源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invokeBeanFactoryPostProcessors</span><span style="color:#f92672">(</span>ConfigurableListableBeanFactory beanFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    PostProcessorRegistrationDelegate<span style="color:#f92672">.</span><span style="color:#a6e22e">invokeBeanFactoryPostProcessors</span><span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">,</span>
        getBeanFactoryPostProcessors<span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>getBeanFactoryPostProcessors获取的就是AbstractApplicationContext的成员beanFactoryPostProcessors(ArrayList)，但是很有意思，<strong>只有通过context.addBeanFactoryPostProcessor这种方式添加的才会出现在这个List里，所以对于xml配置方式，此List其实没有任何元素。玄机就在PostProcessorRegistrationDelegate里</strong>。</p>
<p>核心思想就是使用BeanFactory的getBeanNamesForType方法获取相应的BeanDefinition的name数组，之后逐一调用getBean方法获取到bean(初始化)，getBean方法后面再说。</p>
<p>注意此处有一个优先级的概念，如果你的BeanFactoryPostProcessor同时实现了Ordered或者是PriorityOrdered接口，那么会被首先执行。</p>
<h3 id="beanpostprocessor注册">BeanPostProcessor注册</h3>
<p>此部分实质上是在BeanDefinitions中寻找BeanPostProcessor，之后调用BeanFactory.addBeanPostProcessor方法保存在一个List中，注意添加时仍然有优先级的概念，优先级高的在前面。</p>
<h3 id="messagesource">MessageSource</h3>
<p>此接口用以支持Spring国际化。继承体系如下:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/MessageSource.jpg" alt="MessageSource继承体系"></p>
<p>AbstractApplicationContext的initMessageSource()方法就是在BeanFactory中查找MessageSource的bean，如果配置了此bean，那么调用getBean方法完成其初始化并将其保存在AbstractApplicationContext内部messageSource成员变量中，用以处理ApplicationContext的getMessage调用，因为从继承体系上来看，ApplicationContext是MessageSource的子类，此处是委托模式的体现。如果没有配置此bean，那么初始化一个DelegatingMessageSource对象，此类是一个空实现，同样用以处理getMessage调用请求。</p>
<p>参考: <a href="http://stamen.iteye.com/blog/1541732">学习Spring必学的Java基础知识(8)&mdash;-国际化信息</a></p>
<h3 id="事件驱动">事件驱动</h3>
<p>此接口代表了Spring的事件驱动(监听器)模式。一个事件驱动包含三部分:</p>
<h4 id="事件">事件</h4>
<p>java的所有事件对象一般都是java.util.EventObject的子类，Spring的整个继承体系如下:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/EventObject.jpg" alt="EventObject继承体系"></p>
<h4 id="发布者">发布者</h4>
<h5 id="applicationeventpublisher">ApplicationEventPublisher</h5>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ApplicationEventPublisher.jpg" alt="ApplicationEventPublisher继承体系"></p>
<p>一目了然。</p>
<h5 id="applicationeventmulticaster">ApplicationEventMulticaster</h5>
<p>ApplicationEventPublisher实际上正是将请求委托给ApplicationEventMulticaster来实现的。其继承体系:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ApplicationEventMulticaster.jpg" alt="ApplicationEventMulticaster继承体系"></p>
<h4 id="监听器">监听器</h4>
<p>所有的监听器是jdk EventListener的子类，这是一个mark接口。继承体系:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/EventListener.jpg" alt="EventListener继承体系"></p>
<p>可以看出SmartApplicationListener和GenericApplicationListener是高度相似的，都提供了事件类型检测和顺序机制，而后者是从Spring4.2加入的，Spring官方文档推荐使用后者代替前者。</p>
<h4 id="初始化">初始化</h4>
<p>前面说过ApplicationEventPublisher是通过委托给ApplicationEventMulticaster实现的，所以refresh方法中完成的是对ApplicationEventMulticaster的初始化:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// Initialize event multicaster for this context.
</span><span style="color:#75715e"></span>initApplicationEventMulticaster<span style="color:#f92672">();</span>
</code></pre></div><p>initApplicationEventMulticaster则首先在BeanFactory中寻找ApplicationEventMulticaster的bean，如果找到，那么调用getBean方法将其初始化，如果找不到那么使用SimpleApplicationEventMulticaster。</p>
<h4 id="事件发布">事件发布</h4>
<p>AbstractApplicationContext.publishEvent核心代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">publishEvent</span><span style="color:#f92672">(</span>Object event<span style="color:#f92672">,</span> ResolvableType eventType<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    getApplicationEventMulticaster<span style="color:#f92672">().</span><span style="color:#a6e22e">multicastEvent</span><span style="color:#f92672">(</span>applicationEvent<span style="color:#f92672">,</span> eventType<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>SimpleApplicationEventMulticaster.multicastEvent:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">multicastEvent</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ApplicationEvent event<span style="color:#f92672">,</span> ResolvableType eventType<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ResolvableType type <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>eventType <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> eventType <span style="color:#f92672">:</span> resolveDefaultEventType<span style="color:#f92672">(</span>event<span style="color:#f92672">));</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ApplicationListener<span style="color:#f92672">&lt;?&gt;</span> listener <span style="color:#f92672">:</span> getApplicationListeners<span style="color:#f92672">(</span>event<span style="color:#f92672">,</span> type<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        Executor executor <span style="color:#f92672">=</span> getTaskExecutor<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>executor <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            executor<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    invokeListener<span style="color:#f92672">(</span>listener<span style="color:#f92672">,</span> event<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">});</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            invokeListener<span style="color:#f92672">(</span>listener<span style="color:#f92672">,</span> event<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="监听器获取">监听器获取</h5>
<p>获取当然还是通过beanFactory的getBean来完成的，值得注意的是Spring在此处使用了缓存(ConcurrentHashMap)来加速查找的过程。</p>
<h5 id="同步异步">同步/异步</h5>
<p>可以看出，如果executor不为空，那么监听器的执行实际上是异步的。那么如何配置同步/异步呢?</p>
<h6 id="全局">全局</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;task:executor</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;multicasterExecutor&#34;</span> <span style="color:#a6e22e">pool-size=</span><span style="color:#e6db74">&#34;3&#34;</span><span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;org.springframework.context.event.SimpleApplicationEventMulticaster&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;taskExecutor&#34;</span> <span style="color:#a6e22e">ref=</span><span style="color:#e6db74">&#34;multicasterExecutor&#34;</span><span style="color:#f92672">&gt;&lt;/property&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div><p>task schema是Spring从3.0开始加入的，使我们可以不再依赖于Quartz实现定时任务，源码在org.springframework.core.task包下，使用需要引入schema：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">xmlns:task=&#34;http://www.springframework.org/schema/task&#34;
xsi:schemaLocation=&#34;http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task-4.0.xsd&#34;
</code></pre></div><p>可以参考: <a href="http://gong1208.iteye.com/blog/1773177">Spring定时任务的几种实现</a></p>
<h6 id="注解">注解</h6>
<p>开启注解支持:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;!-- 开启@AspectJ AOP代理 --&gt;</span>  
<span style="color:#f92672">&lt;aop:aspectj-autoproxy</span> <span style="color:#a6e22e">proxy-target-class=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">/&gt;</span>  
<span style="color:#75715e">&lt;!-- 任务调度器 --&gt;</span>  
<span style="color:#f92672">&lt;task:scheduler</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;scheduler&#34;</span> <span style="color:#a6e22e">pool-size=</span><span style="color:#e6db74">&#34;10&#34;</span><span style="color:#f92672">/&gt;</span>  
<span style="color:#75715e">&lt;!-- 任务执行器 --&gt;</span>  
<span style="color:#f92672">&lt;task:executor</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;executor&#34;</span> <span style="color:#a6e22e">pool-size=</span><span style="color:#e6db74">&#34;10&#34;</span><span style="color:#f92672">/&gt;</span>  
<span style="color:#75715e">&lt;!--开启注解调度支持 @Async @Scheduled--&gt;</span>  
<span style="color:#f92672">&lt;task:annotation-driven</span> <span style="color:#a6e22e">executor=</span><span style="color:#e6db74">&#34;executor&#34;</span> <span style="color:#a6e22e">scheduler=</span><span style="color:#e6db74">&#34;scheduler&#34;</span> <span style="color:#a6e22e">proxy-target-class=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">/&gt;</span>  
</code></pre></div><p>在代码中使用示例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Component</span>  
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EmailRegisterListener</span> <span style="color:#66d9ef">implements</span> ApplicationListener<span style="color:#f92672">&lt;</span>RegisterEvent<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>  
    <span style="color:#a6e22e">@Async</span>  
    <span style="color:#a6e22e">@Override</span>  
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onApplicationEvent</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> RegisterEvent event<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;注册成功，发送确认邮件给：&#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">((</span>User<span style="color:#f92672">)</span>event<span style="color:#f92672">.</span><span style="color:#a6e22e">getSource</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">getUsername</span><span style="color:#f92672">());</span>  
    <span style="color:#f92672">}</span>  
<span style="color:#f92672">}</span>  
</code></pre></div><p>参考: <a href="http://jinnianshilongnian.iteye.com/blog/1902886">详解Spring事件驱动模型</a></p>
<h3 id="onrefresh">onRefresh</h3>
<p>这又是一个模版方法，允许子类在进行bean初始化之前进行一些定制操作。默认空实现。</p>
<h3 id="applicationlistener注册">ApplicationListener注册</h3>
<p>registerListeners方法干的，没什么好说的。</p>
<h3 id="singleton初始化">singleton初始化</h3>
<p>finishBeanFactoryInitialization：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">finishBeanFactoryInitialization</span><span style="color:#f92672">(</span>ConfigurableListableBeanFactory beanFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">containsBean</span><span style="color:#f92672">(</span>CONVERSION_SERVICE_BEAN_NAME<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
            beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">isTypeMatch</span><span style="color:#f92672">(</span>CONVERSION_SERVICE_BEAN_NAME<span style="color:#f92672">,</span> ConversionService<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">setConversionService</span><span style="color:#f92672">(</span>
                beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>CONVERSION_SERVICE_BEAN_NAME<span style="color:#f92672">,</span> ConversionService<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">hasEmbeddedValueResolver</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">addEmbeddedValueResolver</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> StringValueResolver<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">resolveStringValue</span><span style="color:#f92672">(</span>String strVal<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> getEnvironment<span style="color:#f92672">().</span><span style="color:#a6e22e">resolvePlaceholders</span><span style="color:#f92672">(</span>strVal<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">});</span>
    <span style="color:#f92672">}</span>
    String<span style="color:#f92672">[]</span> weaverAwareNames <span style="color:#f92672">=</span> beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanNamesForType</span>
        <span style="color:#f92672">(</span>LoadTimeWeaverAware<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String weaverAwareName <span style="color:#f92672">:</span> weaverAwareNames<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        getBean<span style="color:#f92672">(</span>weaverAwareName<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// Allow for caching all bean definition metadata, not expecting further changes.
</span><span style="color:#75715e"></span>    beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">freezeConfiguration</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// Instantiate all remaining (non-lazy-init) singletons.
</span><span style="color:#75715e"></span>    beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">preInstantiateSingletons</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>分部分说明。</p>
<h4 id="conversionservice">ConversionService</h4>
<p>此接口用于类型之间的转换，在Spring里其实就是把配置文件中的String转为其它类型，从3.0开始出现，目的和jdk的PropertyEditor接口是一样的，参考ConfigurableBeanFactory.setConversionService注释:</p>
<blockquote>
<blockquote>
<p>Specify a Spring 3.0 ConversionService to use for converting
property values, as an alternative to JavaBeans PropertyEditors.
@since 3.0</p>
</blockquote>
</blockquote>
<h4 id="stringvalueresolver">StringValueResolver</h4>
<p>用于解析注解的值。接口只定义了一个方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">String <span style="color:#a6e22e">resolveStringValue</span><span style="color:#f92672">(</span>String strVal<span style="color:#f92672">);</span>
</code></pre></div><h4 id="loadtimeweaveraware">LoadTimeWeaverAware</h4>
<p>实现了此接口的bean可以得到LoadTimeWeaver，此处仅仅初始化。</p>
<h4 id="初始化-1">初始化</h4>
<p>DefaultListableBeanFactory.preInstantiateSingletons:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">preInstantiateSingletons</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> BeansException <span style="color:#f92672">{</span>
    List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> beanNames <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanDefinitionNames</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String beanName <span style="color:#f92672">:</span> beanNames<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        RootBeanDefinition bd <span style="color:#f92672">=</span> getMergedLocalBeanDefinition<span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>bd<span style="color:#f92672">.</span><span style="color:#a6e22e">isAbstract</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> bd<span style="color:#f92672">.</span><span style="color:#a6e22e">isSingleton</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>bd<span style="color:#f92672">.</span><span style="color:#a6e22e">isLazyInit</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isFactoryBean<span style="color:#f92672">(</span>beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> FactoryBean<span style="color:#f92672">&lt;?&gt;</span> factory <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>FactoryBean<span style="color:#f92672">&lt;?&gt;)</span> getBean<span style="color:#f92672">(</span>FACTORY_BEAN_PREFIX 
                    <span style="color:#f92672">+</span> beanName<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">boolean</span> isEagerInit<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecurityManager</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> factory <span style="color:#66d9ef">instanceof</span> SmartFactoryBean<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    isEagerInit <span style="color:#f92672">=</span> AccessController<span style="color:#f92672">.</span><span style="color:#a6e22e">doPrivileged</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PrivilegedAction<span style="color:#f92672">&lt;</span>Boolean<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
                        <span style="color:#a6e22e">@Override</span>
                        <span style="color:#66d9ef">public</span> Boolean <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">return</span> <span style="color:#f92672">((</span>SmartFactoryBean<span style="color:#f92672">&lt;?&gt;)</span> factory<span style="color:#f92672">).</span><span style="color:#a6e22e">isEagerInit</span><span style="color:#f92672">();</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">},</span> getAccessControlContext<span style="color:#f92672">());</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    isEagerInit <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>factory <span style="color:#66d9ef">instanceof</span> SmartFactoryBean <span style="color:#f92672">&amp;&amp;</span>
                            <span style="color:#f92672">((</span>SmartFactoryBean<span style="color:#f92672">&lt;?&gt;)</span> factory<span style="color:#f92672">).</span><span style="color:#a6e22e">isEagerInit</span><span style="color:#f92672">());</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isEagerInit<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    getBean<span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                getBean<span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// Trigger post-initialization callback for all applicable beans...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String beanName <span style="color:#f92672">:</span> beanNames<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Object singletonInstance <span style="color:#f92672">=</span> getSingleton<span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>singletonInstance <span style="color:#66d9ef">instanceof</span> SmartInitializingSingleton<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> SmartInitializingSingleton smartSingleton <span style="color:#f92672">=</span> 
                <span style="color:#f92672">(</span>SmartInitializingSingleton<span style="color:#f92672">)</span> singletonInstance<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecurityManager</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                AccessController<span style="color:#f92672">.</span><span style="color:#a6e22e">doPrivileged</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PrivilegedAction<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
                    <span style="color:#a6e22e">@Override</span>
                    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                        smartSingleton<span style="color:#f92672">.</span><span style="color:#a6e22e">afterSingletonsInstantiated</span><span style="color:#f92672">();</span>
                        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">},</span> getAccessControlContext<span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                smartSingleton<span style="color:#f92672">.</span><span style="color:#a6e22e">afterSingletonsInstantiated</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>首先进行Singleton的初始化，其中如果bean是FactoryBean类型(注意，只定义了factory-method属性的普通bean并不是FactoryBean)，并且还是SmartFactoryBean类型，那么需要判断是否需要eagerInit(isEagerInit是此接口定义的方法)。</p>
<h1 id="getbean">getBean</h1>
<p>这里便是bean初始化的核心逻辑。源码比较复杂，分开说。以getBean(String name)为例。AbstractBeanFactory.getBean:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> BeansException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> doGetBean<span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>第二个参数表示bean的Class类型，第三个表示创建bean需要的参数，最后一个表示不需要进行类型检查。</p>
<h2 id="beanname转化">beanName转化</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">final</span> String beanName <span style="color:#f92672">=</span> transformedBeanName<span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
</code></pre></div><p>这里是将FactoryBean的前缀去掉以及将别名转为真实的名字。</p>
<h2 id="手动注册bean检测">手动注册bean检测</h2>
<p>前面注册环境一节说过，Spring其实手动注册了一些单例bean。这一步就是检测是不是这些bean。如果是，那么再检测是不是工厂bean，如果是返回其工厂方法返回的实例，如果不是返回bean本身。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Object sharedInstance <span style="color:#f92672">=</span> getSingleton<span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sharedInstance <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> args <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    bean <span style="color:#f92672">=</span> getObjectForBeanInstance<span style="color:#f92672">(</span>sharedInstance<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="检查父容器">检查父容器</h2>
<p>如果父容器存在并且存在此bean定义，那么交由其父容器初始化:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">BeanFactory parentBeanFactory <span style="color:#f92672">=</span> getParentBeanFactory<span style="color:#f92672">();</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>parentBeanFactory <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>containsBeanDefinition<span style="color:#f92672">(</span>beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// Not found -&gt; check parent.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//此方法其实是做了前面beanName转化的逆操作，因为父容器同样会进行转化操作
</span><span style="color:#75715e"></span>    String nameToLookup <span style="color:#f92672">=</span> originalBeanName<span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>args <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Delegation to parent with explicit args.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>T<span style="color:#f92672">)</span> parentBeanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>nameToLookup<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// No args -&gt; delegate to standard getBean method.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> parentBeanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>nameToLookup<span style="color:#f92672">,</span> requiredType<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="依赖初始化">依赖初始化</h2>
<p>bean可以由depends-on属性配置依赖的bean。Spring会首先初始化依赖的bean。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">String<span style="color:#f92672">[]</span> dependsOn <span style="color:#f92672">=</span> mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getDependsOn</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dependsOn <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String dependsOnBean <span style="color:#f92672">:</span> dependsOn<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
         <span style="color:#75715e">//检测是否存在循环依赖
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isDependent<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> dependsOnBean<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BeanCreationException<span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getResourceDescription</span><span style="color:#f92672">(),</span> beanName<span style="color:#f92672">,</span>
            <span style="color:#e6db74">&#34;Circular depends-on relationship between &#39;&#34;</span> <span style="color:#f92672">+</span> beanName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39; and &#39;&#34;</span> <span style="color:#f92672">+</span> dependsOnBean <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        registerDependentBean<span style="color:#f92672">(</span>dependsOnBean<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
        getBean<span style="color:#f92672">(</span>dependsOnBean<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>registerDependentBean进行了依赖关系的注册，这么做的原因是Spring在即进行bean销毁的时候会首先销毁被依赖的bean。依赖关系的保存是通过一个ConcurrentHashMap&lt;String, Set<!-- raw HTML omitted -->&gt;完成的，key是bean的真实名字。</p>
<h2 id="singleton初始化-1">Singleton初始化</h2>
<p>虽然这里大纲是Singleton初始化，但是getBean方法本身是包括所有scope的初始化，在这里一次说明了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">isSingleton</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    sharedInstance <span style="color:#f92672">=</span> getSingleton<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ObjectFactory<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">getObject</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> BeansException <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> createBean<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
    bean <span style="color:#f92672">=</span> getObjectForBeanInstance<span style="color:#f92672">(</span>sharedInstance<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="getsingleton方法">getSingleton方法</h3>
<h4 id="是否存在">是否存在</h4>
<p>首先会检测是否已经存在，如果存在，直接返回:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">singletonObjects</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Object singletonObject <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">singletonObjects</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>所有的单例bean都保存在这样的数据结构中: <code>ConcurrentHashMap&lt;String, Object&gt;</code>。</p>
<h4 id="bean创建">bean创建</h4>
<p>源码位于AbstractAutowireCapableBeanFactory.createBean，主要分为几个部分:</p>
<h5 id="lookup-method检测">lookup-method检测</h5>
<p>此部分用于检测lookup-method标签配置的方法是否存在:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">RootBeanDefinition mbdToUse <span style="color:#f92672">=</span> mbd<span style="color:#f92672">;</span>
mbdToUse<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareMethodOverrides</span><span style="color:#f92672">();</span>
</code></pre></div><p>prepareMethodOverrides:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">prepareMethodOverrides</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> BeanDefinitionValidationException <span style="color:#f92672">{</span>
    <span style="color:#75715e">// Check that lookup methods exists.
</span><span style="color:#75715e"></span>    MethodOverrides methodOverrides <span style="color:#f92672">=</span> getMethodOverrides<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>methodOverrides<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        Set<span style="color:#f92672">&lt;</span>MethodOverride<span style="color:#f92672">&gt;</span> overrides <span style="color:#f92672">=</span> methodOverrides<span style="color:#f92672">.</span><span style="color:#a6e22e">getOverrides</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>overrides<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>MethodOverride mo <span style="color:#f92672">:</span> overrides<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                prepareMethodOverride<span style="color:#f92672">(</span>mo<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>prepareMethodOverride:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">prepareMethodOverride</span><span style="color:#f92672">(</span>MethodOverride mo<span style="color:#f92672">)</span>  <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getMethodCountForName</span><span style="color:#f92672">(</span>getBeanClass<span style="color:#f92672">(),</span> mo<span style="color:#f92672">.</span><span style="color:#a6e22e">getMethodName</span><span style="color:#f92672">());</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BeanDefinitionValidationException<span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;Invalid method override: no method with name &#39;&#34;</span> <span style="color:#f92672">+</span> mo<span style="color:#f92672">.</span><span style="color:#a6e22e">getMethodName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span>
                <span style="color:#e6db74">&#34;&#39; on class [&#34;</span> <span style="color:#f92672">+</span> getBeanClassName<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;]&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">==</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Mark override as not overloaded, to avoid the overhead of arg type checking.
</span><span style="color:#75715e"></span>        mo<span style="color:#f92672">.</span><span style="color:#a6e22e">setOverloaded</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="instantiationawarebeanpostprocessor触发">InstantiationAwareBeanPostProcessor触发</h5>
<p>在这里触发的是其postProcessBeforeInitialization和postProcessAfterInstantiation方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Object bean <span style="color:#f92672">=</span> resolveBeforeInstantiation<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbdToUse<span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
Object beanInstance <span style="color:#f92672">=</span> doCreateBean<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbdToUse<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
<span style="color:#66d9ef">return</span> beanInstance<span style="color:#f92672">;</span>
</code></pre></div><p>继续:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> Object <span style="color:#a6e22e">resolveBeforeInstantiation</span><span style="color:#f92672">(</span>String beanName<span style="color:#f92672">,</span> RootBeanDefinition mbd<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Object bean <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">FALSE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">beforeInstantiationResolved</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Make sure bean class is actually resolved at this point.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">isSynthetic</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> hasInstantiationAwareBeanPostProcessors<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            Class<span style="color:#f92672">&lt;?&gt;</span> targetType <span style="color:#f92672">=</span> determineTargetType<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>targetType <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                bean <span style="color:#f92672">=</span> applyBeanPostProcessorsBeforeInstantiation<span style="color:#f92672">(</span>targetType<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    bean <span style="color:#f92672">=</span> applyBeanPostProcessorsAfterInitialization<span style="color:#f92672">(</span>bean<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">beforeInstantiationResolved</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>bean <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>从这里可以看出，<strong>如果InstantiationAwareBeanPostProcessor返回的不是空，那么将不会继续执行剩下的Spring初始化流程，此接口用于初始化自定义的bean，主要是在Spring内部使用</strong>。</p>
<h5 id="docreatebean">doCreateBean</h5>
<p>同样分为几部分。</p>
<h6 id="创建createbeaninstance">创建(createBeanInstance)</h6>
<p>关键代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">BeanWrapper instanceWrapper <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>instanceWrapper <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    instanceWrapper <span style="color:#f92672">=</span> createBeanInstance<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>createBeanInstance的创建过程又分为以下几种情况:</p>
<ul>
<li>
<p>工厂bean:</p>
<p>调用instantiateUsingFactoryMethod方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> BeanWrapper <span style="color:#a6e22e">instantiateUsingFactoryMethod</span><span style="color:#f92672">(</span>
  String beanName<span style="color:#f92672">,</span> RootBeanDefinition mbd<span style="color:#f92672">,</span> Object<span style="color:#f92672">[]</span> explicitArgs<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ConstructorResolver<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">).</span><span style="color:#a6e22e">instantiateUsingFactoryMethod</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> explicitArgs<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>注意，此处的工厂bean指的是配置了factory-bean/factory-method属性的bean，不是实现了FacrotyBean接口的bean。如果没有配置factory-bean属性，那么factory-method指向的方法必须是静态的。此方法主要做了这么几件事:</p>
<ul>
<li>
<p>初始化一个BeanWrapperImpl对象。</p>
</li>
<li>
<p>根据设置的参数列表使用反射的方法寻找相应的方法对象。</p>
</li>
<li>
<p>InstantiationStrategy:</p>
<p>bean的初始化在此处又抽成了策略模式，类图:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/InstantiationStrategy.jpg" alt="InstantiationStrategy类图"></p>
<p>instantiateUsingFactoryMethod部分源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">beanInstance <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getInstantiationStrategy</span><span style="color:#f92672">().</span><span style="color:#a6e22e">instantiate</span><span style="color:#f92672">(</span>
    mbd<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">,</span> factoryBean<span style="color:#f92672">,</span> factoryMethodToUse<span style="color:#f92672">,</span> argsToUse<span style="color:#f92672">);</span>
</code></pre></div><p>getInstantiationStrategy返回的是CglibSubclassingInstantiationStrategy对象。此处instantiate实现也很简单，就是调用工厂方法的Method对象反射调用其invoke即可得到对象，SimpleInstantiationStrategy.</p>
<p>instantiate核心源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">instantiate</span><span style="color:#f92672">(</span>RootBeanDefinition bd<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">,</span> BeanFactory owner<span style="color:#f92672">,</span>
    Object factoryBean<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> Method factoryMethod<span style="color:#f92672">,</span> Object<span style="color:#f92672">...</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> factoryMethod<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>factoryBean<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>构造器自动装配</p>
<p>createBeanInstance部分源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// Need to determine the constructor...
</span><span style="color:#75715e"></span>Constructor<span style="color:#f92672">&lt;?&gt;[]</span> ctors <span style="color:#f92672">=</span> determineConstructorsFromBeanPostProcessors<span style="color:#f92672">(</span>beanClass<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ctors <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span>
  mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getResolvedAutowireMode</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> RootBeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">AUTOWIRE_CONSTRUCTOR</span> <span style="color:#f92672">||</span>
    <span style="color:#75715e">//配置了&lt;constructor-arg&gt;子元素
</span><span style="color:#75715e"></span>  mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">hasConstructorArgumentValues</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>ObjectUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>args<span style="color:#f92672">))</span>  <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">return</span> autowireConstructor<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> ctors<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>determineConstructorsFromBeanPostProcessors源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> Constructor<span style="color:#f92672">&lt;?&gt;[]</span> determineConstructorsFromBeanPostProcessors<span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> beanClass<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanClass <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> hasInstantiationAwareBeanPostProcessors<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>BeanPostProcessor bp <span style="color:#f92672">:</span> getBeanPostProcessors<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
          <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bp <span style="color:#66d9ef">instanceof</span> SmartInstantiationAwareBeanPostProcessor<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
              SmartInstantiationAwareBeanPostProcessor ibp <span style="color:#f92672">=</span> 
                  <span style="color:#f92672">(</span>SmartInstantiationAwareBeanPostProcessor<span style="color:#f92672">)</span> bp<span style="color:#f92672">;</span>
              Constructor<span style="color:#f92672">&lt;?&gt;[]</span> ctors <span style="color:#f92672">=</span> ibp<span style="color:#f92672">.</span><span style="color:#a6e22e">determineCandidateConstructors</span><span style="color:#f92672">(</span>beanClass<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
              <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ctors <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                  <span style="color:#66d9ef">return</span> ctors<span style="color:#f92672">;</span>
              <span style="color:#f92672">}</span>
          <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可见是由SmartInstantiationAwareBeanPostProcessor决定的，默认是没有配置这种东西的。</p>
<p>之后就是判断bean的自动装配模式，可以通过如下方式配置:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;student&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.Student&#34;</span> <span style="color:#a6e22e">primary=</span><span style="color:#e6db74">&#34;true&#34;</span> <span style="color:#a6e22e">autowire=</span><span style="color:#e6db74">&#34;default&#34;</span> <span style="color:#f92672">/&gt;</span>
</code></pre></div><p>autowire共有以下几种选项:</p>
<ul>
<li>no: 默认的，不进行自动装配。在这种情况下，只能通过ref方式引用其它bean。</li>
<li>byName: 根据bean里面属性的名字在BeanFactory中进行查找并装配。</li>
<li>byType: 按类型。</li>
<li>constructor: 以byType的方式查找bean的构造参数列表。</li>
<li>default: 由父bean决定。</li>
</ul>
<p>参考: <a href="http://www.cnblogs.com/ViviChan/p/4981539.html">Spring - bean的autowire属性(自动装配)</a></p>
<p>autowireConstructor调用的是ConstructorResolver.autowireConstructor，此方法主要做了两件事:</p>
<ul>
<li>
<p>得到合适的构造器对象。</p>
</li>
<li>
<p>根据构造器参数的类型去BeanFactory查找相应的bean:</p>
<p>入口方法在ConstructorResolver.resolveAutowiredArgument:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> Object <span style="color:#a6e22e">resolveAutowiredArgument</span><span style="color:#f92672">(</span>
        MethodParameter param<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">,</span> Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> autowiredBeanNames<span style="color:#f92672">,</span> 
        TypeConverter typeConverter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">resolveDependency</span><span style="color:#f92672">(</span>
            <span style="color:#66d9ef">new</span> DependencyDescriptor<span style="color:#f92672">(</span>param<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">),</span> beanName<span style="color:#f92672">,</span> 
            autowiredBeanNames<span style="color:#f92672">,</span> typeConverter<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
</ul>
<p>最终调用的还是CglibSubclassingInstantiationStrategy.instantiate方法，关键源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">instantiate</span><span style="color:#f92672">(</span>RootBeanDefinition bd<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">,</span> BeanFactory owner<span style="color:#f92672">,</span>
      <span style="color:#66d9ef">final</span> Constructor<span style="color:#f92672">&lt;?&gt;</span> ctor<span style="color:#f92672">,</span> Object<span style="color:#f92672">...</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bd<span style="color:#f92672">.</span><span style="color:#a6e22e">getMethodOverrides</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
           <span style="color:#75715e">//反射调用
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">return</span> BeanUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">instantiateClass</span><span style="color:#f92672">(</span>ctor<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> instantiateWithMethodInjection<span style="color:#f92672">(</span>bd<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> owner<span style="color:#f92672">,</span> ctor<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，如果配置了lookup-method标签，<strong>得到的实际上是用Cglib生成的目标类的代理子类</strong>。</p>
<p>CglibSubclassingInstantiationStrategy.instantiateWithMethodInjection:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> Object <span style="color:#a6e22e">instantiateWithMethodInjection</span><span style="color:#f92672">(</span>RootBeanDefinition bd<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">,</span> BeanFactory 	owner<span style="color:#f92672">,</span>Constructor<span style="color:#f92672">&lt;?&gt;</span> ctor<span style="color:#f92672">,</span> Object<span style="color:#f92672">...</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">// Must generate CGLIB subclass...
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> CglibSubclassCreator<span style="color:#f92672">(</span>bd<span style="color:#f92672">,</span> owner<span style="color:#f92672">).</span><span style="color:#a6e22e">instantiate</span><span style="color:#f92672">(</span>ctor<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>默认构造器</p>
<p>一行代码，很简单:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// No special handling: simply use no-arg constructor.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">return</span> instantiateBean<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">);</span>
</code></pre></div></li>
</ul>
<h6 id="mergedbeandefinitionpostprocessor">MergedBeanDefinitionPostProcessor</h6>
<p>触发源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcessingLock</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcessed</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        applyMergedBeanDefinitionPostProcessors<span style="color:#f92672">(</span>mbd<span style="color:#f92672">,</span> beanType<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
        mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcessed</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>此接口也是Spring内部使用的，不管它了。</p>
<h6 id="属性解析">属性解析</h6>
<p>入口方法: AbstractAutowireCapableBeanFactory.populateBean，它的作用是: 根据autowire类型进行autowire by name，by type 或者是直接进行设置，简略后的源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">populateBean</span><span style="color:#f92672">(</span>String beanName<span style="color:#f92672">,</span> RootBeanDefinition mbd<span style="color:#f92672">,</span> BeanWrapper bw<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//所有&lt;property&gt;的值
</span><span style="color:#75715e"></span>    PropertyValues pvs <span style="color:#f92672">=</span> mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getPropertyValues</span><span style="color:#f92672">();</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getResolvedAutowireMode</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> RootBeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">AUTOWIRE_BY_NAME</span> <span style="color:#f92672">||</span>
            mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getResolvedAutowireMode</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> RootBeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">AUTOWIRE_BY_TYPE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        MutablePropertyValues newPvs <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MutablePropertyValues<span style="color:#f92672">(</span>pvs<span style="color:#f92672">);</span>

        <span style="color:#75715e">// Add property values based on autowire by name if applicable.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getResolvedAutowireMode</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> RootBeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">AUTOWIRE_BY_NAME</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            autowireByName<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> bw<span style="color:#f92672">,</span> newPvs<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Add property values based on autowire by type if applicable.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getResolvedAutowireMode</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> RootBeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">AUTOWIRE_BY_TYPE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            autowireByType<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> bw<span style="color:#f92672">,</span> newPvs<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        pvs <span style="color:#f92672">=</span> newPvs<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">//设值
</span><span style="color:#75715e"></span>    applyPropertyValues<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> bw<span style="color:#f92672">,</span> pvs<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>autowireByName源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">autowireByName</span><span style="color:#f92672">(</span>
        String beanName<span style="color:#f92672">,</span> AbstractBeanDefinition mbd<span style="color:#f92672">,</span> BeanWrapper bw<span style="color:#f92672">,</span> MutablePropertyValues pvs<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//返回所有引用(ref=&#34;XXX&#34;)的bean名称
</span><span style="color:#75715e"></span>    String<span style="color:#f92672">[]</span> propertyNames <span style="color:#f92672">=</span> unsatisfiedNonSimpleProperties<span style="color:#f92672">(</span>mbd<span style="color:#f92672">,</span> bw<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String propertyName <span style="color:#f92672">:</span> propertyNames<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>containsBean<span style="color:#f92672">(</span>propertyName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
             <span style="color:#75715e">//从BeanFactory获取
</span><span style="color:#75715e"></span>            Object bean <span style="color:#f92672">=</span> getBean<span style="color:#f92672">(</span>propertyName<span style="color:#f92672">);</span>
            pvs<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>propertyName<span style="color:#f92672">,</span> bean<span style="color:#f92672">);</span>
            registerDependentBean<span style="color:#f92672">(</span>propertyName<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>autowireByType也是同样的套路，所以可以得出结论: <strong>autowireByName和autowireByType方法只是先获取到引用的bean，真正的设值是在applyPropertyValues中进行的。</strong></p>
<h6 id="属性设置">属性设置</h6>
<p>Spring判断一个属性可不可以被设置(存不存在)是通过java bean的内省操作来完成的，也就是说，属性可以被设置的条件是<strong>此属性拥有public的setter方法，并且注入时的属性名应该是setter的名字</strong>。</p>
<h6 id="初始化-2">初始化</h6>
<p>此处的初始化指的是bean已经构造完成，执行诸如调用其init方法的操作。相关源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// Initialize the bean instance.
</span><span style="color:#75715e"></span>Object exposedObject <span style="color:#f92672">=</span> bean<span style="color:#f92672">;</span>
<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
    populateBean<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> instanceWrapper<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>exposedObject <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        exposedObject <span style="color:#f92672">=</span> initializeBean<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> exposedObject<span style="color:#f92672">,</span> mbd<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>initializeBean:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> Object <span style="color:#a6e22e">initializeBean</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> Object bean<span style="color:#f92672">,</span> RootBeanDefinition mbd<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecurityManager</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        AccessController<span style="color:#f92672">.</span><span style="color:#a6e22e">doPrivileged</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PrivilegedAction<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                invokeAwareMethods<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> bean<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">},</span> getAccessControlContext<span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        invokeAwareMethods<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> bean<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    Object wrappedBean <span style="color:#f92672">=</span> bean<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mbd <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">isSynthetic</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        wrappedBean <span style="color:#f92672">=</span> applyBeanPostProcessorsBeforeInitialization<span style="color:#f92672">(</span>wrappedBean<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    invokeInitMethods<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> wrappedBean<span style="color:#f92672">,</span> mbd<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mbd <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">isSynthetic</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        wrappedBean <span style="color:#f92672">=</span> applyBeanPostProcessorsAfterInitialization<span style="color:#f92672">(</span>wrappedBean<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> wrappedBean<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>主要的操作步骤一目了然。</p>
<ul>
<li>
<p>Aware方法触发:</p>
<p>我们的bean有可能实现了一些XXXAware接口，此处就是负责调用它们:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invokeAwareMethods</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> Object bean<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#66d9ef">instanceof</span> Aware<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#66d9ef">instanceof</span> BeanNameAware<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          <span style="color:#f92672">((</span>BeanNameAware<span style="color:#f92672">)</span> bean<span style="color:#f92672">).</span><span style="color:#a6e22e">setBeanName</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
      <span style="color:#f92672">}</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#66d9ef">instanceof</span> BeanClassLoaderAware<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          <span style="color:#f92672">((</span>BeanClassLoaderAware<span style="color:#f92672">)</span> bean<span style="color:#f92672">).</span><span style="color:#a6e22e">setBeanClassLoader</span><span style="color:#f92672">(</span>getBeanClassLoader<span style="color:#f92672">());</span>
      <span style="color:#f92672">}</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#66d9ef">instanceof</span> BeanFactoryAware<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          <span style="color:#f92672">((</span>BeanFactoryAware<span style="color:#f92672">)</span> bean<span style="color:#f92672">).</span><span style="color:#a6e22e">setBeanFactory</span><span style="color:#f92672">(</span>AbstractAutowireCapableBeanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">);</span>
      <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>BeanPostProcessor触发，没什么好说的</p>
</li>
<li>
<p>调用init方法:</p>
<p>在XML配置中，bean可以有一个init-method属性来指定初始化时调用的方法。从原理来说，其实就是一个反射调用。不过注意这里有一个InitializingBean的概念。</p>
<p>此接口只有一个方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">afterPropertiesSet</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception<span style="color:#f92672">;</span>
</code></pre></div><p>如果我们的bean实现了此接口，那么此方法会首先被调用。此接口的意义在于: 当此bean的所有属性都被设置(注入)后，给bean一个利用现有属性重新组织或是检查属性的机会。感觉和init方法有些冲突，不过此接口在Spring被广泛使用。</p>
</li>
</ul>
<h3 id="getobjectforbeaninstance">getObjectForBeanInstance</h3>
<p>位于AbstractBeanFactory，此方法的目的在于如果bean是FactoryBean，那么返回其工厂方法创建的bean，而不是自身。</p>
<h2 id="prototype初始化">Prototype初始化</h2>
<p>AbstractBeanFactory.doGetBean相关源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">isPrototype</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// It&#39;s a prototype -&gt; create a new instance.
</span><span style="color:#75715e"></span>    Object prototypeInstance <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        beforePrototypeCreation<span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
        prototypeInstance <span style="color:#f92672">=</span> createBean<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        afterPrototypeCreation<span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    bean <span style="color:#f92672">=</span> getObjectForBeanInstance<span style="color:#f92672">(</span>prototypeInstance<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="beforeprototypecreation">beforePrototypeCreation</h3>
<p>此方法用于确保在同一时刻只能有一个此bean在初始化。</p>
<h3 id="createbean">createBean</h3>
<p>和单例的是一样的，不在赘述。</p>
<h3 id="afterprototypecreation">afterPrototypeCreation</h3>
<p>和beforePrototypeCreation对应的，你懂的。</p>
<h3 id="总结">总结</h3>
<p>可以看出，初始化其实和单例是一样的，只不过单例多了一个是否已经存在的检查。</p>
<h2 id="其它scope初始化">其它Scope初始化</h2>
<p>其它就指的是request、session。此部分源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
    String scopeName <span style="color:#f92672">=</span> mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getScope</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">final</span> Scope scope <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scopes</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>scopeName<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>scope <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;No Scope registered for scope name &#39;&#34;</span> <span style="color:#f92672">+</span> scopeName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    Object scopedInstance <span style="color:#f92672">=</span> scope<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ObjectFactory<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">getObject</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> BeansException <span style="color:#f92672">{</span>
            beforePrototypeCreation<span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> createBean<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                afterPrototypeCreation<span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
    bean <span style="color:#f92672">=</span> getObjectForBeanInstance<span style="color:#f92672">(</span>scopedInstance<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>scopes是一个LinkedHashMap&lt;String, Scope&gt;，可以调用 ConfigurableBeanFactory定义的registerScope方法注册其值。</p>
<p>Scope接口继承体系:</p>
<p><img src="/images/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Scope.jpg" alt="Scope继承体系"></p>
<p>根据socpe.get的注释，此方法如果找到了叫做beanName的bean，那么返回，如果没有，将调用ObjectFactory创建之。Scope的实现参考类图。</p>
        </div>
        <footer class="article-footer">
    <a data-url="https://dijun.cf/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" data-id="14005851f3fa212f7b7b2ad2d74df7b1" class="article-share-link">
        <i class="fa fa-share"></i>
        Share
    </a>
    

    <script>
    (function ($) {
        
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
    </script>
</footer>

    </div>

    
<nav id="article-nav">
    
    <a href="https://dijun.cf/spring%E6%A8%A1%E5%9D%97%E8%A7%A3%E8%AF%BB/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">
          Older
      </strong>
      <div class="article-nav-title">Spring模块解读</div>
    </a>
    

    
    <a href="https://dijun.cf/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">
          Newer
      </strong>
      <div class="article-nav-title">Spring Aop源码分析</div>
    </a>
    
</nav>


</article>



    </section>

   	
    	<aside id="sidebar">
    
<div class="widget-wrap">
    <h3 class="widget-title">
        Recents
    </h3>
    <div class="widget">
      <ul id="recent-post">
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/java%E5%B9%B6%E5%8F%91%E4%B9%8Breentrantreadwritelock/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner4.jpg)" alt="Spring Core源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/java">
                        Java
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/java%E5%B9%B6%E5%8F%91%E4%B9%8Breentrantreadwritelock/" class="title">Java并发之ReentrantReadWriteLock</a></p>
                    <p class="item-date">
                        <time datetime="2018-07-08 10:55:42 &#43;0000 UTC" itemprop="datePublished">2018-07-08</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/java%E5%B9%B6%E5%8F%91%E4%B9%8Breentrantlock/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner3.jpg)" alt="Spring Core源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/java">
                        Java
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/java%E5%B9%B6%E5%8F%91%E4%B9%8Breentrantlock/" class="title">Java并发之ReentrantLock</a></p>
                    <p class="item-date">
                        <time datetime="2018-07-05 19:10:26 &#43;0000 UTC" itemprop="datePublished">2018-07-05</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/java%E5%B9%B6%E5%8F%91%E4%B9%8Baqs/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner2.jpg)" alt="Spring Core源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/java">
                        Java
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/java%E5%B9%B6%E5%8F%91%E4%B9%8Baqs/" class="title">Java并发之AQS</a></p>
                    <p class="item-date">
                        <time datetime="2018-07-02 13:14:53 &#43;0000 UTC" itemprop="datePublished">2018-07-02</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/java%E5%B9%B6%E5%8F%91%E4%B9%8Bcas/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner2.jpg)" alt="Spring Core源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/java">
                        Java
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/java%E5%B9%B6%E5%8F%91%E4%B9%8Bcas/" class="title">Java并发之CAS</a></p>
                    <p class="item-date">
                        <time datetime="2018-07-02 09:47:39 &#43;0000 UTC" itemprop="datePublished">2018-07-02</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/java%E5%B9%B6%E5%8F%91%E4%B9%8B%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner3.jpg)" alt="Spring Core源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/java">
                        Java
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/java%E5%B9%B6%E5%8F%91%E4%B9%8B%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/" class="title">Java并发之线程安全</a></p>
                    <p class="item-date">
                        <time datetime="2018-07-01 13:14:53 &#43;0000 UTC" itemprop="datePublished">2018-07-01</time>
                    </p>
                </div>
            </li>
            
        </ul>
    </div>
</div>


    


<div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
        <ul class="category-list">
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/categories/java">
                    java
                </a>
                <span class="category-list-count">9</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/categories/java%E8%99%9A%E6%8B%9F%E6%9C%BA">
                    java虚拟机
                </a>
                <span class="category-list-count">6</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/categories/spring">
                    spring
                </a>
                <span class="category-list-count">7</span>
            </li>
            
        </ul>
    </div>
</div>




    


<div class="widget-wrap">
    <h3 class="widget-title">
        Tags
    </h3>
    <div class="widget">
        <ul class="category-list">
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/java">
                    java
                </a>
                <span class="category-list-count">15</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/java%E8%99%9A%E6%8B%9F%E6%9C%BA">
                    java虚拟机
                </a>
                <span class="category-list-count">6</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/jvm">
                    jvm
                </a>
                <span class="category-list-count">6</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/spring">
                    spring
                </a>
                <span class="category-list-count">7</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/%E5%B9%B6%E5%8F%91">
                    并发
                </a>
                <span class="category-list-count">6</span>
            </li>
            
        </ul>
    </div>
</div>




    


<div class="widget-wrap">
    <h3 class="widget-title">
        Tag cloud
    </h3>
    <div class="widget tagcloud">
        
        
        <a href="https://dijun.cf/tags/java" style="font-size: 12px;">java</a>
        
        
        <a href="https://dijun.cf/tags/java%E8%99%9A%E6%8B%9F%E6%9C%BA" style="font-size: 12px;">java虚拟机</a>
        
        
        <a href="https://dijun.cf/tags/jvm" style="font-size: 12px;">jvm</a>
        
        
        <a href="https://dijun.cf/tags/spring" style="font-size: 12px;">spring</a>
        
        
        <a href="https://dijun.cf/tags/%E5%B9%B6%E5%8F%91" style="font-size: 12px;">并发</a>
        
    </div>
</div>





    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

    
	</div>
</div>

<footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020
      <a href="https://dijun.cf">狄俊</a>. All rights reserved.
    </div>
  </div>
</footer>


<script src="https://dijun.cf/fancybox/jquery.fancybox.pack.js"></script>
<script src="https://dijun.cf/js/script.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>


<script>hljs.initHighlightingOnLoad();</script>





</body>
</html>