<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <title>Spring Aop源码分析 &middot; 狄俊&#39;s blog</title>
    <meta name="generator" content="Hugo 0.75.1" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="author" content="狄俊">
    
      <meta name="description" content="">
    
    
    <link rel="canonical" href="https://dijun.cf/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <link rel="icon" href="https://dijun.cf/favicon.ico">
    <link rel="apple-touch-icon" href="https://dijun.cf/apple-touch-icon.png"/>
    <link rel="stylesheet" href="https://dijun.cf/css/style.css">
    <link rel="stylesheet" href="https://dijun.cf/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://dijun.cf/css/monokai.css">
    <link rel="stylesheet" href="https://dijun.cf/fancybox/jquery.fancybox.css">
    
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <meta property="og:title" content="Spring Aop源码分析" />
<meta property="og:description" content="开头
aop部分的解析器由AopNamespaceHandler注册，其init方法:
@Override
public void init() {
    registerBeanDefinitionParser(&#34;config&#34;, new ConfigBeanDefinitionParser());
    registerBeanDefinitionParser(&#34;aspectj-autoproxy&#34;, new AspectJAutoProxyBeanDefinitionParser());
    registerBeanDefinitionDecorator(&#34;scoped-proxy&#34;, new ScopedProxyBeanDefinitionDecorator());
}
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dijun.cf/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" />
<meta property="article:published_time" content="2018-06-06T12:08:31+00:00" />
<meta property="article:modified_time" content="2018-06-06T12:08:31+00:00" />

    
    <meta itemprop="name" content="Spring Aop源码分析">
<meta itemprop="description" content="开头
aop部分的解析器由AopNamespaceHandler注册，其init方法:
@Override
public void init() {
    registerBeanDefinitionParser(&#34;config&#34;, new ConfigBeanDefinitionParser());
    registerBeanDefinitionParser(&#34;aspectj-autoproxy&#34;, new AspectJAutoProxyBeanDefinitionParser());
    registerBeanDefinitionDecorator(&#34;scoped-proxy&#34;, new ScopedProxyBeanDefinitionDecorator());
}
">
<meta itemprop="datePublished" content="2018-06-06T12:08:31+00:00" />
<meta itemprop="dateModified" content="2018-06-06T12:08:31+00:00" />
<meta itemprop="wordCount" content="1841">



<meta itemprop="keywords" content="spring," />

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring Aop源码分析"/>
<meta name="twitter:description" content="开头
aop部分的解析器由AopNamespaceHandler注册，其init方法:
@Override
public void init() {
    registerBeanDefinitionParser(&#34;config&#34;, new ConfigBeanDefinitionParser());
    registerBeanDefinitionParser(&#34;aspectj-autoproxy&#34;, new AspectJAutoProxyBeanDefinitionParser());
    registerBeanDefinitionDecorator(&#34;scoped-proxy&#34;, new ScopedProxyBeanDefinitionDecorator());
}
"/>

    

    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
</head>
<body>
<div class="container">


<div id="container">
	<header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="https://dijun.cf" id="logo">
          
          <i class="logo" style="background-image: url('https://dijun.cf/images/logo.png')"></i>
          
          <span class="site-title">狄俊&#39;s blog</span>
      </a>
      <nav id="main-nav">
          
          
          <a class="main-nav-link" href="https://dijun.cf/">Home</a>
          
          
          
          <a class="main-nav-link" href="https://dijun.cf/categories/">Categories</a>
          
          
          
          <a class="main-nav-link" href="https://dijun.cf/tags/">Tags</a>
          
          

          
          <a class="main-nav-link" href="/about/">About</a>
          

          
          
          
          
          
          
          
      </nav>
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://dijun.cf/images/avatar.png"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
              <input type="search" name="q" class="search-form-input" placeholder="Search">
              <button type="submit" class="search-form-submit">
              </button>
              <input type="hidden" name="sitesearch" value="https://dijun.cf" />
         </form>
        </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tbody>
          <tr>
          
          
          <td><a class="main-nav-link" href="https://dijun.cf/">Home</a></td>
          
          
          
          <td><a class="main-nav-link" href="https://dijun.cf/categories/">Categories</a></td>
          
          
          
          <td><a class="main-nav-link" href="https://dijun.cf/tags/">Tags</a></td>
          
          

          
          <td><a class="main-nav-link" href="/about/">About</a></td>
          

          
          
          
          
          
          
          
          <td>
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
          <input type="search" name="q" class="search-form-input" placeholder="Search">
          <input type="hidden" name="sitesearch" value="https://dijun.cf" />
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</header>

   	
   	<div class="outer">
   	
    	<aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      <img id="avatar" src="https://dijun.cf/images/avatar.png">
      <h2 id="name">狄俊</h2>
      <h3 id="title">Java &amp; Big Data Engineer</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Shanghai</span>
      
          <a id="follow" href="https://dijun.cf">
              Follow
          </a>
      
    </div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        16
        <span>Posts</span>
      </div>
      <div class="article-info-block">
        
          5
        
        <span>
            Tags
        </span>
      </div>
    </div>
    <div class="profile-block social-links">
      <table>
        <tr>
          



















































          <td><a href="https://dijun.cf/index.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></td>
        </tr>
      </table>
    </div>
  </div>
</aside>

    

    <section id="main">
    
    <article id="page-undefined" class="article article-type-page" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
            
            <img src="/banners/banner4.jpg" class="article-banner">
        

        <header class="article-header">
    <a href="https://dijun.cf/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
    <h1 class="article-title" itemprop="name">
        Spring Aop源码分析
    </h1>
    </a>
    <div class="article-meta">

        
        <div class="article-date">
            <i class="fa fa-calendar"></i>
            <time datetime="2018-06-06 12:08:31 &#43;0000 UTC" itemprop="datePublished">2018-06-06</time>
            &middot;
            1841
            words
            &middot;
            9
            minute read
        </div>
        
        
            
            
            <div class="article-category">
                <i class="fa fa-folder"></i>
                
                
                <a class="article-category-link" href="https://dijun.cf/categories/spring">spring</a>
                
                
            </div>
            
        

        
            
            
            <div class="article-category">
                <i class="fa fa-tags"></i>
                
                
                <a class="article-category-link" href="https://dijun.cf/tags/spring">spring</a>
                
                
            </div>
            
        
    </div>
</header>

        <div class="article-entry" itemprop="articleBody">
            <h1 id="开头">开头</h1>
<p>aop部分的解析器由<code>AopNamespaceHandler</code>注册，其<code>init</code>方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    registerBeanDefinitionParser<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;config&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ConfigBeanDefinitionParser<span style="color:#f92672">());</span>
    registerBeanDefinitionParser<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;aspectj-autoproxy&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> AspectJAutoProxyBeanDefinitionParser<span style="color:#f92672">());</span>
    registerBeanDefinitionDecorator<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;scoped-proxy&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ScopedProxyBeanDefinitionDecorator<span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><h1 id="aopconfig">aop:config</h1>
<p>此标签用以配置pointcut, advisor, aspect，实例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;aop:config&gt;</span>
    <span style="color:#f92672">&lt;aop:pointcut</span> <span style="color:#a6e22e">expression=</span><span style="color:#e6db74">&#34;execution(* exam.service..*.*(..))&#34;</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;transaction&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;aop:advisor</span> <span style="color:#a6e22e">advice-ref=</span><span style="color:#e6db74">&#34;txAdvice&#34;</span> <span style="color:#a6e22e">pointcut-ref=</span><span style="color:#e6db74">&#34;transaction&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;aop:aspect</span> <span style="color:#a6e22e">ref=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/aop:config&gt;</span>
</code></pre></div><p>ConfigBeanDefinitionParser.parse:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> BeanDefinition <span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>Element element<span style="color:#f92672">,</span> ParserContext parserContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    CompositeComponentDefinition compositeDef <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">new</span> CompositeComponentDefinition<span style="color:#f92672">(</span>element<span style="color:#f92672">.</span><span style="color:#a6e22e">getTagName</span><span style="color:#f92672">(),</span> 
            parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">extractSource</span><span style="color:#f92672">(</span>element<span style="color:#f92672">));</span>
    parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">pushContainingComponent</span><span style="color:#f92672">(</span>compositeDef<span style="color:#f92672">);</span>
    <span style="color:#75715e">// 是否生成代理类
</span><span style="color:#75715e"></span>    configureAutoProxyCreator<span style="color:#f92672">(</span>parserContext<span style="color:#f92672">,</span> element<span style="color:#f92672">);</span>
    List<span style="color:#f92672">&lt;</span>Element<span style="color:#f92672">&gt;</span> childElts <span style="color:#f92672">=</span> DomUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getChildElements</span><span style="color:#f92672">(</span>element<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Element elt<span style="color:#f92672">:</span> childElts<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        String localName <span style="color:#f92672">=</span> parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getDelegate</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getLocalName</span><span style="color:#f92672">(</span>elt<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>POINTCUT<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>localName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            parsePointcut<span style="color:#f92672">(</span>elt<span style="color:#f92672">,</span> parserContext<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ADVISOR<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>localName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            parseAdvisor<span style="color:#f92672">(</span>elt<span style="color:#f92672">,</span> parserContext<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ASPECT<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>localName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            parseAspect<span style="color:#f92672">(</span>elt<span style="color:#f92672">,</span> parserContext<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">popAndRegisterContainingComponent</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="解析">解析</h2>
<p>解析的过程主要分为以下几个部分。</p>
<h3 id="proxy-target-class--expose-proxy">proxy-target-class &amp; expose-proxy</h3>
<p>对应着<code>aop:config</code>的两个属性，前者代表是否为被代理这生成CGLIB子类，默认false，只为接口生成代理子类(话说如果不生成子类那么怎么拦截?)。后者代表是否将代理bean暴露给用户，如果暴露，可以通过Spring AopContext类获得，默认不暴露。</p>
<p>解析的过程无非就是属性的读取，不再详细说明。</p>
<h3 id="aoppointcut">aop:pointcut</h3>
<p>pointcut的解析是一个生成一个BeanDefinition并将其id, expression等属性保存在BeanDefinition中。注意以下几点:</p>
<ul>
<li>BeanDefinition的ID来自于id属性，如果没有，那么自动生成。</li>
<li>BeanDefinition的class是AspectJExpressionPointcut。</li>
<li>BeanDefinition的scope为prototype。</li>
</ul>
<p>AspectJExpressionPointcut类图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/AspectJExpressionPointcut.jpg" alt="AspectJExpressionPointcut类图"></p>
<h3 id="aopadvisor">aop:advisor</h3>
<p>首先是其所有属性的示例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;aop:advisor</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#a6e22e">order=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#a6e22e">advice-ref=</span><span style="color:#e6db74">&#34;aopAdvice&#34;</span> <span style="color:#a6e22e">pointcut=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#a6e22e">pointcut-ref=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">/&gt;</span>
</code></pre></div><p>advisor概念是Spring独有的，来自于上古时代，应该是较早时候的aop概念的实现: <a href="http://aopalliance.sourceforge.net/">AOP Alliance (Java/J2EE AOP standards)</a>。Spring官方的说法: <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/aop.html#aop-schema-advisors">aop-schema-advisors</a>。</p>
<p>其相关的包/类就在spring-aop下:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/aopalliance.png" alt="aopalliance包"></p>
<p>advice-ref是必须的属性，<strong>并且这里的advice必须实现org.aopalliance.aop.Advice的子接口</strong>。这些子接口指的什么呢，见Spring官方文档: <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/aop-api.html#aop-api-advice-types">aop-api-advice-types</a>。比如<code>org.aopalliance.intercept.MethodInterceptor</code>。</p>
<p>最常见的用途就是结合事务使用:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;tx:advice</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;txAdvice&#34;</span> <span style="color:#a6e22e">transaction-manager=</span><span style="color:#e6db74">&#34;transactionManager&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;tx:attributes&gt;</span>
        <span style="color:#f92672">&lt;tx:method</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;get*&#34;</span> <span style="color:#a6e22e">read-only=</span><span style="color:#e6db74">&#34;true&#34;</span> <span style="color:#a6e22e">propagation=</span><span style="color:#e6db74">&#34;NOT_SUPPORTED&#34;</span><span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;tx:method</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;find*&#34;</span> <span style="color:#a6e22e">read-only=</span><span style="color:#e6db74">&#34;true&#34;</span> <span style="color:#a6e22e">propagation=</span><span style="color:#e6db74">&#34;NOT_SUPPORTED&#34;</span><span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;tx:method</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;*&#34;</span> <span style="color:#a6e22e">propagation=</span><span style="color:#e6db74">&#34;REQUIRED&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/tx:attributes&gt;</span>
<span style="color:#f92672">&lt;/tx:advice&gt;</span>

<span style="color:#f92672">&lt;aop:config&gt;</span>
    <span style="color:#f92672">&lt;aop:pointcut</span> <span style="color:#a6e22e">expression=</span><span style="color:#e6db74">&#34;execution(* exam.service..*.*(..))&#34;</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;transaction&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;aop:advisor</span> <span style="color:#a6e22e">advice-ref=</span><span style="color:#e6db74">&#34;txAdvice&#34;</span> <span style="color:#a6e22e">pointcut-ref=</span><span style="color:#e6db74">&#34;transaction&#34;</span><span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/aop:config&gt;</span>
</code></pre></div><p>解析的套路和楼上类似，只不过此处的beanClass是<code>DefaultBeanFactoryPointcutAdvisor</code>，其类图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/DefaultBeanFactoryPointcutAdvisor.jpg" alt="DefaultBeanFactoryPointcutAdvisor类图"></p>
<p>另外注意对于pointcut和pointcut-ref两者处理的区别，对于pointcut属性，Spring会同样创建一个AspectJExpressionPointcut类型的BeanDefinition，对于pointcut-ref会生成一个RuntimeBeanReference对象指向原pointcut的引用。此类的类图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/RuntimeBeanReference.jpg" alt="RuntimeBeanReference类图"></p>
<p>可以看出，这种aop的实现需要实现各种接口，所以不应该再使用此种方式进行aop，除了Spring内部的实现。</p>
<h3 id="aopaspect">aop:aspect</h3>
<p>配置举例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;aopAdvice&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.aop.AopDemoAdvice&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#75715e">&lt;!-- 必须配置，因为被代理的对象必须在Spring容器中 --&gt;</span>
<span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;aopDemo&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.aop.AopDemo&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;aop:config&gt;</span>
    <span style="color:#f92672">&lt;aop:pointcut</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;pointcut&#34;</span> <span style="color:#a6e22e">expression=</span><span style="color:#e6db74">&#34;execution(* base.aop.AopDemo.send())&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;aop:aspect</span> <span style="color:#a6e22e">ref=</span><span style="color:#e6db74">&#34;aopAdvice&#34;</span><span style="color:#f92672">&gt;</span>
        <span style="color:#f92672">&lt;aop:before</span> <span style="color:#a6e22e">method=</span><span style="color:#e6db74">&#34;beforeSend&#34;</span> <span style="color:#a6e22e">pointcut-ref=</span><span style="color:#e6db74">&#34;pointcut&#34;</span> <span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;aop:after</span> <span style="color:#a6e22e">method=</span><span style="color:#e6db74">&#34;afterSend&#34;</span> <span style="color:#a6e22e">pointcut-ref=</span><span style="color:#e6db74">&#34;pointcut&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/aop:aspect&gt;</span>
<span style="color:#f92672">&lt;/aop:config&gt;</span>
</code></pre></div><p>解析形成的BeanDefinition结构如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">AspectComponentDefinition
    beanRefArray
        RuntimeBeanReference(aop:aspect的ref属性)
    beanDefArray
        // 被注册
        RootBeanDefinition(aop:declare-parents)
            beanClass: DeclareParentsAdvisor
            ConstructorArg
                implement-interface
                types-matching
                default-impl
                delegate-ref
        // 被注册
        RootBeanDefinition(aop:before,aop:after...)
            beanClass: AspectJPointcutAdvisor
            ConstructorArg
                RootBeanDefinition
                    beanClass: 由子标签决定
                    ConstructorArg
                        RootBeanDefinition
                            beanClass: MethodLocatingFactoryBean
                            properties
                                targetBeanName: aspectName
                                methodName: method属性
                        RootBeanDefinition
                            beanClass: SimpleBeanFactoryAwareAspectInstanceFactory
                            properties
                                aspectBeanName: aspectName
                        //还有pointcut定义和引用...
</code></pre></div><p>结构图里面的aspectName来自于aop:aspect的ref属性，此属性是必须配置的，因为Spring要知道aop:before等标签指定的方法是哪个bean/类/对象的方法。</p>
<h4 id="aopdeclare-parents">aop:declare-parents</h4>
<p>对于aop:declare-parents子标签，其决定的是代理子类应该实现哪些接口:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;aop:declare-parents</span> <span style="color:#a6e22e">types-matching=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#a6e22e">implement-interface=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">/&gt;</span>
</code></pre></div><p>此标签最终被解析成为beanClass为DeclareParentsAdvisor的BeanDefinition，并注册到容器中。其类图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/DeclareParentsAdvisor.jpg" alt="DeclareParentsAdvisor类图"></p>
<h4 id="其它">其它</h4>
<p>此处的其它指的是aop:before, aop:after等最核心的标签。其最终被解析为beanClass为AspectJPointcutAdvisor的BeanDefinition，类图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/AspectJPointcutAdvisor.jpg" alt="AspectJPointcutAdvisor类图"></p>
<p>正如上面结构图里所描述的，其构造参数为一个BeanDefintion，此对象的beanClass是不确定的，由aop:before/after中的before和after决定，代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> Class<span style="color:#f92672">&lt;?&gt;</span> getAdviceClass<span style="color:#f92672">(</span>Element adviceElement<span style="color:#f92672">,</span> ParserContext parserContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String elementName <span style="color:#f92672">=</span> parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getDelegate</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getLocalName</span><span style="color:#f92672">(</span>adviceElement<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>BEFORE<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>elementName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> AspectJMethodBeforeAdvice<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>AFTER<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>elementName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> AspectJAfterAdvice<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>AFTER_RETURNING_ELEMENT<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>elementName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> AspectJAfterReturningAdvice<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>AFTER_THROWING_ELEMENT<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>elementName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> AspectJAfterThrowingAdvice<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>AROUND<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>elementName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> AspectJAroundAdvice<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>而此BeanDefintion的构造参数又由以下三个部分组成:</p>
<h5 id="methodlocatingfactorybean">MethodLocatingFactoryBean</h5>
<p>第一个便是beanClass为此类型的BeanDefinition。其内部有一个methodName属性，存储的便是标签的method属性的值。其类图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/MethodLocatingFactoryBean.jpg" alt="MethodLocatingFactoryBean类图"></p>
<p>这个东西是干什么用的呢?其实是用于在指定的advice(aop:aspect的ref属性)中得到Method对象。入口在setBeanFactory方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setBeanFactory</span><span style="color:#f92672">(</span>BeanFactory beanFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Class<span style="color:#f92672">&lt;?&gt;</span> beanClass <span style="color:#f92672">=</span> beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">targetBeanName</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">method</span> <span style="color:#f92672">=</span> BeanUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveSignature</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">methodName</span><span style="color:#f92672">,</span> beanClass<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="simplebeanfactoryawareaspectinstancefactory">SimpleBeanFactoryAwareAspectInstanceFactory</h5>
<p>其类图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/SimpleBeanFactoryAwareAspectInstanceFactory.jpg" alt="SimpleBeanFactoryAwareAspectInstanceFactory类图"></p>
<p>此类用于在BeanFactory中定位aspect bean，这个bean指的是谁?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;aopAdvice&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.aop.AopDemoAdvice&#34;</span> <span style="color:#f92672">/&gt;</span>
</code></pre></div><p>就是它!查找很简单:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">getAspectInstance</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">aspectBeanName</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="总结">总结</h4>
<p>从整个aop:aspect标签最终被解析为一个AspectJPointcutAdvisor来看，Spring在实现上仍将其作为Advisor的概念。</p>
<h2 id="代理子类生成">代理子类生成</h2>
<p>关键在于AspectJAwareAdvisorAutoProxyCreator，此对象在ConfigBeanDefinitionParser的configureAutoProxyCreator方法中注册，其类图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/AspectJAwareAdvisorAutoProxyCreator.jpg" alt="AspectJAwareAdvisorAutoProxyCreator类图"></p>
<p>那么子类生成的入口在哪里呢?</p>
<h3 id="入口">入口</h3>
<p>从AspectJAwareAdvisorAutoProxyCreator的类图中可以看出，此类实现了SmartInstantiationAwareBeanPostProcessor接口，所以很容易想到入口应该位于此接口及其父接口(BeanPostProcessor)的相关方法中。实际上确实是这样的。</p>
<h3 id="postprocessbeforeinstantiation">postProcessBeforeInstantiation</h3>
<h4 id="调用时机">调用时机</h4>
<p>先来回顾一下此方法在Bean创建的过程中的调用时机。</p>
<p>AbstractAutowireCapableBeanFactory.createBean部分源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">//// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.
</span><span style="color:#75715e"></span>Object bean <span style="color:#f92672">=</span> resolveBeforeInstantiation<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbdToUse<span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
Object beanInstance <span style="color:#f92672">=</span> doCreateBean<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbdToUse<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</code></pre></div><p>可以看出，调用发生在Bean实例的创建之前。</p>
<h4 id="源码">源码</h4>
<p>AbstractAutoProxyCreator.postProcessBeforeInstantiation:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">postProcessBeforeInstantiation</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> beanClass<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Object cacheKey <span style="color:#f92672">=</span> getCacheKey<span style="color:#f92672">(</span>beanClass<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanName <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">targetSourcedBeans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">advisedBeans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isInfrastructureClass<span style="color:#f92672">(</span>beanClass<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> shouldSkip<span style="color:#f92672">(</span>beanClass<span style="color:#f92672">,</span> beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">advisedBeans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">,</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">FALSE</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanName <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        TargetSource targetSource <span style="color:#f92672">=</span> getCustomTargetSource<span style="color:#f92672">(</span>beanClass<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>targetSource <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">targetSourcedBeans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
            Object<span style="color:#f92672">[]</span> specificInterceptors <span style="color:#f92672">=</span> 
                getAdvicesAndAdvisorsForBean<span style="color:#f92672">(</span>beanClass<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> targetSource<span style="color:#f92672">);</span>
            Object proxy <span style="color:#f92672">=</span> createProxy<span style="color:#f92672">(</span>beanClass<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> specificInterceptors<span style="color:#f92672">,</span> targetSource<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">proxyTypes</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">,</span> proxy<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">());</span>
            <span style="color:#66d9ef">return</span> proxy<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>下面分部分对其进行说明。</p>
<h4 id="应该代理-">应该代理 ?</h4>
<p>Spring首先会对当前的beanClass进行检查(是否应该/可以对其进行代理)。</p>
<p>不应该代理的类分为两种情况:</p>
<ul>
<li>用于实现AOP的Spring基础类，此种情况在isInfrastructureClass方法中完成检测(单词Infrastructure正是基础设施的意思)。</li>
<li>子类定义的应该跳过的类，默认AbstractAutoProxyCreator的实现直接返回false，即都不应该跳过。</li>
</ul>
<h5 id="基础类检测">基础类检测</h5>
<p>AbstractAutoProxyCreator.isInfrastructureClass:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isInfrastructureClass</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> beanClass<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">boolean</span> retVal <span style="color:#f92672">=</span> Advice<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isAssignableFrom</span><span style="color:#f92672">(</span>beanClass<span style="color:#f92672">)</span> <span style="color:#f92672">||</span>
            Pointcut<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isAssignableFrom</span><span style="color:#f92672">(</span>beanClass<span style="color:#f92672">)</span> <span style="color:#f92672">||</span>
            Advisor<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isAssignableFrom</span><span style="color:#f92672">(</span>beanClass<span style="color:#f92672">)</span> <span style="color:#f92672">||</span>
            AopInfrastructureBean<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isAssignableFrom</span><span style="color:#f92672">(</span>beanClass<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> retVal<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，任何Advice、Pointcut、Advisor、AopInfrastructureBean的子类都被当做Spring实现AOP的基础设施类。</p>
<h5 id="跳过类检测">跳过类检测</h5>
<p>即shouldSkip方法。前面提到了，AbstractAutoProxyCreator的默认实现直接返回fasle，这一特性被子类AspectJAwareAdvisorAutoProxyCreator重写:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">shouldSkip</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> beanClass<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    List<span style="color:#f92672">&lt;</span>Advisor<span style="color:#f92672">&gt;</span> candidateAdvisors <span style="color:#f92672">=</span> findCandidateAdvisors<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Advisor advisor <span style="color:#f92672">:</span> candidateAdvisors<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>advisor <span style="color:#66d9ef">instanceof</span> AspectJPointcutAdvisor<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(((</span>AbstractAspectJAdvice<span style="color:#f92672">)</span> advisor<span style="color:#f92672">.</span><span style="color:#a6e22e">getAdvice</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">getAspectName</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">shouldSkip</span><span style="color:#f92672">(</span>beanClass<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>那么此方法跳过的是谁呢？</p>
<p>其实就是我们通过aop:aspect标签配置的切面，即:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;aopAdvice&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.aop.AopDemoAdvice&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;aop:config&gt;</span>
    <span style="color:#f92672">&lt;aop:aspect</span> <span style="color:#a6e22e">ref=</span><span style="color:#e6db74">&#34;aopAdvice&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;/aop:aspect&gt;</span>
<span style="color:#f92672">&lt;/aop:config&gt;</span>
</code></pre></div><p>里的aopAdvice。</p>
<p>从前面的aop:aspect一节中可以知道，Spring对于aop:config的解析其实是把aop:before/after等标签解析成为了AspectJPointcutAdvisor类型的BeanDefinition，而aopAdvice以AbstractAspectJAdvice的类型保存在其中。</p>
<p>所以可以得出结论: <strong>Spring跳过的是适用于当前bean的Advisor的Advice/Aspect对象</strong>。</p>
<h6 id="aop逻辑">AOP逻辑</h6>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/aop_logic.jpg" alt="AOP逻辑图"></p>
<p>那么Spring又是如何找到适用于当前bean的Advisor的呢?</p>
<h6 id="advisor寻找">Advisor寻找</h6>
<p>关键便是findCandidateAdvisors方法，此方法将逻辑委托给BeanFactoryAdvisorRetrievalHelper.findAdvisorBeans:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>Advisor<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">findAdvisorBeans</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    String<span style="color:#f92672">[]</span> advisorNames <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
         <span style="color:#75715e">// 结果缓存
</span><span style="color:#75715e"></span>        advisorNames <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cachedAdvisorBeanNames</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>advisorNames <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
             <span style="color:#75715e">// 去容器中寻找
</span><span style="color:#75715e"></span>            advisorNames <span style="color:#f92672">=</span> BeanFactoryUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">beanNamesForTypeIncludingAncestors</span><span style="color:#f92672">(</span>
                    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">,</span> Advisor<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cachedAdvisorBeanNames</span> <span style="color:#f92672">=</span> advisorNames<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>advisorNames<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">&lt;</span>Advisor<span style="color:#f92672">&gt;();</span>
    <span style="color:#f92672">}</span>
    List<span style="color:#f92672">&lt;</span>Advisor<span style="color:#f92672">&gt;</span> advisors <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">&lt;</span>Advisor<span style="color:#f92672">&gt;();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String name <span style="color:#f92672">:</span> advisorNames<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isEligibleBean<span style="color:#f92672">(</span>name<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isCurrentlyInCreation</span><span style="color:#f92672">(</span>name<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                advisors<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> Advisor<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">));</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> advisors<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，首先是从容器中获取到所有的Advisor示例，然后调用isEligibleBean方法逐一判断Advisor是否适用于当前bean。</p>
<h6 id="适用性检测">适用性检测</h6>
<p>指的便是isEligibleBean方法。最终调用的是AbstractAdvisorAutoProxyCreator的同名方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isEligibleAdvisorBean</span><span style="color:#f92672">(</span>String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>而AbstractAdvisorAutoProxyCreator的子类AspectJAwareAdvisorAutoProxyCreator并没有覆盖此方法，所以此处会对<strong>容器中所有的Advisor的Advice进行跳过</strong>。</p>
<h5 id="检测结果缓存">检测结果缓存</h5>
<p>因为postProcessBeforeInstantiation方法会在每个bean初始化之前被调用，所以没有必要每次都真的进行基础类检测和跳过类检测，Spring使用了advisedBeans作为缓存用以提高性能。</p>
<h4 id="targetsource">TargetSource</h4>
<p>从源码中可以看出，对于自定义的TargetSource，Spring会立即执行代理子类的创建。Spring的代理其实是针对TargetSource的，其类图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/TargetSource.jpg" alt="TargetSource类图"></p>
<p>关于此接口在此不展开叙述。</p>
<h3 id="postprocessafterinitialization">postProcessAfterInitialization</h3>
<p>AbstractAutoProxyCreator.postProcessAfterInitialization:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">postProcessAfterInitialization</span><span style="color:#f92672">(</span>Object bean<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Object cacheKey <span style="color:#f92672">=</span> getCacheKey<span style="color:#f92672">(</span>bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> beanName<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">earlyProxyReferences</span><span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> wrapIfNecessary<span style="color:#f92672">(</span>bean<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> cacheKey<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>关键便在于wrapIfNecessary方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> Object <span style="color:#a6e22e">wrapIfNecessary</span><span style="color:#f92672">(</span>Object bean<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">,</span> Object cacheKey<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//自定义TargetSource，已经进行过代理子类生成
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanName <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">targetSourcedBeans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">FALSE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">advisedBeans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isInfrastructureClass<span style="color:#f92672">(</span>bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">())</span> <span style="color:#f92672">||</span> shouldSkip<span style="color:#f92672">(</span>bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">advisedBeans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">,</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">FALSE</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// Create proxy if we have advice.
</span><span style="color:#75715e"></span>    Object<span style="color:#f92672">[]</span> specificInterceptors <span style="color:#f92672">=</span> getAdvicesAndAdvisorsForBean<span style="color:#f92672">(</span>bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>specificInterceptors <span style="color:#f92672">!=</span> DO_NOT_PROXY<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">advisedBeans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">,</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">TRUE</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">// 创建
</span><span style="color:#75715e"></span>        Object proxy <span style="color:#f92672">=</span> createProxy<span style="color:#f92672">(</span>
                bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> beanName<span style="color:#f92672">,</span> specificInterceptors<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> SingletonTargetSource<span style="color:#f92672">(</span>bean<span style="color:#f92672">));</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">proxyTypes</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">,</span> proxy<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">return</span> proxy<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">advisedBeans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">,</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">FALSE</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，在此方法的开头又进行了基础类以及跳过类的检测，再次不再赘述。</p>
<h4 id="advisor寻找-1">Advisor寻找</h4>
<p>即getAdvicesAndAdvisorsForBean方法，这里进行的便是去容器中寻找适用于当前bean的Advisor，最终调用的是</p>
<p>AbstractAdvisorAutoProxyCreator.findEligibleAdvisors:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> List<span style="color:#f92672">&lt;</span>Advisor<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">findEligibleAdvisors</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> beanClass<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    List<span style="color:#f92672">&lt;</span>Advisor<span style="color:#f92672">&gt;</span> candidateAdvisors <span style="color:#f92672">=</span> findCandidateAdvisors<span style="color:#f92672">();</span>
    List<span style="color:#f92672">&lt;</span>Advisor<span style="color:#f92672">&gt;</span> eligibleAdvisors <span style="color:#f92672">=</span> findAdvisorsThatCanApply<span style="color:#f92672">(</span>candidateAdvisors<span style="color:#f92672">,</span> beanClass<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
    extendAdvisors<span style="color:#f92672">(</span>eligibleAdvisors<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>eligibleAdvisors<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        eligibleAdvisors <span style="color:#f92672">=</span> sortAdvisors<span style="color:#f92672">(</span>eligibleAdvisors<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> eligibleAdvisors<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>findCandidateAdvisors前面已经说过了。</p>
<h5 id="适用性判断">适用性判断</h5>
<p>findAdvisorsThatCanApply最终调用AopUtils.findAdvisorsThatCanApply:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> List<span style="color:#f92672">&lt;</span>Advisor<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">findAdvisorsThatCanApply</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>Advisor<span style="color:#f92672">&gt;</span> candidateAdvisors<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;</span> clazz<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>candidateAdvisors<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> candidateAdvisors<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    List<span style="color:#f92672">&lt;</span>Advisor<span style="color:#f92672">&gt;</span> eligibleAdvisors <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">&lt;</span>Advisor<span style="color:#f92672">&gt;();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Advisor candidate <span style="color:#f92672">:</span> candidateAdvisors<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>candidate <span style="color:#66d9ef">instanceof</span> IntroductionAdvisor <span style="color:#f92672">&amp;&amp;</span> canApply<span style="color:#f92672">(</span>candidate<span style="color:#f92672">,</span> clazz<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            eligibleAdvisors<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>candidate<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">boolean</span> hasIntroductions <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>eligibleAdvisors<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Advisor candidate <span style="color:#f92672">:</span> candidateAdvisors<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>candidate <span style="color:#66d9ef">instanceof</span> IntroductionAdvisor<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// already processed
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>canApply<span style="color:#f92672">(</span>candidate<span style="color:#f92672">,</span> clazz<span style="color:#f92672">,</span> hasIntroductions<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            eligibleAdvisors<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>candidate<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> eligibleAdvisors<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>关键在于canApply方法，从源码中可以看出，对于Advisor的判断分为了IntroductionAdvisor以及非IntroductionAdvisor两种情况。</p>
<p>这种分开处理导致了<strong>IntroductionAdvisor在Advisor链中总是位于非IntroductionAdvisor前面</strong>。</p>
<p>canApply(candidate, clazz)其实等价于canApply(candidate, clazz, false):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">canApply</span><span style="color:#f92672">(</span>Advisor advisor<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;</span> targetClass<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> hasIntroductions<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>advisor <span style="color:#66d9ef">instanceof</span> IntroductionAdvisor<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">((</span>IntroductionAdvisor<span style="color:#f92672">)</span> advisor<span style="color:#f92672">).</span><span style="color:#a6e22e">getClassFilter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">matches</span><span style="color:#f92672">(</span>targetClass<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>advisor <span style="color:#66d9ef">instanceof</span> PointcutAdvisor<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        PointcutAdvisor pca <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>PointcutAdvisor<span style="color:#f92672">)</span> advisor<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span> canApply<span style="color:#f92672">(</span>pca<span style="color:#f92672">.</span><span style="color:#a6e22e">getPointcut</span><span style="color:#f92672">(),</span> targetClass<span style="color:#f92672">,</span> hasIntroductions<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// It doesn&#39;t have a pointcut so we assume it applies.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>很明显，对于引入Advisor与其它Advisor是两种不同的判断方式。</p>
<h6 id="引入">引入</h6>
<p>引入的概念在下面aop:scoped-proxy中有提到。因为引入的目的在于动态地向一个类添加另一种功能(接口)，所以只要判断给定的类是否是要引入到的类即可。</p>
<h6 id="其它-1">其它</h6>
<p>AopUtils.canApply:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">canApply</span><span style="color:#f92672">(</span>Pointcut pc<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;</span> targetClass<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> hasIntroductions<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//是否Pointcut可以匹配当前类
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>pc<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassFilter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">matches</span><span style="color:#f92672">(</span>targetClass<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    MethodMatcher methodMatcher <span style="color:#f92672">=</span> pc<span style="color:#f92672">.</span><span style="color:#a6e22e">getMethodMatcher</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">//是否Pointcut可以匹配所有方法
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>methodMatcher <span style="color:#f92672">==</span> MethodMatcher<span style="color:#f92672">.</span><span style="color:#a6e22e">TRUE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// No need to iterate the methods if we&#39;re matching any method anyway...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    IntroductionAwareMethodMatcher introductionAwareMethodMatcher <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>methodMatcher <span style="color:#66d9ef">instanceof</span> IntroductionAwareMethodMatcher<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        introductionAwareMethodMatcher <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>IntroductionAwareMethodMatcher<span style="color:#f92672">)</span> methodMatcher<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    Set<span style="color:#f92672">&lt;</span>Class<span style="color:#f92672">&lt;?&gt;&gt;</span> classes <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedHashSet<span style="color:#f92672">&lt;</span>Class<span style="color:#f92672">&lt;?&gt;&gt;</span>
        <span style="color:#f92672">(</span>ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getAllInterfacesForClassAsSet</span><span style="color:#f92672">(</span>targetClass<span style="color:#f92672">));</span>
    classes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>targetClass<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> clazz <span style="color:#f92672">:</span> classes<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Method<span style="color:#f92672">[]</span> methods <span style="color:#f92672">=</span> ReflectionUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getAllDeclaredMethods</span><span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Method method <span style="color:#f92672">:</span> methods<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>introductionAwareMethodMatcher <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span>
                    introductionAwareMethodMatcher
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">matches</span><span style="color:#f92672">(</span>method<span style="color:#f92672">,</span> targetClass<span style="color:#f92672">,</span> hasIntroductions<span style="color:#f92672">))</span> <span style="color:#f92672">||</span>
                    methodMatcher<span style="color:#f92672">.</span><span style="color:#a6e22e">matches</span><span style="color:#f92672">(</span>method<span style="color:#f92672">,</span> targetClass<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Spring的Pointcut由ClassFilter和MethodMatcher两部分组成，其中前者用以判断给定的类是否在Pointcut的匹配范围内，后者用以在ClassFilter匹配满足的情况下判断给定的方法是否在Pointcut匹配的范围内。</p>
<p>从源码中可以看出，如果ClassFilter匹配得到满足并且Pointcut并不能匹配此类的任意方法，便会<strong>用反射的方法获取targetClass(被检测类)的全部方法逐一交由Pointcut的MethodMatcher进行检测</strong>。</p>
<p>关于Pointcut表达式是如何解析及存储的在此不再展开。</p>
<h5 id="advisor扩展">Advisor扩展</h5>
<p>AbstractAdvisorAutoProxyCreator.extendAdvisors允许子类向Advisor链表中添加自己的Advisor。子类AspectJAwareAdvisorAutoProxyCreator重写了此方法，其逻辑是:</p>
<p>如果Advisor链表中的Advisor含有AspectJ Advice，那么将会把一个ExposeInvocationInterceptor添加到链表的表头，目的在于将MethodInvocation以ThreadLocal的方式暴露给后面所有的Advisor，暂不知道具体的用途。</p>
<h5 id="排序">排序</h5>
<p>即sortAdvisors方法，用于对实现了Ordered接口的Advisor进行排序。</p>
<h4 id="创建">创建</h4>
<p>AbstractAutoProxyCreator.createProxy(略去非关键代码):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> Object <span style="color:#a6e22e">createProxy</span><span style="color:#f92672">(</span>
        Class<span style="color:#f92672">&lt;?&gt;</span> beanClass<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">,</span> Object<span style="color:#f92672">[]</span> specificInterceptors<span style="color:#f92672">,</span> TargetSource targetSource<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ProxyFactory proxyFactory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProxyFactory<span style="color:#f92672">();</span>
    proxyFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">copyFrom</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">//将interceptor适配为Advisor
</span><span style="color:#75715e"></span>    Advisor<span style="color:#f92672">[]</span> advisors <span style="color:#f92672">=</span> buildAdvisors<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> specificInterceptors<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Advisor advisor <span style="color:#f92672">:</span> advisors<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        proxyFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">addAdvisor</span><span style="color:#f92672">(</span>advisor<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> proxyFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getProxy</span><span style="color:#f92672">(</span>getProxyClassLoader<span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="jdk动态代理-or-cglib">JDK动态代理 or Cglib</h5>
<p>由DefaultAopProxyFactory.createAopProxy方法决定使用何种方式创建代理子类。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> AopProxy <span style="color:#a6e22e">createAopProxy</span><span style="color:#f92672">(</span>AdvisedSupport config<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> AopConfigException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>config<span style="color:#f92672">.</span><span style="color:#a6e22e">isOptimize</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> config<span style="color:#f92672">.</span><span style="color:#a6e22e">isProxyTargetClass</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span>
            hasNoUserSuppliedProxyInterfaces<span style="color:#f92672">(</span>config<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        Class<span style="color:#f92672">&lt;?&gt;</span> targetClass <span style="color:#f92672">=</span> config<span style="color:#f92672">.</span><span style="color:#a6e22e">getTargetClass</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>targetClass<span style="color:#f92672">.</span><span style="color:#a6e22e">isInterface</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> Proxy<span style="color:#f92672">.</span><span style="color:#a6e22e">isProxyClass</span><span style="color:#f92672">(</span>targetClass<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> JdkDynamicAopProxy<span style="color:#f92672">(</span>config<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ObjenesisCglibAopProxy<span style="color:#f92672">(</span>config<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> JdkDynamicAopProxy<span style="color:#f92672">(</span>config<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>逻辑很明显，如果指定了(proxy-target-classs设为true)使用Cglib，那么就会使用Cglib的方式，如果没有指定(或为false)，那么先回检测被代理类是否实现了自己的接口，如果实现了，那么就采用JDK动态代理的方式。</p>
<h5 id="jdk动态代理">JDK动态代理</h5>
<p>JdkDynamicAopProxy.getProxy:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">getProxy</span><span style="color:#f92672">(</span>ClassLoader classLoader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//找到可以用来进行代理的接口
</span><span style="color:#75715e"></span>    Class<span style="color:#f92672">&lt;?&gt;[]</span> proxiedInterfaces <span style="color:#f92672">=</span> AopProxyUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">completeProxiedInterfaces</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">advised</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">//用来代理的接口中是否定义了equals或者是hashCode方法?
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//结果保存在内部equalsDefined和hashCodeDefined两个成员变量中
</span><span style="color:#75715e"></span>    findDefinedEqualsAndHashCodeMethods<span style="color:#f92672">(</span>proxiedInterfaces<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> Proxy<span style="color:#f92672">.</span><span style="color:#a6e22e">newProxyInstance</span><span style="color:#f92672">(</span>classLoader<span style="color:#f92672">,</span> proxiedInterfaces<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，关键的InvocationHandler参数其实就是JdkDynamicAopProxy自身。</p>
<p>其invoke方法较长，源码就不贴了，下面进行分部分说明。</p>
<h6 id="equals--hashcode">equals &amp; hashCode</h6>
<p>如果被代理类实现了equals或者是hashCode方法，那么生成的代理子类的equals、hashCode方法实际上执行的是JdkDynamicAopProxy相应方法的逻辑。</p>
<p>invoke方法部分源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equalsDefined</span> <span style="color:#f92672">&amp;&amp;</span> AopUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEqualsMethod</span><span style="color:#f92672">(</span>method<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// The target does not implement the equals(Object) method itself.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> equals<span style="color:#f92672">(</span>args<span style="color:#f92672">[</span>0<span style="color:#f92672">]);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h6 id="链式调用">链式调用</h6>
<p>对于切点方法，比如前面aop:aspect示例配置中的beforeSend</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;aop:before</span> <span style="color:#a6e22e">method=</span><span style="color:#e6db74">&#34;beforeSend&#34;</span> <span style="color:#a6e22e">pointcut-ref=</span><span style="color:#e6db74">&#34;pointcut&#34;</span> <span style="color:#f92672">/&gt;</span>
</code></pre></div><p>Spring会创建一个MethodInvocation对象对所有相关的Advisor进行链式调用。invoke相关源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">List<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> chain <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">advised</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getInterceptorsAndDynamicInterceptionAdvice</span><span style="color:#f92672">(</span>method<span style="color:#f92672">,</span> targetClass<span style="color:#f92672">);</span>
invocation <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ReflectiveMethodInvocation<span style="color:#f92672">(</span>proxy<span style="color:#f92672">,</span> target<span style="color:#f92672">,</span> method<span style="color:#f92672">,</span> args<span style="color:#f92672">,</span> targetClass<span style="color:#f92672">,</span> chain<span style="color:#f92672">);</span>
Object retVal <span style="color:#f92672">=</span> invocation<span style="color:#f92672">.</span><span style="color:#a6e22e">proceed</span><span style="color:#f92672">();</span>
</code></pre></div><h5 id="cglib">Cglib</h5>
<p>同样是对于Advisor的链式调用，不再详细展开。</p>
<h1 id="aopscoped-proxy">aop:scoped-proxy</h1>
<p>此配置一般是这样使用:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;userPreferences&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;com.foo.UserPreferences&#34;</span> <span style="color:#a6e22e">scope=</span><span style="color:#e6db74">&#34;session&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;aop:scoped-proxy/&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
<span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;userManager&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;com.foo.UserManager&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;userPreferences&#34;</span> <span style="color:#a6e22e">ref=</span><span style="color:#e6db74">&#34;userPreferences&#34;</span><span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div><p>对于ref属性，<strong>只会在userManager初始化时注入一次</strong>。这会造成什么问题呢?以session的Scope为例，因为只会注入一次，所以，<strong>userManager引用的始终是同一个userPreferences对象，即使现在可能已经过时了</strong>。此配置便可以使userManager引用的其实是一个对代理的引用，所以可以始终获取到最新的userPreferences。</p>
<p>其作用和注解@ScopedProxy相同。</p>
<p>其解析由ScopedProxyBeanDefinitionDecorator完成，类图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ScopedProxyBeanDefinitionDecorator.jpg" alt="ScopedProxyBeanDefinitionDecorator类图"></p>
<h2 id="解析-1">解析</h2>
<h3 id="入口-1">入口</h3>
<p>从类图可以看出，ScopedProxyBeanDefinitionDecorator和之前的解析器都不同，它的调用入口不同以往:</p>
<p>DefaultBeanDefinitionDocumentReader.processBeanDefinition:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processBeanDefinition</span><span style="color:#f92672">(</span>Element ele<span style="color:#f92672">,</span> BeanDefinitionParserDelegate delegate<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    BeanDefinitionHolder bdHolder <span style="color:#f92672">=</span> delegate<span style="color:#f92672">.</span><span style="color:#a6e22e">parseBeanDefinitionElement</span><span style="color:#f92672">(</span>ele<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bdHolder <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
         <span style="color:#75715e">// 装饰
</span><span style="color:#75715e"></span>        bdHolder <span style="color:#f92672">=</span> delegate<span style="color:#f92672">.</span><span style="color:#a6e22e">decorateBeanDefinitionIfRequired</span><span style="color:#f92672">(</span>ele<span style="color:#f92672">,</span> bdHolder<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>BeanDefinitionParserDelegate.decorateIfRequired:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> BeanDefinitionHolder <span style="color:#a6e22e">decorateIfRequired</span><span style="color:#f92672">(</span>
        Node node<span style="color:#f92672">,</span> BeanDefinitionHolder originalDef<span style="color:#f92672">,</span> BeanDefinition containingBd<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String namespaceUri <span style="color:#f92672">=</span> getNamespaceURI<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isDefaultNamespace<span style="color:#f92672">(</span>namespaceUri<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        NamespaceHandler handler <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">readerContext</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getNamespaceHandlerResolver</span><span style="color:#f92672">()</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">resolve</span><span style="color:#f92672">(</span>namespaceUri<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>handler <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> handler<span style="color:#f92672">.</span>
                <span style="color:#a6e22e">decorate</span><span style="color:#f92672">(</span>node<span style="color:#f92672">,</span> originalDef<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ParserContext<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">readerContext</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> containingBd<span style="color:#f92672">));</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> originalDef<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>一目了然。</p>
<p>这么做(装饰)的原因就是此标签是用在bean内部的，从decorate的方法签名可以看出，第二个便是父(bean)BeanDefinition，所以叫做装饰。</p>
<h3 id="装饰">装饰</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> BeanDefinitionHolder <span style="color:#a6e22e">decorate</span><span style="color:#f92672">(</span>Node node<span style="color:#f92672">,</span> BeanDefinitionHolder definition<span style="color:#f92672">,</span> ParserContext parserContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">boolean</span> proxyTargetClass <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node <span style="color:#66d9ef">instanceof</span> Element<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Element ele <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Element<span style="color:#f92672">)</span> node<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ele<span style="color:#f92672">.</span><span style="color:#a6e22e">hasAttribute</span><span style="color:#f92672">(</span>PROXY_TARGET_CLASS<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            proxyTargetClass <span style="color:#f92672">=</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>ele<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>PROXY_TARGET_CLASS<span style="color:#f92672">));</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    BeanDefinitionHolder holder <span style="color:#f92672">=</span>
            ScopedProxyUtils<span style="color:#f92672">.</span>
            <span style="color:#a6e22e">createScopedProxy</span><span style="color:#f92672">(</span>definition<span style="color:#f92672">,</span> parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getRegistry</span><span style="color:#f92672">(),</span> proxyTargetClass<span style="color:#f92672">);</span>
    String targetBeanName <span style="color:#f92672">=</span> ScopedProxyUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getTargetBeanName</span><span style="color:#f92672">(</span>definition<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanName</span><span style="color:#f92672">());</span>
    <span style="color:#75715e">// 空实现
</span><span style="color:#75715e"></span>    parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getReaderContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">fireComponentRegistered</span><span style="color:#f92672">(</span>
            <span style="color:#66d9ef">new</span> BeanComponentDefinition<span style="color:#f92672">(</span>definition<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanDefinition</span><span style="color:#f92672">(),</span> targetBeanName<span style="color:#f92672">));</span>
    <span style="color:#66d9ef">return</span> holder<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>核心便是createScopedProxy方法，其源码较长，但是这个套路之前见识过了，就是一个偷天换日: 创建一个新的BeanDefinition对象，beanName为被代理的bean的名字，被代理的bean名字为scopedTarget.原名字。被代理的bean扔将被注册到容器中。</p>
<p>新的BeanDefintion的beanClass为ScopedProxyFactoryBean，其类图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ScopedProxyFactoryBean.jpg" alt="ScopedProxyFactoryBean类图"></p>
<h2 id="代理生成">代理生成</h2>
<p>入口便是setBeanFactory方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setBeanFactory</span><span style="color:#f92672">(</span>BeanFactory beanFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ConfigurableBeanFactory cbf <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ConfigurableBeanFactory<span style="color:#f92672">)</span> beanFactory<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scopedTargetSource</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setBeanFactory</span><span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">);</span>
    ProxyFactory pf <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProxyFactory<span style="color:#f92672">();</span>
    pf<span style="color:#f92672">.</span><span style="color:#a6e22e">copyFrom</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    pf<span style="color:#f92672">.</span><span style="color:#a6e22e">setTargetSource</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scopedTargetSource</span><span style="color:#f92672">);</span>

    Class<span style="color:#f92672">&lt;?&gt;</span> beanType <span style="color:#f92672">=</span> beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">targetBeanName</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isProxyTargetClass<span style="color:#f92672">()</span> <span style="color:#f92672">||</span> beanType<span style="color:#f92672">.</span><span style="color:#a6e22e">isInterface</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> 
        Modifier<span style="color:#f92672">.</span><span style="color:#a6e22e">isPrivate</span><span style="color:#f92672">(</span>beanType<span style="color:#f92672">.</span><span style="color:#a6e22e">getModifiers</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
         <span style="color:#75715e">// JDK动态代理可用的接口
</span><span style="color:#75715e"></span>        pf<span style="color:#f92672">.</span><span style="color:#a6e22e">setInterfaces</span><span style="color:#f92672">(</span>ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getAllInterfacesForClass</span><span style="color:#f92672">(</span>beanType<span style="color:#f92672">,</span> cbf<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanClassLoader</span><span style="color:#f92672">()));</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// Add an introduction that implements only the methods on ScopedObject.
</span><span style="color:#75715e"></span>    ScopedObject scopedObject <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DefaultScopedObject
        <span style="color:#f92672">(</span>cbf<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scopedTargetSource</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getTargetBeanName</span><span style="color:#f92672">());</span>
    pf<span style="color:#f92672">.</span><span style="color:#a6e22e">addAdvice</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> DelegatingIntroductionInterceptor<span style="color:#f92672">(</span>scopedObject<span style="color:#f92672">));</span>
    <span style="color:#75715e">// Add the AopInfrastructureBean marker to indicate that the scoped proxy
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// itself is not subject to auto-proxying! Only its target bean is.
</span><span style="color:#75715e"></span>    pf<span style="color:#f92672">.</span><span style="color:#a6e22e">addInterface</span><span style="color:#f92672">(</span>AopInfrastructureBean<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">proxy</span> <span style="color:#f92672">=</span> pf<span style="color:#f92672">.</span><span style="color:#a6e22e">getProxy</span><span style="color:#f92672">(</span>cbf<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanClassLoader</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这个套路上面也见过了。</p>
<h3 id="advisor">Advisor</h3>
<p>核心的拦截逻辑是通过DelegatingIntroductionInterceptor来完成的，其类图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/DelegatingIntroductionInterceptor.jpg" alt="DelegatingIntroductionInterceptor类图"></p>
<p>AdvisedSupport.addAdvice方法将其转化为Advisor:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addAdvice</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> pos<span style="color:#f92672">,</span> Advice advice<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> AopConfigException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>advice <span style="color:#66d9ef">instanceof</span> IntroductionInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// We don&#39;t need an IntroductionAdvisor for this kind of introduction:
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// It&#39;s fully self-describing.
</span><span style="color:#75715e"></span>        addAdvisor<span style="color:#f92672">(</span>pos<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> DefaultIntroductionAdvisor<span style="color:#f92672">(</span>advice<span style="color:#f92672">,</span> <span style="color:#f92672">(</span>IntroductionInfo<span style="color:#f92672">)</span> advice<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>advice <span style="color:#66d9ef">instanceof</span> DynamicIntroductionAdvice<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// We need an IntroductionAdvisor for this kind of introduction.
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        addAdvisor<span style="color:#f92672">(</span>pos<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> DefaultPointcutAdvisor<span style="color:#f92672">(</span>advice<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>显然，DelegatingIntroductionInterceptor被包装为DefaultIntroductionAdvisor对象。</p>
<p>DelegatingIntroductionInterceptor到底是个什么东西呢?这其实就引出了Spring的Introduction(引入)概念。</p>
<h3 id="引入-1">引入</h3>
<p>通常意义上的Spring AOP一般是在方法层面上进行逻辑的改变，而引入指的是在不修改类源码的情况下，<strong>直接为一个类添加新的功能</strong>。下面是一个引入使用的例子:</p>
<p><a href="http://blog.csdn.net/lzghxjt/article/details/51974336">SpringAOP中的IntroductionInterceptor</a></p>
<h2 id="例子">例子</h2>
<h3 id="自定义scope">自定义Scope</h3>
<p>为了便于测试，我们定义一个生存周期仅仅在于一次调用的Scope，源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OneScope</span> <span style="color:#66d9ef">implements</span> Scope <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> index <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">,</span> ObjectFactory<span style="color:#f92672">&lt;?&gt;</span> objectFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;get被调用&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Student<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;skywalker-&#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>index<span style="color:#f92672">++),</span> index<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">//忽略其它方法
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>将其注册到容器中，有两种方法:</p>
<ul>
<li>
<p>在代码中:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanFactory</span><span style="color:#f92672">().</span><span style="color:#a6e22e">registerScope</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;one&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> OneScope<span style="color:#f92672">());</span>
</code></pre></div></li>
<li>
<p>配置文件:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;org.springframework.beans.factory.config.CustomScopeConfigurer&#34;</span><span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;scopes&#34;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;map&gt;</span>
          <span style="color:#f92672">&lt;entry</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;one&#34;</span><span style="color:#f92672">&gt;</span>
              <span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.scope.OneScope&#34;</span> <span style="color:#f92672">/&gt;</span>
          <span style="color:#f92672">&lt;/entry&gt;</span>
      <span style="color:#f92672">&lt;/map&gt;</span>
  <span style="color:#f92672">&lt;/property&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div></li>
</ul>
<h3 id="配置">配置</h3>
<p>此时就可以使用我们自己的Scope了:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.SimpleBean&#34;</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;simpleBean&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;student&#34;</span> <span style="color:#a6e22e">ref=</span><span style="color:#e6db74">&#34;student&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>

<span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;student&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.Student&#34;</span> <span style="color:#a6e22e">scope=</span><span style="color:#e6db74">&#34;one&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;aop:scoped-proxy</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div><h3 id="测试">测试</h3>
<p>执行以下代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">SimpleBean simpleBean <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>SimpleBean<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>simpleBean<span style="color:#f92672">.</span><span style="color:#a6e22e">getStudent</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>simpleBean<span style="color:#f92672">.</span><span style="color:#a6e22e">getStudent</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
</code></pre></div><p>可以看到以下输出:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">get被调用
skywalker-0
get被调用
skywalker-1
</code></pre></div><p>可以得出结论: <strong>当调用被代理的bean的方法时才会触发Scoped的语义，只是获得其对象(getStudent)没有效果</strong>。</p>
<h2 id="原理">原理</h2>
<h3 id="dogetbean">doGetBean</h3>
<p>从根本上来说在于AbstractBeanFactory.doGetBean，部分源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">//scope非prototype和Singleton
</span><span style="color:#75715e"></span><span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
    String scopeName <span style="color:#f92672">=</span> mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getScope</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">final</span> Scope scope <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scopes</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>scopeName<span style="color:#f92672">);</span>
    Object scopedInstance <span style="color:#f92672">=</span> scope<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ObjectFactory<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">getObject</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> BeansException <span style="color:#f92672">{</span>
            beforePrototypeCreation<span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> createBean<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                afterPrototypeCreation<span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
    bean <span style="color:#f92672">=</span> getObjectForBeanInstance<span style="color:#f92672">(</span>scopedInstance<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>scopes是BeanFactory内部的一个 LinkedHashMap&lt;String, Scope&gt;类型的对象。scope.get实际上调用的就是我们的OneSocpe的get方法，没有用到ObjectFactory。</p>
<p>所以，<strong>每调用一次getBean，就会导致一个新的Sudent被创建并返回</strong>。</p>
<h3 id="代理子类">代理子类</h3>
<p>还有一个关键的问题，从上面可以知道SimpleBean内部的student引用其实是一个CGLIB代理子类的对象，那么当调用这个代理对象的相应方法(比如getName)时，是怎样导致Student重新创建(或是getBean被调用)的?</p>
<h3 id="callbackfilter--callback">CallbackFilter &amp; Callback</h3>
<p>必须首先理解下CGLIB的这两个概念。</p>
<h4 id="callback">Callback</h4>
<p><strong>Callback是Cglib所有自定义逻辑(增强)的共同接口</strong>。</p>
<p>其简略类图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Callback.jpg" alt="Callback类图"></p>
<h4 id="callbackfilter">CallbackFilter</h4>
<p><strong>在CGLib回调时可以设置对不同方法执行不同的回调逻辑，或者根本不执行回调。</strong></p>
<p>jdk并不支持这么搞，只支持设置一个InvocationHandler处理(拦截)所有的方法。其类图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/CallbackFilter.jpg" alt="CallbackFilter类图"></p>
<p>Cglib的Enhancer可以指定一个Callback数组，而accept方法的返回值是一个int值，其实就是Callback数组的下标，这样便达到了指定回调逻辑的目的。</p>
<p>参考:</p>
<p><a href="http://blog.csdn.net/zghwaicsdn/article/details/50957474">CGLIB介绍与原理</a></p>
<h3 id="回调">回调</h3>
<p>一般的方法使用的是DynamicAdvisedInterceptor作为回调逻辑，其intercept关键源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">intercept</span><span style="color:#f92672">(</span>Object proxy<span style="color:#f92672">,</span> Method method<span style="color:#f92672">,</span> Object<span style="color:#f92672">[]</span> args<span style="color:#f92672">,</span> MethodProxy methodProxy<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Object target <span style="color:#f92672">=</span> getTarget<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>target就是被代理对象。</p>
<p>getTarget:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> Object <span style="color:#a6e22e">getTarget</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">advised</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getTargetSource</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getTarget</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>TargetSource前面说过了，默认是SimpleBeanTargetSource:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">getTarget</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> getBeanFactory<span style="color:#f92672">().</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>getTargetBeanName<span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>至此，真相大白。</p>
<h1 id="aopaspectj-autoproxy">aop:aspectj-autoproxy</h1>
<p>此标签用以开启对于@AspectJ注解风格AOP的支持。</p>
<h2 id="属性">属性</h2>
<h3 id="proxy-target-class">proxy-target-class</h3>
<p>你懂的。</p>
<h3 id="expose-proxy">expose-proxy</h3>
<p>是否应该把代理对象暴露给AopContext，默认false。</p>
<h2 id="栗子">栗子</h2>
<h3 id="切面">切面</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Aspect</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AspectDemo</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Pointcut</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;execution(void base.aop.AopDemo.send(..))&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">beforeSend</span><span style="color:#f92672">()</span> <span style="color:#f92672">{}</span>
    <span style="color:#a6e22e">@Before</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;beforeSend()&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">before</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;send之前&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="被代理类">被代理类</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AopDemo</span> <span style="color:#66d9ef">implements</span> AopDemoInter <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">send</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;send from aopdemo&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">receive</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;receive from aopdemo&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">inter</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;inter&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="配置-1">配置</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;aop:aspectj-autoproxy</span> <span style="color:#a6e22e">proxy-target-class=</span><span style="color:#e6db74">&#34;true&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.aop.AopDemo&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.aop.annotation.AspectDemo&#34;</span> <span style="color:#f92672">/&gt;</span>
</code></pre></div><p>因为AopDemo实现了AopDemoInter接口，但做实验的send方法又不在此接口里定义，所以只能用cglib的方式代理。</p>
<p>可以看出，<strong>即使标注了@Aspect注解，仍然需要将切面自己配置到Spring容器中。</strong></p>
<h2 id="解析-2">解析</h2>
<p>AspectJAutoProxyBeanDefinitionParser.parse:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> BeanDefinition <span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>Element element<span style="color:#f92672">,</span> ParserContext parserContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    AopNamespaceUtils<span style="color:#f92672">.</span>
        <span style="color:#a6e22e">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span style="color:#f92672">(</span>parserContext<span style="color:#f92672">,</span> element<span style="color:#f92672">);</span>
    extendBeanDefinition<span style="color:#f92672">(</span>element<span style="color:#f92672">,</span> parserContext<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>注册最终在AopConfigUtils.registerOrEscalateApcAsRequired方法中完成，创建器实际上是一个AnnotationAwareAspectJAutoProxyCreator类的对象，此类是前面AspectJAwareAdvisorAutoProxyCreator的子类。</p>
<h2 id="原理-1">原理</h2>
<p>既然是AspectJAwareAdvisorAutoProxyCreator的子类，那么其代理子类的创建等核心逻辑自然是一样的。这里所需要关注的地方自然是所不一样的地方: 即是如何体现其注解的特性的。</p>
<p>前面说过，AspectJAwareAdvisorAutoProxyCreator通过findCandidateAdvisors方法来找到适用于bean的Advisor，所以注解的特性也是通过重写此方法来体现。</p>
<p>AnnotationAwareAspectJAutoProxyCreator.findCandidateAdvisors:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> List<span style="color:#f92672">&lt;</span>Advisor<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">findCandidateAdvisors</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    List<span style="color:#f92672">&lt;</span>Advisor<span style="color:#f92672">&gt;</span> advisors <span style="color:#f92672">=</span> <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">findCandidateAdvisors</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">//这里
</span><span style="color:#75715e"></span>    advisors<span style="color:#f92672">.</span><span style="color:#a6e22e">addAll</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">aspectJAdvisorsBuilder</span><span style="color:#f92672">.</span><span style="color:#a6e22e">buildAspectJAdvisors</span><span style="color:#f92672">());</span>
    <span style="color:#66d9ef">return</span> advisors<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>buildAspectJAdvisors方法所做的便是<strong>从容器中得到所有的bean，逐一判断是不是一个Aspect</strong>。那么判断Aspect的依据是什么?</p>
<p>AbstractAspectJAdvisorFactory.isAspect:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isAspect</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> clazz<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>hasAspectAnnotation<span style="color:#f92672">(</span>clazz<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>compiledByAjc<span style="color:#f92672">(</span>clazz<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>至于其它的实现细节不再探究。</p>
<h2 id="总结-1">总结</h2>
<p>Spring对于AspectJ风格AOP的支持停留在外表(注解)上面，内部的实现仍然是自己的东西。</p>
<h1 id="拾遗">拾遗</h1>
<h2 id="aop切面的坑">AOP切面的坑</h2>
<ol>
<li>定义在private方法上的切面不会被执行，这个很容易理解，毕竟子类不能覆盖父类的私有方法。</li>
<li>同一个代理子类内部的方法相互调用不会再次执行切面。</li>
</ol>
<p>这里以Cglib为例对第二点进行说明，cglib的相关核心组件可以参考前面CallbackFilter &amp; Callback部分。对于配置了一个切面的典型场景，Spring内部的执行流程可总结如下图:</p>
<p><img src="/images/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/cglib_invocation.png" alt="Cglib调用流程"></p>
<p>核心便是对目标方法的调用上，这里由CglibMethodInvocation的invokeJoinpoint实现:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> Object <span style="color:#a6e22e">invokeJoinpoint</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Throwable <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">publicMethod</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">methodProxy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">target</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">arguments</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">invokeJoinpoint</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>如果是非public方法，那么Spring将使用反射的方法对其进行调用，因为反射将其可访问性设为true。MethodProxy是Cglib对方法代理的抽象，这里的关键是<strong>方法调用的对象(目标)是我们的原生类对象，而不是Cglib代理子类的对象，这就从根本上决定了对同类方法的调用不会再次经过切面</strong>。</p>
<h3 id="总结-2">总结</h3>
<p>前面aop:aspectj-autoproxy-属性-expose-proxy一节提到了，Spring允许我们将代理子类暴露出来，可以进行如下配置:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;aop:config</span> <span style="color:#a6e22e">expose-proxy=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;aop:advisor</span> <span style="color:#a6e22e">advice-ref=</span><span style="color:#e6db74">&#34;simpleMethodInterceptor&#34;</span> <span style="color:#a6e22e">pointcut=</span><span style="color:#e6db74">&#34;execution(* aop.SimpleAopBean.*(..))&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/aop:config&gt;</span>
</code></pre></div><p>当我们需要在一个被代理方法中调用同类的方法时(此方法也需要经过切面)，可以这样调用:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testB</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;testB执行&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">((</span>SimpleAopBean<span style="color:#f92672">)</span> AopContext<span style="color:#f92672">.</span><span style="color:#a6e22e">currentProxy</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">testC</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这里其实是一个ThreadLocal，当Cglib代理子类创建调用链之间便会将代理类设置到其中，DynamicAdvisedInterceptor.intercept相关源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">advised</span><span style="color:#f92672">.</span><span style="color:#a6e22e">exposeProxy</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// Make invocation available if necessary.
</span><span style="color:#75715e"></span>    oldProxy <span style="color:#f92672">=</span> AopContext<span style="color:#f92672">.</span><span style="color:#a6e22e">setCurrentProxy</span><span style="color:#f92672">(</span>proxy<span style="color:#f92672">);</span>
    setProxyContext <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div>
        </div>
        <footer class="article-footer">
    <a data-url="https://dijun.cf/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" data-id="c67be83e48f571b08313e0d07f6b4d94" class="article-share-link">
        <i class="fa fa-share"></i>
        Share
    </a>
    

    <script>
    (function ($) {
        
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
    </script>
</footer>

    </div>

    
<nav id="article-nav">
    
    <a href="https://dijun.cf/spring-core%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">
          Older
      </strong>
      <div class="article-nav-title">Spring Core源码分析</div>
    </a>
    

    
    <a href="https://dijun.cf/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">
          Newer
      </strong>
      <div class="article-nav-title">Spring Context源码分析</div>
    </a>
    
</nav>


</article>



    </section>

   	
    	<aside id="sidebar">
    
<div class="widget-wrap">
    <h3 class="widget-title">
        Recents
    </h3>
    <div class="widget">
      <ul id="recent-post">
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/spring-task%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner3.jpg)" alt="Spring Aop源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/spring">
                        spring
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/spring-task%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="title">Spring Task源码分析</a></p>
                    <p class="item-date">
                        <time datetime="2018-06-26 14:40:31 &#43;0000 UTC" itemprop="datePublished">2018-06-26</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/spring-mvc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner3.jpg)" alt="Spring Aop源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/spring">
                        spring
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/spring-mvc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="title">Spring Mvc源码分析</a></p>
                    <p class="item-date">
                        <time datetime="2018-06-25 15:03:57 &#43;0000 UTC" itemprop="datePublished">2018-06-25</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/spring-transaction%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner1.jpg)" alt="Spring Aop源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/spring">
                        spring
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/spring-transaction%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="title">Spring Transaction源码分析</a></p>
                    <p class="item-date">
                        <time datetime="2018-06-15 14:57:50 &#43;0000 UTC" itemprop="datePublished">2018-06-15</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner4.jpg)" alt="Spring Aop源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/spring">
                        spring
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="title">Spring Context源码分析</a></p>
                    <p class="item-date">
                        <time datetime="2018-06-06 23:19:43 &#43;0000 UTC" itemprop="datePublished">2018-06-06</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner3.jpg)" alt="Spring Aop源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/spring">
                        spring
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="title">Spring Aop源码分析</a></p>
                    <p class="item-date">
                        <time datetime="2018-06-06 12:08:31 &#43;0000 UTC" itemprop="datePublished">2018-06-06</time>
                    </p>
                </div>
            </li>
            
        </ul>
    </div>
</div>


    


<div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
        <ul class="category-list">
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/categories/java">
                    java
                </a>
                <span class="category-list-count">3</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/categories/java%E8%99%9A%E6%8B%9F%E6%9C%BA">
                    java虚拟机
                </a>
                <span class="category-list-count">6</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/categories/spring">
                    spring
                </a>
                <span class="category-list-count">7</span>
            </li>
            
        </ul>
    </div>
</div>




    


<div class="widget-wrap">
    <h3 class="widget-title">
        Tags
    </h3>
    <div class="widget">
        <ul class="category-list">
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/java">
                    java
                </a>
                <span class="category-list-count">9</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/java%E8%99%9A%E6%8B%9F%E6%9C%BA">
                    java虚拟机
                </a>
                <span class="category-list-count">6</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/jvm">
                    jvm
                </a>
                <span class="category-list-count">6</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/spring">
                    spring
                </a>
                <span class="category-list-count">7</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/%E5%AE%B9%E5%99%A8">
                    容器
                </a>
                <span class="category-list-count">3</span>
            </li>
            
        </ul>
    </div>
</div>




    


<div class="widget-wrap">
    <h3 class="widget-title">
        Tag cloud
    </h3>
    <div class="widget tagcloud">
        
        
        <a href="https://dijun.cf/tags/java" style="font-size: 12px;">java</a>
        
        
        <a href="https://dijun.cf/tags/java%E8%99%9A%E6%8B%9F%E6%9C%BA" style="font-size: 12px;">java虚拟机</a>
        
        
        <a href="https://dijun.cf/tags/jvm" style="font-size: 12px;">jvm</a>
        
        
        <a href="https://dijun.cf/tags/spring" style="font-size: 12px;">spring</a>
        
        
        <a href="https://dijun.cf/tags/%E5%AE%B9%E5%99%A8" style="font-size: 12px;">容器</a>
        
    </div>
</div>





    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

    
	</div>
</div>

<footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020
      <a href="https://dijun.cf">狄俊</a>. All rights reserved.
    </div>
  </div>
</footer>


<script src="https://dijun.cf/fancybox/jquery.fancybox.pack.js"></script>
<script src="https://dijun.cf/js/script.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>


<script>hljs.initHighlightingOnLoad();</script>





</body>
</html>