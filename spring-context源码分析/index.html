<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <title>Spring Context源码分析 &middot; 狄俊&#39;s blog</title>
    <meta name="generator" content="Hugo 0.75.1" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="author" content="狄俊">
    
      <meta name="description" content="">
    
    
    <link rel="canonical" href="https://dijun.cf/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <link rel="icon" href="https://dijun.cf/favicon.ico">
    <link rel="apple-touch-icon" href="https://dijun.cf/apple-touch-icon.png"/>
    <link rel="stylesheet" href="https://dijun.cf/css/style.css">
    <link rel="stylesheet" href="https://dijun.cf/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://dijun.cf/css/monokai.css">
    <link rel="stylesheet" href="https://dijun.cf/fancybox/jquery.fancybox.css">
    
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <meta property="og:title" content="Spring Context源码分析" />
<meta property="og:description" content="开头
入口方法在BeanDefinitionParserDelegate.parseCustomElement：
return handler.parse(ele, new ParserContext(this.readerContext, this, containingBd));
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dijun.cf/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" />
<meta property="article:published_time" content="2018-06-06T23:19:43+00:00" />
<meta property="article:modified_time" content="2018-06-06T23:19:43+00:00" />

    
    <meta itemprop="name" content="Spring Context源码分析">
<meta itemprop="description" content="开头
入口方法在BeanDefinitionParserDelegate.parseCustomElement：
return handler.parse(ele, new ParserContext(this.readerContext, this, containingBd));
">
<meta itemprop="datePublished" content="2018-06-06T23:19:43+00:00" />
<meta itemprop="dateModified" content="2018-06-06T23:19:43+00:00" />
<meta itemprop="wordCount" content="3892">



<meta itemprop="keywords" content="spring," />

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring Context源码分析"/>
<meta name="twitter:description" content="开头
入口方法在BeanDefinitionParserDelegate.parseCustomElement：
return handler.parse(ele, new ParserContext(this.readerContext, this, containingBd));
"/>

    

    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
</head>
<body>
<div class="container">


<div id="container">
	<header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="https://dijun.cf" id="logo">
          
          <i class="logo" style="background-image: url('https://dijun.cf/images/logo.png')"></i>
          
          <span class="site-title">狄俊&#39;s blog</span>
      </a>
      <nav id="main-nav">
          
          
          <a class="main-nav-link" href="https://dijun.cf/">Home</a>
          
          
          
          <a class="main-nav-link" href="https://dijun.cf/categories/">Categories</a>
          
          
          
          <a class="main-nav-link" href="https://dijun.cf/tags/">Tags</a>
          
          

          
          <a class="main-nav-link" href="/about/">About</a>
          

          
          
          
          
          
          
          
      </nav>
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://dijun.cf/images/avatar.png"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
              <input type="search" name="q" class="search-form-input" placeholder="Search">
              <button type="submit" class="search-form-submit">
              </button>
              <input type="hidden" name="sitesearch" value="https://dijun.cf" />
         </form>
        </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tbody>
          <tr>
          
          
          <td><a class="main-nav-link" href="https://dijun.cf/">Home</a></td>
          
          
          
          <td><a class="main-nav-link" href="https://dijun.cf/categories/">Categories</a></td>
          
          
          
          <td><a class="main-nav-link" href="https://dijun.cf/tags/">Tags</a></td>
          
          

          
          <td><a class="main-nav-link" href="/about/">About</a></td>
          

          
          
          
          
          
          
          
          <td>
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
          <input type="search" name="q" class="search-form-input" placeholder="Search">
          <input type="hidden" name="sitesearch" value="https://dijun.cf" />
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</header>

   	
   	<div class="outer">
   	
    	<aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      <img id="avatar" src="https://dijun.cf/images/avatar.png">
      <h2 id="name">狄俊</h2>
      <h3 id="title">Java &amp; Big Data Engineer</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Shanghai</span>
      
          <a id="follow" href="https://dijun.cf">
              Follow
          </a>
      
    </div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        16
        <span>Posts</span>
      </div>
      <div class="article-info-block">
        
          5
        
        <span>
            Tags
        </span>
      </div>
    </div>
    <div class="profile-block social-links">
      <table>
        <tr>
          



















































          <td><a href="https://dijun.cf/index.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></td>
        </tr>
      </table>
    </div>
  </div>
</aside>

    

    <section id="main">
    
    <article id="page-undefined" class="article article-type-page" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
            
            <img src="/banners/banner2.jpg" class="article-banner">
        

        <header class="article-header">
    <a href="https://dijun.cf/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
    <h1 class="article-title" itemprop="name">
        Spring Context源码分析
    </h1>
    </a>
    <div class="article-meta">

        
        <div class="article-date">
            <i class="fa fa-calendar"></i>
            <time datetime="2018-06-06 23:19:43 &#43;0000 UTC" itemprop="datePublished">2018-06-06</time>
            &middot;
            3892
            words
            &middot;
            19
            minute read
        </div>
        
        
            
            
            <div class="article-category">
                <i class="fa fa-folder"></i>
                
                
                <a class="article-category-link" href="https://dijun.cf/categories/spring">spring</a>
                
                
            </div>
            
        

        
            
            
            <div class="article-category">
                <i class="fa fa-tags"></i>
                
                
                <a class="article-category-link" href="https://dijun.cf/tags/spring">spring</a>
                
                
            </div>
            
        
    </div>
</header>

        <div class="article-entry" itemprop="articleBody">
            <h1 id="开头">开头</h1>
<p>入口方法在BeanDefinitionParserDelegate.parseCustomElement：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">return</span> handler<span style="color:#f92672">.</span><span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>ele<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ParserContext<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">readerContext</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> containingBd<span style="color:#f92672">));</span>
</code></pre></div><p>parse方法由各种NamespaceHandler的父类NamespaceHandlerSupport实现:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> BeanDefinition <span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>Element element<span style="color:#f92672">,</span> ParserContext parserContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> findParserForElement<span style="color:#f92672">(</span>element<span style="color:#f92672">,</span> parserContext<span style="color:#f92672">).</span><span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>element<span style="color:#f92672">,</span> parserContext<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>findParserForElement方法用以寻找适用于此元素的BeanDefinitionParser对象:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> BeanDefinitionParser <span style="color:#a6e22e">findParserForElement</span><span style="color:#f92672">(</span>Element element<span style="color:#f92672">,</span> ParserContext parserContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String localName <span style="color:#f92672">=</span> parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getDelegate</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getLocalName</span><span style="color:#f92672">(</span>element<span style="color:#f92672">);</span>
    BeanDefinitionParser parser <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">parsers</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>localName<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>parser <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getReaderContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">fatal</span><span style="color:#f92672">(</span>
            <span style="color:#e6db74">&#34;Cannot locate BeanDefinitionParser for element [&#34;</span> <span style="color:#f92672">+</span> localName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;]&#34;</span><span style="color:#f92672">,</span> element<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> parser<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>localName是个什么东西呢，比如对于context:annotation-config标签就是annotation-config。</p>
<h1 id="annotation-config">annotation-config</h1>
<p>AnnotationConfigBeanDefinitionParser.parse:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> BeanDefinition <span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>Element element<span style="color:#f92672">,</span> ParserContext parserContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//返回null
</span><span style="color:#75715e"></span>    Object source <span style="color:#f92672">=</span> parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">extractSource</span><span style="color:#f92672">(</span>element<span style="color:#f92672">);</span>
    <span style="color:#75715e">// Obtain bean definitions for all relevant BeanPostProcessors.
</span><span style="color:#75715e"></span>    Set<span style="color:#f92672">&lt;</span>BeanDefinitionHolder<span style="color:#f92672">&gt;</span> processorDefinitions <span style="color:#f92672">=</span>
            AnnotationConfigUtils<span style="color:#f92672">.</span>
                <span style="color:#a6e22e">registerAnnotationConfigProcessors</span><span style="color:#f92672">(</span>parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getRegistry</span><span style="color:#f92672">(),</span> source<span style="color:#f92672">);</span>
    <span style="color:#75715e">// Register component for the surrounding &lt;context:annotation-config&gt; element.
</span><span style="color:#75715e"></span>    CompositeComponentDefinition compDefinition <span style="color:#f92672">=</span> 
        <span style="color:#66d9ef">new</span> CompositeComponentDefinition<span style="color:#f92672">(</span>element<span style="color:#f92672">.</span><span style="color:#a6e22e">getTagName</span><span style="color:#f92672">(),</span> source<span style="color:#f92672">);</span>
    parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">pushContainingComponent</span><span style="color:#f92672">(</span>compDefinition<span style="color:#f92672">);</span>
    <span style="color:#75715e">// Nest the concrete beans in the surrounding component.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>BeanDefinitionHolder processorDefinition <span style="color:#f92672">:</span> processorDefinitions<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">registerComponent</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> BeanComponentDefinition<span style="color:#f92672">(</span>processorDefinition<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// Finally register the composite component.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 空实现
</span><span style="color:#75715e"></span>    parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">popAndRegisterContainingComponent</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="beanpostprocessor注册">BeanPostProcessor注册</h2>
<p>AnnotationConfigUtils.registerAnnotationConfigProcessors源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">//第一个参数其实就是DefaultListableBeanFactory,第二个参数为null
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Set<span style="color:#f92672">&lt;</span>BeanDefinitionHolder<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">registerAnnotationConfigProcessors</span><span style="color:#f92672">(</span>
        BeanDefinitionRegistry registry<span style="color:#f92672">,</span> Object source<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//将registery强转为DefaultListableBeanFactory类型
</span><span style="color:#75715e"></span>    DefaultListableBeanFactory beanFactory <span style="color:#f92672">=</span> unwrapDefaultListableBeanFactory<span style="color:#f92672">(</span>registry<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanFactory <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!(</span>beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getDependencyComparator</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">instanceof</span> AnnotationAwareOrderComparator<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">setDependencyComparator</span><span style="color:#f92672">(</span>AnnotationAwareOrderComparator<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!(</span>beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getAutowireCandidateResolver</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">instanceof</span> 
            ContextAnnotationAutowireCandidateResolver<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">setAutowireCandidateResolver</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ContextAnnotationAutowireCandidateResolver<span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    Set<span style="color:#f92672">&lt;</span>BeanDefinitionHolder<span style="color:#f92672">&gt;</span> beanDefs <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedHashSet<span style="color:#f92672">&lt;</span>BeanDefinitionHolder<span style="color:#f92672">&gt;(</span>4<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>registry<span style="color:#f92672">.</span><span style="color:#a6e22e">containsBeanDefinition</span><span style="color:#f92672">(</span>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        RootBeanDefinition def <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RootBeanDefinition<span style="color:#f92672">(</span>ConfigurationClassPostProcessor<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
        def<span style="color:#f92672">.</span><span style="color:#a6e22e">setSource</span><span style="color:#f92672">(</span>source<span style="color:#f92672">);</span>
        beanDefs<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>registerPostProcessor<span style="color:#f92672">(</span>registry<span style="color:#f92672">,</span> def<span style="color:#f92672">,</span>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>registry<span style="color:#f92672">.</span><span style="color:#a6e22e">containsBeanDefinition</span><span style="color:#f92672">(</span>AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        RootBeanDefinition def <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RootBeanDefinition<span style="color:#f92672">(</span>AutowiredAnnotationBeanPostProcessor<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
        def<span style="color:#f92672">.</span><span style="color:#a6e22e">setSource</span><span style="color:#f92672">(</span>source<span style="color:#f92672">);</span>
        beanDefs<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>registerPostProcessor<span style="color:#f92672">(</span>registry<span style="color:#f92672">,</span> def<span style="color:#f92672">,</span> AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>registry<span style="color:#f92672">.</span><span style="color:#a6e22e">containsBeanDefinition</span><span style="color:#f92672">(</span>REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        RootBeanDefinition def <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RootBeanDefinition<span style="color:#f92672">(</span>RequiredAnnotationBeanPostProcessor<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
        def<span style="color:#f92672">.</span><span style="color:#a6e22e">setSource</span><span style="color:#f92672">(</span>source<span style="color:#f92672">);</span>
        beanDefs<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>registerPostProcessor<span style="color:#f92672">(</span>registry<span style="color:#f92672">,</span> def<span style="color:#f92672">,</span> REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// Check for JSR-250 support, and if present add the CommonAnnotationBeanPostProcessor.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>jsr250Present <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>registry<span style="color:#f92672">.</span><span style="color:#a6e22e">containsBeanDefinition</span><span style="color:#f92672">(</span>COMMON_ANNOTATION_PROCESSOR_BEAN_NAME<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        RootBeanDefinition def <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RootBeanDefinition<span style="color:#f92672">(</span>CommonAnnotationBeanPostProcessor<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
        def<span style="color:#f92672">.</span><span style="color:#a6e22e">setSource</span><span style="color:#f92672">(</span>source<span style="color:#f92672">);</span>
        beanDefs<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>registerPostProcessor<span style="color:#f92672">(</span>registry<span style="color:#f92672">,</span> def<span style="color:#f92672">,</span> COMMON_ANNOTATION_PROCESSOR_BEAN_NAME<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// Check for JPA support, and if present add the PersistenceAnnotationBeanPostProcessor.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>jpaPresent <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>registry<span style="color:#f92672">.</span><span style="color:#a6e22e">containsBeanDefinition</span><span style="color:#f92672">(</span>PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        RootBeanDefinition def <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RootBeanDefinition<span style="color:#f92672">();</span>
        def<span style="color:#f92672">.</span><span style="color:#a6e22e">setBeanClass</span><span style="color:#f92672">(</span>ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span>PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME<span style="color:#f92672">,</span>
                AnnotationConfigUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">()));</span>
        def<span style="color:#f92672">.</span><span style="color:#a6e22e">setSource</span><span style="color:#f92672">(</span>source<span style="color:#f92672">);</span>
        beanDefs<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>registerPostProcessor<span style="color:#f92672">(</span>registry<span style="color:#f92672">,</span> def<span style="color:#f92672">,</span> PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>registry<span style="color:#f92672">.</span><span style="color:#a6e22e">containsBeanDefinition</span><span style="color:#f92672">(</span>EVENT_LISTENER_PROCESSOR_BEAN_NAME<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        RootBeanDefinition def <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RootBeanDefinition<span style="color:#f92672">(</span>EventListenerMethodProcessor<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
        def<span style="color:#f92672">.</span><span style="color:#a6e22e">setSource</span><span style="color:#f92672">(</span>source<span style="color:#f92672">);</span>
        beanDefs<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>registerPostProcessor<span style="color:#f92672">(</span>registry<span style="color:#f92672">,</span> def<span style="color:#f92672">,</span> EVENT_LISTENER_PROCESSOR_BEAN_NAME<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>registry<span style="color:#f92672">.</span><span style="color:#a6e22e">containsBeanDefinition</span><span style="color:#f92672">(</span>EVENT_LISTENER_FACTORY_BEAN_NAME<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        RootBeanDefinition def <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RootBeanDefinition<span style="color:#f92672">(</span>DefaultEventListenerFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
        def<span style="color:#f92672">.</span><span style="color:#a6e22e">setSource</span><span style="color:#f92672">(</span>source<span style="color:#f92672">);</span>
        beanDefs<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>registerPostProcessor<span style="color:#f92672">(</span>registry<span style="color:#f92672">,</span> def<span style="color:#f92672">,</span> EVENT_LISTENER_FACTORY_BEAN_NAME<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">return</span> beanDefs<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="annotationawareordercomparator">AnnotationAwareOrderComparator</h3>
<p>其继承体系如下:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Comparator.jpg" alt="Comparator继承体系"></p>
<p>其作用是比较标注了@Order或是javax.annotation.Priority @Priority注解的元素的优先级。这两种注解的一个常用功能就是设置配置加载的优先级。例子可以参考:</p>
<p><a href="http://www.tuicool.com/articles/VnqUv2">Spring 4.2新特性-使用@Order调整配置类加载顺序</a></p>
<h3 id="contextannotationautowirecandidateresolver">ContextAnnotationAutowireCandidateResolver</h3>
<p>此类用以决定一个bean是否可以当作一个依赖的候选者。其类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ContextAnnotationAutowireCandidateResolver.jpg" alt="ContextAnnotationAutowireCandidateResolver类图"></p>
<h3 id="configurationclasspostprocessor">ConfigurationClassPostProcessor</h3>
<p>此类用于处理标注了@Configuration注解的类。类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ConfigurationClassPostProcessor.jpg" alt="ConfigurationClassPostProcessor类图"></p>
<h3 id="autowiredannotationbeanpostprocessor">AutowiredAnnotationBeanPostProcessor</h3>
<p>此类便用于对标注了@Autowire等注解的bean或是方法进行注入。</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/AutowiredAnnotationBeanPostProcessor.jpg" alt="AutowiredAnnotationBeanPostProcessor类图"></p>
<h3 id="requiredannotationbeanpostprocessor">RequiredAnnotationBeanPostProcessor</h3>
<p>对应Spring @Require注解，此注解被用在setter方法上，意味着此setter方法对应的属性必须被Spring所注入，但是不会检查是否是null。其继承体系和上面的AutowiredAnnotationBeanPostProcessor完全一样。</p>
<h3 id="commonannotationbeanpostprocessor">CommonAnnotationBeanPostProcessor</h3>
<p>用于开启对JSR-250的支持，开启的先决条件是当前classpath中有其类，检测的源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> jsr250Present <span style="color:#f92672">=</span>
    ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isPresent</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;javax.annotation.Resource&#34;</span><span style="color:#f92672">,</span> AnnotationConfigUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">());</span>
</code></pre></div><p>此注解就在rt.jar下，所以默认情况下都是开启JSR-250支持的，所以我们就可以使用喜闻乐见的@Resource注解了。其类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/CommonAnnotationBeanPostProcessor.jpg" alt="CommonAnnotationBeanPostProcessor类图"></p>
<h3 id="persistenceannotationbeanpostprocessor">PersistenceAnnotationBeanPostProcessor</h3>
<p>用于提供JPA支持，开启的先决条件仍然是检测classpath下是否有其类存在，源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> jpaPresent <span style="color:#f92672">=</span>	
    ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isPresent</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;javax.persistence.EntityManagerFactory&#34;</span><span style="color:#f92672">,</span> 
        AnnotationConfigUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">())</span> <span style="color:#f92672">&amp;&amp;</span>
    <span style="color:#75715e">//org.springframework.orm包
</span><span style="color:#75715e"></span>    ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isPresent</span><span style="color:#f92672">(</span>PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME<span style="color:#f92672">,</span> 
        AnnotationConfigUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">());</span>
</code></pre></div><p>rt.jar下面并没有JPA的包，所以此Processor默认是没有被注册的。其类图和上面CommonAnnotationBeanPostProcessor如出一辙。</p>
<h3 id="eventlistenermethodprocessor">EventListenerMethodProcessor</h3>
<p>提供对于注解@EventListener的支持，此注解在Spring4.2被添加，用于监听ApplicationEvent事件。其继承体系:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/EventListenerMethodProcessor.jpg" alt="EventListenerMethodProcessor类图"></p>
<h3 id="defaulteventlistenerfactory">DefaultEventListenerFactory</h3>
<p>此类应该是和上面的配合使用，用以产生EventListener对象，也是从Spring4.2加入，类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/DefaultEventListenerFactory.jpg" alt="DefaultEventListenerFactory类图"></p>
<h2 id="逻辑关系整理">逻辑关系整理</h2>
<p>普通的bean元素(XML)其实都有一个BeanDefinition对象与之对应，但是对于context开头的这种的特殊的元素，它所对应的一般不再是普通意义上的BeanDefinition，而是配合起来一起完成某种功能的组件(比如各种BeanPostProcessor)。这种组件Spring抽象成为ComponentDefinition接口，组件的集合表示成为CompositeComponentDefinition，类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/CompositeComponentDefinition.jpg" alt="CompositeComponentDefinition类图"></p>
<p>最终形成的数据结构如下图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/context_annotation_stack.png" alt="数据结构"></p>
<p>不过这个数据结构貌似也没什么用，因为调用的是XmlBeanDefinitionReader中的eventListener的componentRegistered方法，然而这里的eventListener是EmptyReaderEventListener，也就是空实现。</p>
<h2 id="运行">运行</h2>
<h3 id="configurationclasspostprocessor-1">ConfigurationClassPostProcessor</h3>
<p>本身是一个BeanFactoryPostProcessor对象，其执行入口在AbstractApplicationContext.refresh方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">invokeBeanFactoryPostProcessors<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">);</span>
</code></pre></div><p>注意，因为ConfigurationClassPostProcessor实现自BeanDefinitionRegistryPostProcessor接口，所以在此处会首先调用其postProcessBeanDefinitionRegistry方法，再调用其postProcessBeanFactory方法。</p>
<h4 id="postprocessbeandefinitionregistry">postProcessBeanDefinitionRegistry</h4>
<p>此方法大体由两部分组成。</p>
<h5 id="beanpostprocessor注册-1">BeanPostProcessor注册</h5>
<p>此部分源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">postProcessBeanDefinitionRegistry</span><span style="color:#f92672">(</span>BeanDefinitionRegistry registry<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    RootBeanDefinition iabpp <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RootBeanDefinition<span style="color:#f92672">(</span>ImportAwareBeanPostProcessor<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    iabpp<span style="color:#f92672">.</span><span style="color:#a6e22e">setRole</span><span style="color:#f92672">(</span>BeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">ROLE_INFRASTRUCTURE</span><span style="color:#f92672">);</span>
    registry<span style="color:#f92672">.</span><span style="color:#a6e22e">registerBeanDefinition</span><span style="color:#f92672">(</span>IMPORT_AWARE_PROCESSOR_BEAN_NAME<span style="color:#f92672">,</span> iabpp<span style="color:#f92672">);</span>
    RootBeanDefinition ecbpp <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RootBeanDefinition<span style="color:#f92672">(</span>EnhancedConfigurationBeanPostProcessor<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    ecbpp<span style="color:#f92672">.</span><span style="color:#a6e22e">setRole</span><span style="color:#f92672">(</span>BeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">ROLE_INFRASTRUCTURE</span><span style="color:#f92672">);</span>
    registry<span style="color:#f92672">.</span><span style="color:#a6e22e">registerBeanDefinition</span><span style="color:#f92672">(</span>ENHANCED_CONFIGURATION_PROCESSOR_BEAN_NAME<span style="color:#f92672">,</span> ecbpp<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h6 id="importawarebeanpostprocessor">ImportAwareBeanPostProcessor</h6>
<p>是ConfigurationClassPostProcessor的私有内部类。其类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ImportAwareBeanPostProcessor.jpg" alt="ImportAwareBeanPostProcessor类图"></p>
<p>此类用于处理实现了ImportAware接口的类。ImportAware接口是做什么的要从使用java源文件作为Spring配置说起:</p>
<p>有一个类负责生成Student bean:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Configuration</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StudentConfig</span> <span style="color:#66d9ef">implements</span> ImportAware <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Bean</span>
    <span style="color:#66d9ef">public</span> Student <span style="color:#a6e22e">student</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        Student student <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Student<span style="color:#f92672">();</span>
        student<span style="color:#f92672">.</span><span style="color:#a6e22e">setAge</span><span style="color:#f92672">(</span>22<span style="color:#f92672">);</span>
        student<span style="color:#f92672">.</span><span style="color:#a6e22e">setName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;skywalker&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> student<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setImportMetadata</span><span style="color:#f92672">(</span>AnnotationMetadata importMetadata<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;importaware&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>生成的bean就以所在的方法名命名。还有一个类负责生成SimpleBean:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Configuration</span>
<span style="color:#a6e22e">@Import</span><span style="color:#f92672">(</span>StudentConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SimpleBeanConfig</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Autowired</span>
    <span style="color:#66d9ef">private</span> StudentConfig studentConfig<span style="color:#f92672">;</span>
    <span style="color:#a6e22e">@Bean</span>
    <span style="color:#66d9ef">public</span> SimpleBean <span style="color:#a6e22e">getSimpleBean</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//bean依赖
</span><span style="color:#75715e"></span>        SimpleBean simpleBean <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SimpleBean<span style="color:#f92672">(</span>studentConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">student</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">return</span> simpleBean<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>启动代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    AnnotationConfigApplicationContext context <span style="color:#f92672">=</span> 
        <span style="color:#66d9ef">new</span> AnnotationConfigApplicationContext<span style="color:#f92672">(</span>SimpleBeanConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    SimpleBean simpleBean <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>SimpleBean<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>simpleBean<span style="color:#f92672">.</span><span style="color:#a6e22e">getStudent</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>所以ImportAware接口的作用就是<strong>使被引用的配置类可以获得引用类的相关信息</strong>。</p>
<h6 id="enhancedconfigurationbeanpostprocessor">EnhancedConfigurationBeanPostProcessor</h6>
<p>用于为实现了EnhancedConfiguration接口的类设置BeanFactory对象，所有的@Configuration Cglib子类均实现了此接口，为什么要这么做不太明白。</p>
<h5 id="类解析">类解析</h5>
<p>这里便是对标注了@Configuration注解的类及进行解析，通过调用ConfigurationClassPostProcessor的processConfigBeanDefinitions方法来实现，具体怎么解析就不详细说明了。</p>
<h6 id="bean名字生成策略">bean名字生成策略</h6>
<p>对于配置类，Spring也会将其当作一个bean放到容器中，这就关系到bean的起名了，其实这部分对于@Component, @Controller等注解都是一样的。</p>
<p>ConfigurationClassPostProcessor.processConfigBeanDefinitions相关代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// Detect any custom bean name generation strategy supplied through the enclosing application context
</span><span style="color:#75715e"></span>SingletonBeanRegistry singletonRegistry <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>registry <span style="color:#66d9ef">instanceof</span> SingletonBeanRegistry<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    singletonRegistry <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>SingletonBeanRegistry<span style="color:#f92672">)</span> registry<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">localBeanNameGeneratorSet</span> <span style="color:#f92672">&amp;&amp;</span> 
        <span style="color:#75715e">//org.springframework.context.annotation.internalConfigurationBeanNameGenerator
</span><span style="color:#75715e"></span>        singletonRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">containsSingleton</span><span style="color:#f92672">(</span>CONFIGURATION_BEAN_NAME_GENERATOR<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            BeanNameGenerator generator <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>BeanNameGenerator<span style="color:#f92672">)</span> singletonRegistry<span style="color:#f92672">.</span>
            <span style="color:#a6e22e">getSingleton</span><span style="color:#f92672">(</span>CONFIGURATION_BEAN_NAME_GENERATOR<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">componentScanBeanNameGenerator</span> <span style="color:#f92672">=</span> generator<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">importBeanNameGenerator</span> <span style="color:#f92672">=</span> generator<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>默认是一个AnnotationBeanNameGenerator对象，其类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/BeanNameGenerator.jpg" alt="BeanNameGenerator类图"></p>
<p>那我们可以通过向Spring容器添加一个自定义BeanNameGenerator对象的方式自定义beanName生成策略吗，答案是不可以，这也是为什么此bean的ID前面以internal开头。从代码上来看，不可以的原因在于BeanFactoryPostProcessor的触发时机: <strong>配置解析、BeanDefinition加载之后，Singleton初始化之前</strong>，所以即使配置了此接口的实现，但是此时此bean尚未初始化，所以根本看不到此实例。</p>
<h4 id="postprocessbeanfactory">postProcessBeanFactory</h4>
<p>此方法调用了enhanceConfigurationClasses，其实就是将@Configuration的beanClass转换为CGLIB代理子类。简略版的源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">enhanceConfigurationClasses</span><span style="color:#f92672">(</span>ConfigurableListableBeanFactory beanFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> AbstractBeanDefinition<span style="color:#f92672">&gt;</span> configBeanDefs <span style="color:#f92672">=</span> 
        <span style="color:#66d9ef">new</span> LinkedHashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> AbstractBeanDefinition<span style="color:#f92672">&gt;();</span>
    <span style="color:#75715e">//寻找@Configuration的BeanDefinition
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String beanName <span style="color:#f92672">:</span> beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanDefinitionNames</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        BeanDefinition beanDef <span style="color:#f92672">=</span> beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanDefinition</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ConfigurationClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isFullConfigurationClass</span><span style="color:#f92672">(</span>beanDef<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            configBeanDefs<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> <span style="color:#f92672">(</span>AbstractBeanDefinition<span style="color:#f92672">)</span> beanDef<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>configBeanDefs<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// nothing to enhance -&gt; return immediately
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    ConfigurationClassEnhancer enhancer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConfigurationClassEnhancer<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> AbstractBeanDefinition<span style="color:#f92672">&gt;</span> entry <span style="color:#f92672">:</span> configBeanDefs<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        AbstractBeanDefinition beanDef <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">// If a @Configuration class gets proxied, always proxy the target class
</span><span style="color:#75715e"></span>        beanDef<span style="color:#f92672">.</span><span style="color:#a6e22e">setAttribute</span><span style="color:#f92672">(</span>AutoProxyUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">PRESERVE_TARGET_CLASS_ATTRIBUTE</span><span style="color:#f92672">,</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">TRUE</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">// Set enhanced subclass of the user-specified bean class
</span><span style="color:#75715e"></span>        Class<span style="color:#f92672">&lt;?&gt;</span> configClass <span style="color:#f92672">=</span> beanDef<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveBeanClass</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanClassLoader</span><span style="color:#f92672">);</span>
        Class<span style="color:#f92672">&lt;?&gt;</span> enhancedClass <span style="color:#f92672">=</span> enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">enhance</span><span style="color:#f92672">(</span>configClass<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanClassLoader</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>configClass <span style="color:#f92672">!=</span> enhancedClass<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
             <span style="color:#75715e">//替换
</span><span style="color:#75715e"></span>            beanDef<span style="color:#f92672">.</span><span style="color:#a6e22e">setBeanClass</span><span style="color:#f92672">(</span>enhancedClass<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ConfigurationClassEnhancer.newEnhancer:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> Enhancer <span style="color:#a6e22e">newEnhancer</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> superclass<span style="color:#f92672">,</span> ClassLoader classLoader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Enhancer enhancer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Enhancer<span style="color:#f92672">();</span>
    enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setSuperclass</span><span style="color:#f92672">(</span>superclass<span style="color:#f92672">);</span>
    <span style="color:#75715e">//这里印证了前面EnhancedConfigurationBeanPostProcessor的说明
</span><span style="color:#75715e"></span>    enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setInterfaces</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Class<span style="color:#f92672">&lt;?&gt;[]</span> <span style="color:#f92672">{</span>EnhancedConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">});</span>
    enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setUseFactory</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setNamingPolicy</span><span style="color:#f92672">(</span>SpringNamingPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">);</span>
    enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setStrategy</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> BeanFactoryAwareGeneratorStrategy<span style="color:#f92672">(</span>classLoader<span style="color:#f92672">));</span>
    <span style="color:#75715e">//关键
</span><span style="color:#75715e"></span>    enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setCallbackFilter</span><span style="color:#f92672">(</span>CALLBACK_FILTER<span style="color:#f92672">);</span>
    enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setCallbackTypes</span><span style="color:#f92672">(</span>CALLBACK_FILTER<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallbackTypes</span><span style="color:#f92672">());</span>
    <span style="color:#66d9ef">return</span> enhancer<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>CALLBACK_FILTER是个什么东西呢:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ConditionalCallbackFilter CALLBACK_FILTER <span style="color:#f92672">=</span> 
    <span style="color:#66d9ef">new</span> ConditionalCallbackFilter<span style="color:#f92672">(</span>CALLBACKS<span style="color:#f92672">);</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Callback<span style="color:#f92672">[]</span> CALLBACKS <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Callback<span style="color:#f92672">[]</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">new</span> BeanMethodInterceptor<span style="color:#f92672">(),</span>
    <span style="color:#66d9ef">new</span> BeanFactoryAwareMethodInterceptor<span style="color:#f92672">(),</span>
    NoOp<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span>
<span style="color:#f92672">};</span>
</code></pre></div><p>这么做的原因有两个:</p>
<ul>
<li>
<p>提供Scope支持:</p>
<p>我们可以使用@Scope注解来使用注解的方式配置其Scope:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Bean</span>
<span style="color:#a6e22e">@Scope</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;prototype&#34;</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> Student <span style="color:#a6e22e">student</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  Student student <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Student<span style="color:#f92672">();</span>
    student<span style="color:#f92672">.</span><span style="color:#a6e22e">setAge</span><span style="color:#f92672">(</span>22<span style="color:#f92672">);</span>
    student<span style="color:#f92672">.</span><span style="color:#a6e22e">setName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;skywalker&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> student<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Spring正是通过生成CGLIB子类的方式来提供Scope的语义。更确切的说，是上面源码里面的BeanMethodInterceptor。</p>
</li>
<li>
<p>实现EnhancedConfiguration接口</p>
</li>
</ul>
<h3 id="autowiredannotationbeanpostprocessor-1">AutowiredAnnotationBeanPostProcessor</h3>
<p>类图见上面，由于Adapter的存在，真正实现的是postProcessMergedBeanDefinition和postProcessPropertyValues两个方法。</p>
<h4 id="postprocessmergedbeandefinition">postProcessMergedBeanDefinition</h4>
<h5 id="入口">入口</h5>
<p>其中前者首先被调用，时机是当BeanDefinition被合并(和父Bean)，但是还没有用来创建Bean实例时。回顾下其调用入口:</p>
<p>AbstractAutowireCapableBeanFactory.doCreateBean(简略):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> Object <span style="color:#a6e22e">doCreateBean</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> RootBeanDefinition mbd<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> Object<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// Instantiate the bean.
</span><span style="color:#75715e"></span>    BeanWrapper instanceWrapper <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">isSingleton</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        instanceWrapper <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">factoryBeanInstanceCache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>instanceWrapper <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        instanceWrapper <span style="color:#f92672">=</span> createBeanInstance<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">final</span> Object bean <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>instanceWrapper <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> instanceWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getWrappedInstance</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    Class<span style="color:#f92672">&lt;?&gt;</span> beanType <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>instanceWrapper <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> instanceWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getWrappedClass</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">// Allow post-processors to modify the merged bean definition.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcessingLock</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcessed</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            applyMergedBeanDefinitionPostProcessors<span style="color:#f92672">(</span>mbd<span style="color:#f92672">,</span> beanType<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
            mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcessed</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>	
</code></pre></div><p>applyMergedBeanDefinitionPostProcessors:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">applyMergedBeanDefinitionPostProcessors</span><span style="color:#f92672">(</span>RootBeanDefinition mbd<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;</span> beanType<span style="color:#f92672">,</span> 
    String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>BeanPostProcessor bp <span style="color:#f92672">:</span> getBeanPostProcessors<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bp <span style="color:#66d9ef">instanceof</span> MergedBeanDefinitionPostProcessor<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            MergedBeanDefinitionPostProcessor bdp <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>MergedBeanDefinitionPostProcessor<span style="color:#f92672">)</span> bp<span style="color:#f92672">;</span>
            bdp<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcessMergedBeanDefinition</span><span style="color:#f92672">(</span>mbd<span style="color:#f92672">,</span> beanType<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="源码">源码</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">postProcessMergedBeanDefinition</span><span style="color:#f92672">(</span>RootBeanDefinition beanDefinition<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;</span> beanType<span style="color:#f92672">,</span> String 	 beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanType <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        InjectionMetadata metadata <span style="color:#f92672">=</span> findAutowiringMetadata<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> beanType<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        metadata<span style="color:#f92672">.</span><span style="color:#a6e22e">checkConfigMembers</span><span style="color:#f92672">(</span>beanDefinition<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>findAutowiringMetadata:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> InjectionMetadata <span style="color:#a6e22e">findAutowiringMetadata</span><span style="color:#f92672">(</span>String beanName<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;</span> clazz<span style="color:#f92672">,</span> PropertyValues pvs<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// Fall back to class name as cache key, for backwards compatibility with custom callers.
</span><span style="color:#75715e"></span>    String cacheKey <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasLength</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> beanName <span style="color:#f92672">:</span> clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
    <span style="color:#75715e">// Quick check on the concurrent map first, with minimal locking.
</span><span style="color:#75715e"></span>    InjectionMetadata metadata <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">injectionMetadataCache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>InjectionMetadata<span style="color:#f92672">.</span><span style="color:#a6e22e">needsRefresh</span><span style="color:#f92672">(</span>metadata<span style="color:#f92672">,</span> clazz<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">injectionMetadataCache</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            metadata <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">injectionMetadataCache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>InjectionMetadata<span style="color:#f92672">.</span><span style="color:#a6e22e">needsRefresh</span><span style="color:#f92672">(</span>metadata<span style="color:#f92672">,</span> clazz<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>metadata <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    metadata<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">(</span>pvs<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                metadata <span style="color:#f92672">=</span> buildAutowiringMetadata<span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">injectionMetadataCache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">,</span> metadata<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> metadata<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>injectionMetadataCache是一个ConcurrentHashMap对象，个人认为设置此缓存有以下几个原因:</p>
<ul>
<li>假设有多线程同时调用针对某一个bean的getBean方法，那么这样可以保证只有一个线程执行一次@Autowire注解的扫描工作。</li>
<li>对于非singleton(比如prototype)类型的bean，这样同样可以保证只解析一次，防止做无用功。</li>
</ul>
<p>可以看到，Spring使用了代价更小的ConcurrentHashMap来先做一个预检测，这样尽可能的减小锁的使用以及粒度，值得借鉴。</p>
<p>@Autowire注解的扫描在buildAutowiringMetadata方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> InjectionMetadata <span style="color:#a6e22e">buildAutowiringMetadata</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Class<span style="color:#f92672">&lt;?&gt;</span> clazz<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    LinkedList<span style="color:#f92672">&lt;</span>InjectionMetadata<span style="color:#f92672">.</span><span style="color:#a6e22e">InjectedElement</span><span style="color:#f92672">&gt;</span> elements <span style="color:#f92672">=</span> 
        <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">&lt;</span>InjectionMetadata<span style="color:#f92672">.</span><span style="color:#a6e22e">InjectedElement</span><span style="color:#f92672">&gt;();</span>
    Class<span style="color:#f92672">&lt;?&gt;</span> targetClass <span style="color:#f92672">=</span> clazz<span style="color:#f92672">;</span>
    <span style="color:#75715e">//循环检测父类
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> LinkedList<span style="color:#f92672">&lt;</span>InjectionMetadata<span style="color:#f92672">.</span><span style="color:#a6e22e">InjectedElement</span><span style="color:#f92672">&gt;</span> currElements <span style="color:#f92672">=</span>
                <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">&lt;</span>InjectionMetadata<span style="color:#f92672">.</span><span style="color:#a6e22e">InjectedElement</span><span style="color:#f92672">&gt;();</span>
        ReflectionUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">doWithLocalFields</span><span style="color:#f92672">(</span>targetClass<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ReflectionUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">FieldCallback</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doWith</span><span style="color:#f92672">(</span>Field field<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IllegalArgumentException<span style="color:#f92672">,</span> IllegalAccessException <span style="color:#f92672">{</span>
                AnnotationAttributes ann <span style="color:#f92672">=</span> findAutowiredAnnotation<span style="color:#f92672">(</span>field<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ann <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                      <span style="color:#75715e">//不支持静态变量
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Modifier<span style="color:#f92672">.</span><span style="color:#a6e22e">isStatic</span><span style="color:#f92672">(</span>field<span style="color:#f92672">.</span><span style="color:#a6e22e">getModifiers</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">boolean</span> required <span style="color:#f92672">=</span> determineRequiredStatus<span style="color:#f92672">(</span>ann<span style="color:#f92672">);</span>
                    currElements<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> AutowiredFieldElement<span style="color:#f92672">(</span>field<span style="color:#f92672">,</span> required<span style="color:#f92672">));</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">});</span>
        ReflectionUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">doWithLocalMethods</span><span style="color:#f92672">(</span>targetClass<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ReflectionUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">MethodCallback</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doWith</span><span style="color:#f92672">(</span>Method method<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IllegalArgumentException<span style="color:#f92672">,</span> IllegalAccessException <span style="color:#f92672">{</span>
                Method bridgedMethod <span style="color:#f92672">=</span> BridgeMethodResolver<span style="color:#f92672">.</span><span style="color:#a6e22e">findBridgedMethod</span><span style="color:#f92672">(</span>method<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>BridgeMethodResolver<span style="color:#f92672">.</span><span style="color:#a6e22e">isVisibilityBridgeMethodPair</span><span style="color:#f92672">(</span>method<span style="color:#f92672">,</span> bridgedMethod<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                AnnotationAttributes ann <span style="color:#f92672">=</span> findAutowiredAnnotation<span style="color:#f92672">(</span>bridgedMethod<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ann <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getMostSpecificMethod</span><span style="color:#f92672">(</span>method<span style="color:#f92672">,</span> clazz<span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Modifier<span style="color:#f92672">.</span><span style="color:#a6e22e">isStatic</span><span style="color:#f92672">(</span>method<span style="color:#f92672">.</span><span style="color:#a6e22e">getModifiers</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>method<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameterTypes</span><span style="color:#f92672">().</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>logger<span style="color:#f92672">.</span><span style="color:#a6e22e">isWarnEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                            logger<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Autowired annotation should be used on 
</span><span style="color:#e6db74">                                methods with parameters: &#34;</span> <span style="color:#f92672">+</span> method<span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">boolean</span> required <span style="color:#f92672">=</span> determineRequiredStatus<span style="color:#f92672">(</span>ann<span style="color:#f92672">);</span>
                    PropertyDescriptor pd <span style="color:#f92672">=</span> BeanUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">findPropertyForMethod</span><span style="color:#f92672">(</span>bridgedMethod<span style="color:#f92672">,</span> clazz<span style="color:#f92672">);</span>
                    currElements<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> AutowiredMethodElement<span style="color:#f92672">(</span>method<span style="color:#f92672">,</span> required<span style="color:#f92672">,</span> pd<span style="color:#f92672">));</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">});</span>
        elements<span style="color:#f92672">.</span><span style="color:#a6e22e">addAll</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> currElements<span style="color:#f92672">);</span>
        targetClass <span style="color:#f92672">=</span> targetClass<span style="color:#f92672">.</span><span style="color:#a6e22e">getSuperclass</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>targetClass <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> targetClass <span style="color:#f92672">!=</span> Object<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> InjectionMetadata<span style="color:#f92672">(</span>clazz<span style="color:#f92672">,</span> elements<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，Spring使用了一个do while循环来一直检测其父类，直到Object，这就说明，<strong>Spring注入注解可以配置在此bean的父类上</strong>。其实，最开始的时候网站的Service层和Dao层一直都是这么做的。</p>
<h5 id="变量扫描">变量扫描</h5>
<p>之后便是逐一扫描当前类的成员变量，检测是否有@Autowire注解。</p>
<p>ReflectionUtils的实现其实就是访问者模式，其源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doWithLocalFields</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> clazz<span style="color:#f92672">,</span> FieldCallback fc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Field field <span style="color:#f92672">:</span> getDeclaredFields<span style="color:#f92672">(</span>clazz<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            fc<span style="color:#f92672">.</span><span style="color:#a6e22e">doWith</span><span style="color:#f92672">(</span>field<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IllegalAccessException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>determineRequiredStatus方法用以判断是否是必须的，所谓的必须是指: 如果容器里没有需要的bean，那么会抛出异常，否则就忽略了，默认是必须的。原理很简单，不说了。</p>
<h5 id="方法扫描">方法扫描</h5>
<h6 id="bridge方法">bridge方法</h6>
<p>就是方法扫描的第一行源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Method bridgedMethod <span style="color:#f92672">=</span> BridgeMethodResolver<span style="color:#f92672">.</span><span style="color:#a6e22e">findBridgedMethod</span><span style="color:#f92672">(</span>method<span style="color:#f92672">);</span>
</code></pre></div><p>此句代码的作用是**判断method是否是bridge方法，如果是，寻找其真正的方法。**这里的bridge方法并不是所谓的bridge模式。</p>
<p>有这样的demo代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JavaTest</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyList</span> <span style="color:#66d9ef">extends</span> ArrayList <span style="color:#f92672">{</span>
        <span style="color:#75715e">//注意父类的返回类型是Object
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Method method <span style="color:#f92672">:</span> MyList<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredMethods</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;name: &#34;</span> <span style="color:#f92672">+</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, return: &#34;</span> <span style="color:#f92672">+</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">getReturnType</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>子类重写父类的方法但是返回值不同在java语言里是合法的。此程序的输出:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">name: get, return: class java.lang.String
name: get, return: class java.lang.Object
</code></pre></div><p>通过javap反编译命令也可以看到有两个get方法。其中返回Object的便是bridge方法。jdk从1.5开始便提供了方法判断是否是此种方法: Method:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Returns {@code true} if this method is a bridge
</span><span style="color:#75715e"> * method; returns {@code false} otherwise.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * @return true if and only if this method is a bridge
</span><span style="color:#75715e"> * method as defined by the Java Language Specification.
</span><span style="color:#75715e"> * @since 1.5
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isBridge</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>getModifiers<span style="color:#f92672">()</span> <span style="color:#f92672">&amp;</span> Modifier<span style="color:#f92672">.</span><span style="color:#a6e22e">BRIDGE</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，bridge和static之类一样，在java内部也是有一个修饰符的，只不过只在jvm内部可见。</p>
<p>可以参考: <a href="http://ifeve.com/syntethic-and-bridge-methods/">Java那些不为人知的特殊方法</a></p>
<p>到这里寻找真正方法的原理也好理解了，就是在所有Method中寻找方法名相同、参数列表相同但返回值不同的。</p>
<h6 id="propertydescriptor">PropertyDescriptor</h6>
<p>用于描述java bean，如果被标注@Autowire的方法是一个getter或setter方法，那么Spring会保存下来其PropertyDescriptor对象，如果不是，那么就是空。</p>
<h4 id="postprocesspropertyvalues">postProcessPropertyValues</h4>
<h5 id="入口-1">入口</h5>
<p>AbstractAutowireCapableBeanFactory.populateBean方法，执行时机是在bean的属性都已经计算(根据xml配置进行完autowire)完毕，设置到bean实例之前。</p>
<h5 id="注入">注入</h5>
<p>源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processInjection</span><span style="color:#f92672">(</span>Object bean<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> BeansException <span style="color:#f92672">{</span>
    Class<span style="color:#f92672">&lt;?&gt;</span> clazz <span style="color:#f92672">=</span> bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">();</span>
     <span style="color:#75715e">// 查找缓存
</span><span style="color:#75715e"></span>    InjectionMetadata metadata <span style="color:#f92672">=</span> findAutowiringMetadata<span style="color:#f92672">(</span>clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> clazz<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    metadata<span style="color:#f92672">.</span><span style="color:#a6e22e">inject</span><span style="color:#f92672">(</span>bean<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>根据上面postProcessMergedBeanDefinition一节的说明，解析的结果最终保存为一个InjectionMetadata对象，其内部含有一个InjectionMetadata.InjectedElement类型的List，所以注入的过程实际上便是遍历此List调用每一个InjectionMetadata.InjectedElement的inject的过程。</p>
<h6 id="field注入">Field注入</h6>
<p>实现类是AutowiredFieldElement。注入的原理就是从容器中查找相关的依赖，用反射的方法调用Field的set方法，不在详细说了。</p>
<h6 id="方法注入">方法注入</h6>
<p>实现类是AutowiredMethodElement。注入的原理是遍历此方法的参数列表，针对每一个参数都去容器中寻找相应的bean，之后调用Method的invoke方法即可。</p>
<h3 id="requiredannotationbeanpostprocessor-1">RequiredAnnotationBeanPostProcessor</h3>
<p>上面提到了，此类的类图和上面的邻居类似，所以调用的方法的顺序、时机都是一样，所以不再赘述。</p>
<h4 id="postprocessmergedbeandefinition-1">postProcessMergedBeanDefinition</h4>
<p>空实现，就是这么任性:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">postProcessMergedBeanDefinition</span><span style="color:#f92672">(</span>RootBeanDefinition beanDefinition<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;</span> beanType<span style="color:#f92672">,</span> String 	beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="postprocesspropertyvalues-1">postProcessPropertyValues</h4>
<p>源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> PropertyValues <span style="color:#a6e22e">postProcessPropertyValues</span><span style="color:#f92672">(</span>
        PropertyValues pvs<span style="color:#f92672">,</span> PropertyDescriptor<span style="color:#f92672">[]</span> pds<span style="color:#f92672">,</span> Object bean<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throws</span> BeansException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">validatedBeanNames</span><span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>shouldSkip<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">,</span> beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> invalidProperties <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;();</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>PropertyDescriptor pd <span style="color:#f92672">:</span> pds<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isRequiredProperty<span style="color:#f92672">(</span>pd<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>pvs<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>pd<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
                    invalidProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>pd<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>invalidProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BeanInitializationException<span style="color:#f92672">(</span>buildExceptionMessage
                    <span style="color:#f92672">(</span>invalidProperties<span style="color:#f92672">,</span> beanName<span style="color:#f92672">));</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">validatedBeanNames</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> pvs<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="结果缓存">结果缓存</h5>
<p>validatedBeanNames是一个Set<!-- raw HTML omitted -->类型，对于已经检查过的bean，将其name加入Set，防止做无用功。</p>
<h5 id="propertydescriptor-1">PropertyDescriptor</h5>
<p>从源码可以看出，校验是通过PropertyDescriptor完成的，那么这个数组是从哪里来的呢?</p>
<p>AbstractAutowireCapableBeanFactory.populateBean相关代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">PropertyDescriptor<span style="color:#f92672">[]</span> filteredPds <span style="color:#f92672">=</span> filterPropertyDescriptorsForDependencyCheck<span style="color:#f92672">(</span>bw<span style="color:#f92672">,</span> mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">allowCaching</span><span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasInstAwareBpps<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>BeanPostProcessor bp <span style="color:#f92672">:</span> getBeanPostProcessors<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bp <span style="color:#66d9ef">instanceof</span> InstantiationAwareBeanPostProcessor<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            InstantiationAwareBeanPostProcessor ibp <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>InstantiationAwareBeanPostProcessor<span style="color:#f92672">)</span> bp<span style="color:#f92672">;</span>
            pvs <span style="color:#f92672">=</span> ibp<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcessPropertyValues</span><span style="color:#f92672">(</span>pvs<span style="color:#f92672">,</span> filteredPds<span style="color:#f92672">,</span> bw<span style="color:#f92672">.</span><span style="color:#a6e22e">getWrappedInstance</span><span style="color:#f92672">(),</span> beanName<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pvs <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>filterPropertyDescriptorsForDependencyCheck单参数方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> PropertyDescriptor<span style="color:#f92672">[]</span> <span style="color:#a6e22e">filterPropertyDescriptorsForDependencyCheck</span><span style="color:#f92672">(</span>BeanWrapper bw<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    List<span style="color:#f92672">&lt;</span>PropertyDescriptor<span style="color:#f92672">&gt;</span> pds <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">&lt;</span>PropertyDescriptor<span style="color:#f92672">&gt;(</span>Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span>bw<span style="color:#f92672">.</span><span style="color:#a6e22e">getPropertyDescriptors</span><span style="color:#f92672">()));</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Iterator<span style="color:#f92672">&lt;</span>PropertyDescriptor<span style="color:#f92672">&gt;</span> it <span style="color:#f92672">=</span> pds<span style="color:#f92672">.</span><span style="color:#a6e22e">iterator</span><span style="color:#f92672">();</span> it<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">();)</span> <span style="color:#f92672">{</span>
        PropertyDescriptor pd <span style="color:#f92672">=</span> it<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isExcludedFromDependencyCheck<span style="color:#f92672">(</span>pd<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            it<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> pds<span style="color:#f92672">.</span><span style="color:#a6e22e">toArray</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PropertyDescriptor<span style="color:#f92672">[</span>pds<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()]);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，最终来自于BeanWrapper。那么BeanWrapper又是从哪里弄来的呢?</p>
<p>BeanWrapperImpl.getPropertyDescriptors:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> PropertyDescriptor<span style="color:#f92672">[]</span> <span style="color:#a6e22e">getPropertyDescriptors</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> getCachedIntrospectionResults<span style="color:#f92672">().</span><span style="color:#a6e22e">getPropertyDescriptors</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">private</span> CachedIntrospectionResults <span style="color:#a6e22e">getCachedIntrospectionResults</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">(</span>getWrappedInstance<span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;BeanWrapper does not hold a bean instance&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cachedIntrospectionResults</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cachedIntrospectionResults</span> <span style="color:#f92672">=</span> CachedIntrospectionResults<span style="color:#f92672">.</span><span style="color:#a6e22e">forClass</span><span style="color:#f92672">(</span>getWrappedClass<span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cachedIntrospectionResults</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>所以，这时BeanWrapper便会把自己&quot;内省&quot;一遍。这从侧面说明@Reqired注解只对setter方法有效。</p>
<h5 id="测试">测试</h5>
<p>有一个bean如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Component</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;simpleBean&#34;</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SimpleBean</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Autowired</span><span style="color:#f92672">(</span>required <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">private</span> Student student<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SimpleBean</span><span style="color:#f92672">()</span> <span style="color:#f92672">{}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SimpleBean</span><span style="color:#f92672">(</span>Student student<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">student</span> <span style="color:#f92672">=</span> student<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">public</span> Student <span style="color:#a6e22e">getStudent</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> student<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#a6e22e">@Required</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setStudent</span><span style="color:#f92672">(</span>Student student<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">student</span> <span style="color:#f92672">=</span> student<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>注意先关闭@Autowire的检测，否则用不到@Required注解便会报错。运行之后的结果:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/required_test.png" alt="@Required测试"></p>
<h3 id="commonannotationbeanpostprocessor-1">CommonAnnotationBeanPostProcessor</h3>
<p>从其类图可以看出，此类主要是整合了MergedBeanDefinitionPostProcessor和DestructionAwareBeanPostProcessor的功能。其功能体现在以下几个方法，按调用顺序进行说明。</p>
<h4 id="postprocessmergedbeandefinition-2">postProcessMergedBeanDefinition</h4>
<p>此方法的执行入口以及调用时机上面已经说过了。其源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">postProcessMergedBeanDefinition</span><span style="color:#f92672">(</span>RootBeanDefinition beanDefinition<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;</span> beanType<span style="color:#f92672">,</span> String 	 beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">postProcessMergedBeanDefinition</span><span style="color:#f92672">(</span>beanDefinition<span style="color:#f92672">,</span> beanType<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanType <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        InjectionMetadata metadata <span style="color:#f92672">=</span> findResourceMetadata<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> beanType<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        metadata<span style="color:#f92672">.</span><span style="color:#a6e22e">checkConfigMembers</span><span style="color:#f92672">(</span>beanDefinition<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="父类">父类</h5>
<p>可以看出，首先调用了其父类InitDestroyAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法，源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">postProcessMergedBeanDefinition</span><span style="color:#f92672">(</span>RootBeanDefinition beanDefinition<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;</span> beanType<span style="color:#f92672">,</span> String 	 beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanType <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        LifecycleMetadata metadata <span style="color:#f92672">=</span> findLifecycleMetadata<span style="color:#f92672">(</span>beanType<span style="color:#f92672">);</span>
        metadata<span style="color:#f92672">.</span><span style="color:#a6e22e">checkConfigMembers</span><span style="color:#f92672">(</span>beanDefinition<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>findLifecycleMetadata的套路和上面运行-AutowiredAnnotationBeanPostProcessor-源码一节中所说完全一样，所不同的是此处是<strong>遍历所有method寻找初始化和销毁方法标记</strong>。这两个标记很有意思，Spring允许我们自定义是哪两个标记(getter/setter方法)。子类CommonAnnotationBeanPostProcessor在构造器中设置了其值:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">CommonAnnotationBeanPostProcessor</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    setInitAnnotationType<span style="color:#f92672">(</span>PostConstruct<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    setDestroyAnnotationType<span style="color:#f92672">(</span>PreDestroy<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这两个标签来自于javax.annotation包。那么怎么自定义呢?</p>
<p>CommonAnnotationBeanPostProcessor本质上是一个BeanPostProcessor，所以我们可以自己注入，配置文件:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;org.springframework.context.annotation.CommonAnnotationBeanPostProcessor&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;initAnnotationType&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;annotation.Init&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div><p>Init是一个很简单的自定义注解:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Retention</span><span style="color:#f92672">(</span>RetentionPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">RUNTIME</span><span style="color:#f92672">)</span>
<span style="color:#a6e22e">@Target</span><span style="color:#f92672">(</span>ElementType<span style="color:#f92672">.</span><span style="color:#a6e22e">METHOD</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@interface</span> Init <span style="color:#f92672">{}</span>
</code></pre></div><p>在自己的bean中使用此注解:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Init</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Init!&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>运行Spring便可以看到效果。</p>
<p>另外注意一点，从前面annotation-config-BeanPostProcessor注册一节的源码中可以看出，<strong>Spring在向容器中添加CommonAnnotationBeanPostProcessor时只是检测其ID(org.springframework.context.annotation.internalCommonAnnotationProcessor)是否存在，这就造成了一个问题: 如果按上面所说的配置，那么在容器中实际上有两个CommonAnnotationProcessor存在，也就是说，@PostConstruct和@PreDestroy注解此时依然被支持</strong>。为了达到只有一个实例的目的，需要为前面的配置加上ID。</p>
<h5 id="子类">子类</h5>
<p>findResourceMetadata的套路还是一样，就是在属性和方法上寻找@Resource标签。</p>
<h4 id="postprocesspropertyvalues-2">postProcessPropertyValues</h4>
<p>源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> PropertyValues <span style="color:#a6e22e">postProcessPropertyValues</span><span style="color:#f92672">(</span>
        PropertyValues pvs<span style="color:#f92672">,</span> PropertyDescriptor<span style="color:#f92672">[]</span> pds<span style="color:#f92672">,</span> Object bean<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    InjectionMetadata metadata <span style="color:#f92672">=</span> findResourceMetadata<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> pvs<span style="color:#f92672">);</span>
    metadata<span style="color:#f92672">.</span><span style="color:#a6e22e">inject</span><span style="color:#f92672">(</span>bean<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> pvs<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> pvs<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>套路很明显了。</p>
<h4 id="postprocessbeforeinitialization">postProcessBeforeInitialization</h4>
<p>实现在父类InitDestroyAnnotationBeanPostProcessor：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">postProcessBeforeInitialization</span><span style="color:#f92672">(</span>Object bean<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    LifecycleMetadata metadata <span style="color:#f92672">=</span> findLifecycleMetadata<span style="color:#f92672">(</span>bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">());</span>
    metadata<span style="color:#f92672">.</span><span style="color:#a6e22e">invokeInitMethods</span><span style="color:#f92672">(</span>bean<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>invokeInitMethods:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invokeInitMethods</span><span style="color:#f92672">(</span>Object target<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Throwable <span style="color:#f92672">{</span>
    Collection<span style="color:#f92672">&lt;</span>LifecycleElement<span style="color:#f92672">&gt;</span> initMethodsToIterate <span style="color:#f92672">=</span>
            <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">checkedInitMethods</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">checkedInitMethods</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">initMethods</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>initMethodsToIterate<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>LifecycleElement element <span style="color:#f92672">:</span> initMethodsToIterate<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
             <span style="color:#75715e">// 反射调用
</span><span style="color:#75715e"></span>            element<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>target<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>不过从源码来看应该支持多个init方法。</p>
<h4 id="postprocessbeforedestruction">postProcessBeforeDestruction</h4>
<p>反射调用销毁方法，没啥说的了。</p>
<h3 id="eventlistenermethodprocessor-1">EventListenerMethodProcessor</h3>
<p>就一个值得关注的方法: afterSingletonsInstantiated。</p>
<h5 id="入口-2">入口</h5>
<p>DefaultListableBeanFactory.preInstantiateSingletons相关源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// Trigger post-initialization callback for all applicable beans...
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String beanName <span style="color:#f92672">:</span> beanNames<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Object singletonInstance <span style="color:#f92672">=</span> getSingleton<span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>singletonInstance <span style="color:#66d9ef">instanceof</span> SmartInitializingSingleton<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> SmartInitializingSingleton smartSingleton <span style="color:#f92672">=</span> 
            <span style="color:#f92672">(</span>SmartInitializingSingleton<span style="color:#f92672">)</span> singletonInstance<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecurityManager</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            AccessController<span style="color:#f92672">.</span><span style="color:#a6e22e">doPrivileged</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PrivilegedAction<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    smartSingleton<span style="color:#f92672">.</span><span style="color:#a6e22e">afterSingletonsInstantiated</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">},</span> getAccessControlContext<span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            smartSingleton<span style="color:#f92672">.</span><span style="color:#a6e22e">afterSingletonsInstantiated</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="源码-1">源码</h5>
<p>略过。</p>
<h1 id="component-scan">component-scan</h1>
<p>ComponentScanBeanDefinitionParser.parse源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> BeanDefinition <span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>Element element<span style="color:#f92672">,</span> ParserContext parserContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// base-package属性
</span><span style="color:#75715e"></span>    String basePackage <span style="color:#f92672">=</span> element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>BASE_PACKAGE_ATTRIBUTE<span style="color:#f92672">);</span>
    <span style="color:#75715e">// 解析占位符
</span><span style="color:#75715e"></span>    basePackage <span style="color:#f92672">=</span> parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getReaderContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getEnvironment</span><span style="color:#f92672">()</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">resolvePlaceholders</span><span style="color:#f92672">(</span>basePackage<span style="color:#f92672">);</span>
    <span style="color:#75715e">//分割成数据
</span><span style="color:#75715e"></span>    String<span style="color:#f92672">[]</span> basePackages <span style="color:#f92672">=</span> StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">tokenizeToStringArray</span><span style="color:#f92672">(</span>basePackage<span style="color:#f92672">,</span>
            ConfigurableApplicationContext<span style="color:#f92672">.</span><span style="color:#a6e22e">CONFIG_LOCATION_DELIMITERS</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">// Actually scan for bean definitions and register them.
</span><span style="color:#75715e"></span>    ClassPathBeanDefinitionScanner scanner <span style="color:#f92672">=</span> configureScanner<span style="color:#f92672">(</span>parserContext<span style="color:#f92672">,</span> element<span style="color:#f92672">);</span>
    Set<span style="color:#f92672">&lt;</span>BeanDefinitionHolder<span style="color:#f92672">&gt;</span> beanDefinitions <span style="color:#f92672">=</span> scanner<span style="color:#f92672">.</span><span style="color:#a6e22e">doScan</span><span style="color:#f92672">(</span>basePackages<span style="color:#f92672">);</span>
    registerComponents<span style="color:#f92672">(</span>parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getReaderContext</span><span style="color:#f92672">(),</span> beanDefinitions<span style="color:#f92672">,</span> element<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="初始化">初始化</h2>
<p>此部分负责初始化包扫描用到的扫描器，是一个ClassPathBeanDefinitionScanner对象，configureScanner方法源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> ClassPathBeanDefinitionScanner <span style="color:#a6e22e">configureScanner</span><span style="color:#f92672">(</span>ParserContext parserContext<span style="color:#f92672">,</span> Element element<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">boolean</span> useDefaultFilters <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>element<span style="color:#f92672">.</span><span style="color:#a6e22e">hasAttribute</span><span style="color:#f92672">(</span>USE_DEFAULT_FILTERS_ATTRIBUTE<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        useDefaultFilters <span style="color:#f92672">=</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>USE_DEFAULT_FILTERS_ATTRIBUTE<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// Delegate bean definition registration to scanner class.
</span><span style="color:#75715e"></span>    ClassPathBeanDefinitionScanner scanner <span style="color:#f92672">=</span> createScanner
        <span style="color:#f92672">(</span>parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getReaderContext</span><span style="color:#f92672">(),</span> useDefaultFilters<span style="color:#f92672">);</span>
    scanner<span style="color:#f92672">.</span><span style="color:#a6e22e">setResourceLoader</span><span style="color:#f92672">(</span>parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getReaderContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getResourceLoader</span><span style="color:#f92672">());</span>
    scanner<span style="color:#f92672">.</span><span style="color:#a6e22e">setEnvironment</span><span style="color:#f92672">(</span>parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getReaderContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getEnvironment</span><span style="color:#f92672">());</span>
    scanner<span style="color:#f92672">.</span><span style="color:#a6e22e">setBeanDefinitionDefaults</span><span style="color:#f92672">(</span>parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getDelegate</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getBeanDefinitionDefaults</span><span style="color:#f92672">());</span>
    scanner<span style="color:#f92672">.</span><span style="color:#a6e22e">setAutowireCandidatePatterns</span><span style="color:#f92672">(</span>parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getDelegate</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAutowireCandidatePatterns</span><span style="color:#f92672">());</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>element<span style="color:#f92672">.</span><span style="color:#a6e22e">hasAttribute</span><span style="color:#f92672">(</span>RESOURCE_PATTERN_ATTRIBUTE<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        scanner<span style="color:#f92672">.</span><span style="color:#a6e22e">setResourcePattern</span><span style="color:#f92672">(</span>element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>RESOURCE_PATTERN_ATTRIBUTE<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
        
    parseBeanNameGenerator<span style="color:#f92672">(</span>element<span style="color:#f92672">,</span> scanner<span style="color:#f92672">);</span>

    parseScope<span style="color:#f92672">(</span>element<span style="color:#f92672">,</span> scanner<span style="color:#f92672">);</span>

    parseTypeFilters<span style="color:#f92672">(</span>element<span style="color:#f92672">,</span> scanner<span style="color:#f92672">,</span> parserContext<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> scanner<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>下面开始按顺序分部分说明。</p>
<h3 id="use-default-filters">use-default-filters</h3>
<p>component-scan注解会默认扫描喜闻乐见的@Component、@Repository、@Service和@Controller四大金刚。如果此属性设为false，那么就不会扫描这几个属性。</p>
<h3 id="扫描器创建--初始化">扫描器:创建 &amp; 初始化</h3>
<p>就是createScanner方法和下面那一坨setter方法，没啥好说的。</p>
<h3 id="resource-pattern">resource-pattern</h3>
<p>用以配置扫描器扫描的路径，默认<code>**/*.class</code>。</p>
<h3 id="name-generator">name-generator</h3>
<p>可以指定命名策略，这个在前面运行-ConfigurationClassPostProcessor-类解析一节中说过。Spring在parseBeanNameGenerator方法会直接使用反射的方法生成其对象。</p>
<h3 id="scope-resolver">scope-resolver</h3>
<p>指定使用的ScopeMetadataResolver。此接口用于解析bean的scope定义，其类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ScopeMetadataResolver.jpg" alt="ScopeMetadataResolver类图"></p>
<p>默认是AnnotationScopeMetadataResolver，也就是解析@Scope标签。</p>
<h3 id="scoped-proxy">scoped-proxy</h3>
<p>此配置的意思应该是是否为检测到的bean生成代理子类，共有三个选项: interfaces, no, targetClasses，默认no。原理应该就像对@Configuration类的处理，Spring自己说是实现proxy style，不知所云。</p>
<h3 id="exclude-filterinclude-filter">exclude-filter/include-filter</h3>
<p>用法示例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;context:component-scan</span> <span style="color:#a6e22e">base-package=</span><span style="color:#e6db74">&#34;base&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;context:exclude-filter</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;annotation&#34;</span> <span style="color:#a6e22e">expression=</span><span style="color:#e6db74">&#34;javax.annotation.Resource&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/context:component-scan&gt;</span>
</code></pre></div><p>parseTypeFilters方法负责此部分的解析，只贴部分源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>INCLUDE_FILTER_ELEMENT<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>localName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    TypeFilter typeFilter <span style="color:#f92672">=</span> createTypeFilter<span style="color:#f92672">((</span>Element<span style="color:#f92672">)</span> node<span style="color:#f92672">,</span> classLoader<span style="color:#f92672">,</span> parserContext<span style="color:#f92672">);</span>
    scanner<span style="color:#f92672">.</span><span style="color:#a6e22e">addIncludeFilter</span><span style="color:#f92672">(</span>typeFilter<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>EXCLUDE_FILTER_ELEMENT<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>localName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    TypeFilter typeFilter <span style="color:#f92672">=</span> createTypeFilter<span style="color:#f92672">((</span>Element<span style="color:#f92672">)</span> node<span style="color:#f92672">,</span> classLoader<span style="color:#f92672">,</span> parserContext<span style="color:#f92672">);</span>
    scanner<span style="color:#f92672">.</span><span style="color:#a6e22e">addExcludeFilter</span><span style="color:#f92672">(</span>typeFilter<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="annotation-config-1">annotation-config</h3>
<p>此属性等同于&lt;context:annotation-config /&gt;配置，默认就是true，也就是说，如果配置了context:component-scan其实就没有必要配置annotation-config 了。</p>
<h2 id="扫描">扫描</h2>
<p>入口方法便是ClassPathBeanDefinitionScanner.doScan:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> Set<span style="color:#f92672">&lt;</span>BeanDefinitionHolder<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">doScan</span><span style="color:#f92672">(</span>String<span style="color:#f92672">...</span> basePackages<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">notEmpty</span><span style="color:#f92672">(</span>basePackages<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;At least one base package must be specified&#34;</span><span style="color:#f92672">);</span>
    Set<span style="color:#f92672">&lt;</span>BeanDefinitionHolder<span style="color:#f92672">&gt;</span> beanDefinitions <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedHashSet<span style="color:#f92672">&lt;</span>BeanDefinitionHolder<span style="color:#f92672">&gt;();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String basePackage <span style="color:#f92672">:</span> basePackages<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
         <span style="color:#75715e">// 逐包扫描
</span><span style="color:#75715e"></span>        Set<span style="color:#f92672">&lt;</span>BeanDefinition<span style="color:#f92672">&gt;</span> candidates <span style="color:#f92672">=</span> findCandidateComponents<span style="color:#f92672">(</span>basePackage<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>BeanDefinition candidate <span style="color:#f92672">:</span> candidates<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            ScopeMetadata scopeMetadata <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scopeMetadataResolver</span><span style="color:#f92672">.</span><span style="color:#a6e22e">resolveScopeMetadata</span><span style="color:#f92672">(</span>candidate<span style="color:#f92672">);</span>
            candidate<span style="color:#f92672">.</span><span style="color:#a6e22e">setScope</span><span style="color:#f92672">(</span>scopeMetadata<span style="color:#f92672">.</span><span style="color:#a6e22e">getScopeName</span><span style="color:#f92672">());</span>
            String beanName <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanNameGenerator</span><span style="color:#f92672">.</span><span style="color:#a6e22e">generateBeanName</span><span style="color:#f92672">(</span>candidate<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registry</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>candidate <span style="color:#66d9ef">instanceof</span> AbstractBeanDefinition<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                 <span style="color:#75715e">// 为BeanDefinition设置默认的属性
</span><span style="color:#75715e"></span>                postProcessBeanDefinition<span style="color:#f92672">((</span>AbstractBeanDefinition<span style="color:#f92672">)</span> candidate<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>candidate <span style="color:#66d9ef">instanceof</span> AnnotatedBeanDefinition<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                AnnotationConfigUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">processCommonDefinitionAnnotations</span>
                    <span style="color:#f92672">((</span>AnnotatedBeanDefinition<span style="color:#f92672">)</span> candidate<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>checkCandidate<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> candidate<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                BeanDefinitionHolder definitionHolder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BeanDefinitionHolder<span style="color:#f92672">(</span>candidate<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
                definitionHolder <span style="color:#f92672">=</span> AnnotationConfigUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">applyScopedProxyMode</span>
                    <span style="color:#f92672">(</span>scopeMetadata<span style="color:#f92672">,</span> definitionHolder<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registry</span><span style="color:#f92672">);</span>
                beanDefinitions<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>definitionHolder<span style="color:#f92672">);</span>
                registerBeanDefinition<span style="color:#f92672">(</span>definitionHolder<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registry</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> beanDefinitions<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="逐包扫描beandefinition解析">逐包扫描/BeanDefinition解析</h3>
<p>扫描其实就是在classpath下直接读取class文件。读取到的class文件被Spring用Resource接口表示。之后交由MetadataReader进行解析，其类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/MetadataReader.jpg" alt="MetadataReader类图"></p>
<p>对class文件的读取、分析是通过ASM完成的，入口在SimpleMetadataReader的构造器:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">SimpleMetadataReader<span style="color:#f92672">(</span>Resource resource<span style="color:#f92672">,</span> ClassLoader classLoader<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
    InputStream is <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedInputStream<span style="color:#f92672">(</span>resource<span style="color:#f92672">.</span><span style="color:#a6e22e">getInputStream</span><span style="color:#f92672">());</span>
    ClassReader classReader<span style="color:#f92672">;</span>
    classReader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClassReader<span style="color:#f92672">(</span>is<span style="color:#f92672">);</span>

    AnnotationMetadataReadingVisitor visitor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AnnotationMetadataReadingVisitor<span style="color:#f92672">(</span>classLoader<span style="color:#f92672">);</span>
    classReader<span style="color:#f92672">.</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">(</span>visitor<span style="color:#f92672">,</span> ClassReader<span style="color:#f92672">.</span><span style="color:#a6e22e">SKIP_DEBUG</span><span style="color:#f92672">);</span>

    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">annotationMetadata</span> <span style="color:#f92672">=</span> visitor<span style="color:#f92672">;</span>
    <span style="color:#75715e">// (since AnnotationMetadataReadingVisitor extends ClassMetadataReadingVisitor)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">classMetadata</span> <span style="color:#f92672">=</span> visitor<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">resource</span> <span style="color:#f92672">=</span> resource<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>解析的关键便在于AnnotationMetadataReadingVisitor，其类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/AnnotationMetadataReadingVisitor.jpg" alt="AnnotationMetadataReadingVisitor类图"></p>
<p>核心在于其visitAnnotation方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> AnnotationVisitor <span style="color:#a6e22e">visitAnnotation</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String desc<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> visible<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String className <span style="color:#f92672">=</span> Type<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">(</span>desc<span style="color:#f92672">).</span><span style="color:#a6e22e">getClassName</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">annotationSet</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>className<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> AnnotationAttributesReadingVisitor<span style="color:#f92672">(</span>
        className<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">attributesMap</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metaAnnotationMap</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">classLoader</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>返回一个AnnotationVisitor表示对此注解的属性感兴趣，用于解析其属性。最终得到的BeanDefinition集合是ScannedGenericBeanDefinition类型，其类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ScannedGenericBeanDefinition.jpg" alt="ScannedGenericBeanDefinition类图"></p>
<h3 id="scope解析">@Scope解析</h3>
<p>AnnotationScopeMetadataResolver.resolveScopeMetadata:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> ScopeMetadata <span style="color:#a6e22e">resolveScopeMetadata</span><span style="color:#f92672">(</span>BeanDefinition definition<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ScopeMetadata metadata <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ScopeMetadata<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>definition <span style="color:#66d9ef">instanceof</span> AnnotatedBeanDefinition<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        AnnotatedBeanDefinition annDef <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>AnnotatedBeanDefinition<span style="color:#f92672">)</span> definition<span style="color:#f92672">;</span>
         <span style="color:#75715e">// 寻找Scope相关的属性，AnnotationAttributes是LinkedHashMap的子类
</span><span style="color:#75715e"></span>        AnnotationAttributes attributes <span style="color:#f92672">=</span> AnnotationConfigUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">attributesFor</span><span style="color:#f92672">(</span>
                annDef<span style="color:#f92672">.</span><span style="color:#a6e22e">getMetadata</span><span style="color:#f92672">(),</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scopeAnnotationType</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>attributes <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
             <span style="color:#75715e">// @Scope值
</span><span style="color:#75715e"></span>            metadata<span style="color:#f92672">.</span><span style="color:#a6e22e">setScopeName</span><span style="color:#f92672">(</span>attributes<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">));</span>
            ScopedProxyMode proxyMode <span style="color:#f92672">=</span> attributes<span style="color:#f92672">.</span><span style="color:#a6e22e">getEnum</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;proxyMode&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>proxyMode <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> proxyMode <span style="color:#f92672">==</span> ScopedProxyMode<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                proxyMode <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultProxyMode</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            metadata<span style="color:#f92672">.</span><span style="color:#a6e22e">setScopedProxyMode</span><span style="color:#f92672">(</span>proxyMode<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> metadata<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>proxyMode和xml的scoped-proxy属性是一个概念:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Scope</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;singleton&#34;</span><span style="color:#f92672">,</span> proxyMode <span style="color:#f92672">=</span> ScopedProxyMode<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT</span><span style="color:#f92672">)</span>
</code></pre></div><p><strong>XML的属性是全局的配置，这个是局部(针对单个bean)的配置</strong>，和XML属性相比对了一个default选项，这个就表示使用XML属性的配置。</p>
<h3 id="bean名字生成">bean名字生成</h3>
<p>AnnotationBeanNameGenerator.generateBeanName:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">generateBeanName</span><span style="color:#f92672">(</span>BeanDefinition definition<span style="color:#f92672">,</span> BeanDefinitionRegistry registry<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>definition <span style="color:#66d9ef">instanceof</span> AnnotatedBeanDefinition<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        String beanName <span style="color:#f92672">=</span> determineBeanNameFromAnnotation<span style="color:#f92672">((</span>AnnotatedBeanDefinition<span style="color:#f92672">)</span> definition<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasText</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Explicit bean name found.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> beanName<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// Fallback: generate a unique default bean name.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> buildDefaultBeanName<span style="color:#f92672">(</span>definition<span style="color:#f92672">,</span> registry<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="根据注解">根据注解</h4>
<p>默认会首先尝试根据@Component、@Service、@Controller、@Repository、@ManagedBean、@Named的value属性生成，determineBeanNameFromAnnotation:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">determineBeanNameFromAnnotation</span><span style="color:#f92672">(</span>AnnotatedBeanDefinition annotatedDef<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    AnnotationMetadata amd <span style="color:#f92672">=</span> annotatedDef<span style="color:#f92672">.</span><span style="color:#a6e22e">getMetadata</span><span style="color:#f92672">();</span>
    Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> types <span style="color:#f92672">=</span> amd<span style="color:#f92672">.</span><span style="color:#a6e22e">getAnnotationTypes</span><span style="color:#f92672">();</span>
    String beanName <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
     <span style="color:#75715e">// 遍历当前bean拥有的所有类级注解
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String type <span style="color:#f92672">:</span> types<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
         <span style="color:#75715e">// 获取此注解所有的属性
</span><span style="color:#75715e"></span>        AnnotationAttributes attributes <span style="color:#f92672">=</span> AnnotationConfigUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">attributesFor</span><span style="color:#f92672">(</span>amd<span style="color:#f92672">,</span> type<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isStereotypeWithNameValue<span style="color:#f92672">(</span>type<span style="color:#f92672">,</span> amd<span style="color:#f92672">.</span><span style="color:#a6e22e">getMetaAnnotationTypes</span><span style="color:#f92672">(</span>type<span style="color:#f92672">),</span> attributes<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            Object value <span style="color:#f92672">=</span> attributes<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>value <span style="color:#66d9ef">instanceof</span> String<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                String strVal <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>String<span style="color:#f92672">)</span> value<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasLength</span><span style="color:#f92672">(</span>strVal<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanName <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>strVal<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                    beanName <span style="color:#f92672">=</span> strVal<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> beanName<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>isStereotypeWithNameValue方法用于判断此注解是否可以用来生成beanName，比如@Scope便不适合:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isStereotypeWithNameValue</span><span style="color:#f92672">(</span>String annotationType<span style="color:#f92672">,</span>
        Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> metaAnnotationTypes<span style="color:#f92672">,</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> attributes<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// org.springframework.stereotype.Component
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> isStereotype <span style="color:#f92672">=</span> annotationType<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>COMPONENT_ANNOTATION_CLASSNAME<span style="color:#f92672">)</span> <span style="color:#f92672">||</span>
        <span style="color:#f92672">(</span>metaAnnotationTypes <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> metaAnnotationTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>COMPONENT_ANNOTATION_CLASSNAME<span style="color:#f92672">))</span> <span style="color:#f92672">||</span>
        annotationType<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;javax.annotation.ManagedBean&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span>
        annotationType<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;javax.inject.Named&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>isStereotype <span style="color:#f92672">&amp;&amp;</span> attributes <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> attributes<span style="color:#f92672">.</span><span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>metaAnnotationTypes用以判断元注解，针对这种情况:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Component</span>
<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@interface</span> Controller <span style="color:#f92672">{}</span>
</code></pre></div><p>可以看出，判断是否可以用来生成名字的依据便是注解类型是否在上面提到的6种之列并且value属性不为空。</p>
<h4 id="默认策略">默认策略</h4>
<p>如果上面提到的条件不满足，那么便会用默认策略生成beanName，buildDefaultBeanName：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">buildDefaultBeanName</span><span style="color:#f92672">(</span>BeanDefinition definition<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// base.SimpleBean -&gt; SimpleBean
</span><span style="color:#75715e"></span>    String shortClassName <span style="color:#f92672">=</span> ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getShortName</span><span style="color:#f92672">(</span>definition<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanClassName</span><span style="color:#f92672">());</span>
    <span style="color:#75715e">//SimpleBean -&gt; simpleBean
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> Introspector<span style="color:#f92672">.</span><span style="color:#a6e22e">decapitalize</span><span style="color:#f92672">(</span>shortClassName<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>注意，对于内部类: OuterClassName.InnerClassName -&gt; outerClassName.InnerClassName.</p>
<h3 id="其它注解解析">其它注解解析</h3>
<p>入口在AnnotationConfigUtils.processCommonDefinitionAnnotations，其它指的是这几个:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Lazy</span>
<span style="color:#a6e22e">@Primary</span>
<span style="color:#a6e22e">@DependsOn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;student&#34;</span><span style="color:#f92672">)</span>
<span style="color:#a6e22e">@Role</span><span style="color:#f92672">(</span>BeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">ROLE_APPLICATION</span><span style="color:#f92672">)</span>
<span style="color:#a6e22e">@Description</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;This is a simple bean.&#34;</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SimpleBean</span> <span style="color:#f92672">{}</span>
</code></pre></div><p>这里面就是@Role没见过，默认就是上面那个值，Spring说这是一个&quot;hint&quot;，可能没啥卵用，希望不要被打脸。解析之后设置到BeanDefinition，没啥好说的。</p>
<h3 id="冲突检测">冲突检测</h3>
<p>Spring会检测容器中是否已经存在同名的BeanDefinition。ClassPathBeanDefinitionScanner.checkCandidate:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">checkCandidate</span><span style="color:#f92672">(</span>String beanName<span style="color:#f92672">,</span> BeanDefinition beanDefinition<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 没有同名的，直接返回
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registry</span><span style="color:#f92672">.</span><span style="color:#a6e22e">containsBeanDefinition</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    BeanDefinition existingDef <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registry</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanDefinition</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
    BeanDefinition originatingDef <span style="color:#f92672">=</span> existingDef<span style="color:#f92672">.</span><span style="color:#a6e22e">getOriginatingBeanDefinition</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>originatingDef <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        existingDef <span style="color:#f92672">=</span> originatingDef<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isCompatible<span style="color:#f92672">(</span>beanDefinition<span style="color:#f92672">,</span> existingDef<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ConflictingBeanDefinitionException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;冲突啦!&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>isCompatible用于判断和之前的BeanDefinition是否兼容:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isCompatible</span><span style="color:#f92672">(</span>BeanDefinition newDefinition<span style="color:#f92672">,</span> BeanDefinition existingDefinition<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//// explicitly registered overriding bean
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(!(</span>existingDefinition <span style="color:#66d9ef">instanceof</span> ScannedGenericBeanDefinition<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> 
            <span style="color:#75715e">//// scanned same file twice
</span><span style="color:#75715e"></span>            newDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">getSource</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>existingDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">getSource</span><span style="color:#f92672">())</span> <span style="color:#f92672">||</span> 
            <span style="color:#75715e">// scanned equivalent class twice			
</span><span style="color:#75715e"></span>            newDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>existingDefinition<span style="color:#f92672">));</span>  
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，<strong>如果已经存在的BeanDefinition不是扫描来的，如果是由同一个class文件解析来的，如果两者equals，Spring都认为是兼容的，即Spring会用新的替换之前的。</strong></p>
<h3 id="代理生成">代理生成</h3>
<p>入口: ClassPathBeanDefinitionScanner.doScan:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">BeanDefinitionHolder definitionHolder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BeanDefinitionHolder<span style="color:#f92672">(</span>candidate<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
definitionHolder <span style="color:#f92672">=</span> AnnotationConfigUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">applyScopedProxyMode</span><span style="color:#f92672">(</span>scopeMetadata<span style="color:#f92672">,</span> definitionHolder<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registry</span><span style="color:#f92672">);</span>
</code></pre></div><p>AnnotationConfigUtils.applyScopedProxyMode:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">static</span> BeanDefinitionHolder <span style="color:#a6e22e">applyScopedProxyMode</span><span style="color:#f92672">(</span>
        ScopeMetadata metadata<span style="color:#f92672">,</span> BeanDefinitionHolder definition<span style="color:#f92672">,</span> BeanDefinitionRegistry registry<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ScopedProxyMode scopedProxyMode <span style="color:#f92672">=</span> metadata<span style="color:#f92672">.</span><span style="color:#a6e22e">getScopedProxyMode</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// 基本都是从这里跑了
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>scopedProxyMode<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>ScopedProxyMode<span style="color:#f92672">.</span><span style="color:#a6e22e">NO</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> definition<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">boolean</span> proxyTargetClass <span style="color:#f92672">=</span> scopedProxyMode<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>ScopedProxyMode<span style="color:#f92672">.</span><span style="color:#a6e22e">TARGET_CLASS</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> ScopedProxyCreator<span style="color:#f92672">.</span><span style="color:#a6e22e">createScopedProxy</span><span style="color:#f92672">(</span>definition<span style="color:#f92672">,</span> registry<span style="color:#f92672">,</span> proxyTargetClass<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>最终调用的是ScopedProxyUtils.createScopedProxy，源码很多，这里说下重点:</p>
<ul>
<li>这里所做的是生成了一个新的BeanDefinition对象，作为代理者，其属性拷贝自被代理者，代理者的beanClass为ScopedProxyFactoryBean，代理者的名字设置为被代理者的名字，而被代理者的名字改为scopedTarget.原名字，代理者内部有一个targetBeanName属性，就是被代理者的名字。</li>
<li>被代理者的autowireCandidate和primary属性被设为false，不能再当作其它bean的注入候选者。</li>
<li>将被代理者以scopedTarget.原名字注册到容器，返回代理者。</li>
<li>代理者和被代理者同时存在于容器中。</li>
</ul>
<p>可以看出，这其实是一个偷天换日的过程。</p>
<p>做个实验:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Boostrap</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ClassPathXmlApplicationContext context <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClassPathXmlApplicationContext<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;config.xml&#34;</span><span style="color:#f92672">);</span>
        SimpleBean bean <span style="color:#f92672">=</span> SimpleBean<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cast</span><span style="color:#f92672">(</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>SimpleBean<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">));</span>
         System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
         context<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>SimpleBean已开启代理，输出的结果:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">base.SimpleBean$$EnhancerBySpringCGLIB$$27256c61
</code></pre></div><p>那么问题来了，对于以class寻找的方式，必定会找到两个，那么怎么做出选择呢?</p>
<p>DefaultListableBeanFactory.getBean(Class<!-- raw HTML omitted --> requiredType, Object&hellip; args)部分源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">String<span style="color:#f92672">[]</span> beanNames <span style="color:#f92672">=</span> getBeanNamesForType<span style="color:#f92672">(</span>requiredType<span style="color:#f92672">);</span>
<span style="color:#75715e">//不止一个满足条件(代理者和被代理者)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanNames<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ArrayList<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> autowireCandidates <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String beanName <span style="color:#f92672">:</span> beanNames<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
         <span style="color:#75715e">// here
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>containsBeanDefinition<span style="color:#f92672">(</span>beanName<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> getBeanDefinition<span style="color:#f92672">(</span>beanName<span style="color:#f92672">).</span><span style="color:#a6e22e">isAutowireCandidate</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            autowireCandidates<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>autowireCandidates<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        beanNames <span style="color:#f92672">=</span> autowireCandidates<span style="color:#f92672">.</span><span style="color:#a6e22e">toArray</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">[</span>autowireCandidates<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()]);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，是上面提到过的autowireCandidate设为了false的缘故导致了被代理者被pass。</p>
<h3 id="beandefinition注册">BeanDefinition注册</h3>
<p>你懂的。</p>
<h2 id="component注册">Component注册</h2>
<p>套路和annotation-config-逻辑关系整理一节完全一样，不再赘述。</p>
<h1 id="property-override">property-override</h1>
<h2 id="作用">作用</h2>
<p>允许我们使用属性文件(.properties)的形式对bean的属性进行替换。下面是一个简单的demo:</p>
<p>定义如下的属性文件(property.properties):</p>
<pre><code class="language-properties" data-lang="properties">student.name=dog
</code></pre><p>格式为: bean名字.属性名字=值。由如下的bean:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;student&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.Student&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;name&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;skywalker&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;age&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;30&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div><p>进行如下的配置:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;context:property-override</span> <span style="color:#a6e22e">location=</span><span style="color:#e6db74">&#34;property.properties&#34;</span> <span style="color:#f92672">/&gt;</span>
</code></pre></div><p>运行如下的代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ClassPathXmlApplicationContext context <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClassPathXmlApplicationContext<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;config.xml&#34;</span><span style="color:#f92672">);</span>
    SimpleBean bean <span style="color:#f92672">=</span> SimpleBean<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cast</span><span style="color:#f92672">(</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>SimpleBean<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">));</span>
    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getStudent</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
    context<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>打印的便是dog，而不是skywalker。</p>
<h2 id="类图">类图</h2>
<p>具体的实现类是PropertyOverrideBeanDefinitionParser，其类图如下:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/PropertyOverrideBeanDefinitionParser.jpg" alt="PropertyOverrideBeanDefinitionParser类图"></p>
<h2 id="解析">解析</h2>
<p>解析的原理是将此配置相关的信息保存到BeanDefinition中，更准确的说是一个GenericBeanDefinition。解析的源码:</p>
<p>AbstractPropertyLoadingBeanDefinitionParser.doParse:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doParse</span><span style="color:#f92672">(</span>Element element<span style="color:#f92672">,</span> BeanDefinitionBuilder builder<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String location <span style="color:#f92672">=</span> element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;location&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasLength</span><span style="color:#f92672">(</span>location<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        String<span style="color:#f92672">[]</span> locations <span style="color:#f92672">=</span> StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">commaDelimitedListToStringArray</span><span style="color:#f92672">(</span>location<span style="color:#f92672">);</span>
        builder<span style="color:#f92672">.</span><span style="color:#a6e22e">addPropertyValue</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;locations&#34;</span><span style="color:#f92672">,</span> locations<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    String propertiesRef <span style="color:#f92672">=</span> element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;properties-ref&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasLength</span><span style="color:#f92672">(</span>propertiesRef<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        builder<span style="color:#f92672">.</span><span style="color:#a6e22e">addPropertyReference</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;properties&#34;</span><span style="color:#f92672">,</span> propertiesRef<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    String fileEncoding <span style="color:#f92672">=</span> element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;file-encoding&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasLength</span><span style="color:#f92672">(</span>fileEncoding<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        builder<span style="color:#f92672">.</span><span style="color:#a6e22e">addPropertyValue</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;fileEncoding&#34;</span><span style="color:#f92672">,</span> fileEncoding<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    String order <span style="color:#f92672">=</span> element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;order&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasLength</span><span style="color:#f92672">(</span>order<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        builder<span style="color:#f92672">.</span><span style="color:#a6e22e">addPropertyValue</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;order&#34;</span><span style="color:#f92672">,</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>order<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
    builder<span style="color:#f92672">.</span><span style="color:#a6e22e">addPropertyValue</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ignoreResourceNotFound&#34;</span><span style="color:#f92672">,</span>
            Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ignore-resource-not-found&#34;</span><span style="color:#f92672">)));</span>
    builder<span style="color:#f92672">.</span><span style="color:#a6e22e">addPropertyValue</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;localOverride&#34;</span><span style="color:#f92672">,</span>
            Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;local-override&#34;</span><span style="color:#f92672">)));</span>
    builder<span style="color:#f92672">.</span><span style="color:#a6e22e">setRole</span><span style="color:#f92672">(</span>BeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">ROLE_INFRASTRUCTURE</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="properties-ref">properties-ref</h3>
<p>此属性允许我们直接引用一个java.util.Properties类型的bean作为数据源，示例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;context:property-override</span>  <span style="color:#a6e22e">properties-ref=</span><span style="color:#e6db74">&#34;property&#34;</span> <span style="color:#f92672">/&gt;</span>
    
<span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;property&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;java.util.Properties&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;constructor-arg&gt;</span>
        <span style="color:#f92672">&lt;props&gt;</span>
            <span style="color:#f92672">&lt;prop</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;student.name&#34;</span><span style="color:#f92672">&gt;</span>cat<span style="color:#f92672">&lt;/prop&gt;</span>
        <span style="color:#f92672">&lt;/props&gt;</span>
    <span style="color:#f92672">&lt;/constructor-arg&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div><p>这样便可以看到结果。</p>
<h3 id="order">order</h3>
<p>此属性用以指定其优先级，假设配置了多个context:property-override并且里面有相同的字段，那么将依赖order决定结果。</p>
<h3 id="ignore-resource-not-found">ignore-resource-not-found</h3>
<p>如果设为true，那么对于没有找到的属性文件将会忽略，否则会抛出异常，默认为false，抛异常。</p>
<h3 id="ignore-unresolvable">ignore-unresolvable</h3>
<p>如果设为true，那么对于没有找到对应的key将会忽略，否则抛出异常，默认false。</p>
<h3 id="local-override">local-override</h3>
<p>这个属性让我很迷惑。Spring说是此选项决定&quot;local&quot;的属性是否可以覆盖属性文件中的值。正如下面说的，实际上属性文件被解析到了PropertyOverrideConfigurer对象，其父类PropertiesLoaderSupport有一个字段:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> Properties<span style="color:#f92672">[]</span> localProperties<span style="color:#f92672">;</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * Set local properties, e.g. via the &#34;props&#34; tag in XML bean definitions.
</span><span style="color:#75715e"> * These can be considered defaults, to be overridden by properties
</span><span style="color:#75715e"> * loaded from files.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setProperties</span><span style="color:#f92672">(</span>Properties properties<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">localProperties</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Properties<span style="color:#f92672">[]</span> <span style="color:#f92672">{</span>properties<span style="color:#f92672">};</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，这应该就是Spring所说的&quot;local&quot;属性。好，我们来注入一下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;context:property-override</span>  <span style="color:#a6e22e">location=</span><span style="color:#e6db74">&#34;property.properties&#34;</span> <span style="color:#a6e22e">local-override=</span><span style="color:#e6db74">&#34;false&#34;</span> <span style="color:#f92672">/&gt;</span>

<span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;org.springframework.beans.factory.config.PropertyOverrideConfigurer&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;properties&#34;</span><span style="color:#f92672">&gt;</span>
        <span style="color:#f92672">&lt;array&gt;</span>
            <span style="color:#f92672">&lt;props&gt;</span>
                <span style="color:#f92672">&lt;prop</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;student.name&#34;</span><span style="color:#f92672">&gt;</span>cat<span style="color:#f92672">&lt;/prop&gt;</span>
            <span style="color:#f92672">&lt;/props&gt;</span>
        <span style="color:#f92672">&lt;/array&gt;</span>
    <span style="color:#f92672">&lt;/property&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div><p>然而Spring在注册PropertyOverrideConfigurer的时候根本没有检查容器中是否已经有此类型的BeanDefinition存在，这就导致容器中会同时存在两个!在此种情况下local-override根本没什么卵用，因为后面的PropertyOverrideConfigurer始终会覆盖前一个，local-override是针对一个PropertyOverrideConfigurer来说的，那么问题来了，除此之外如何通过XML向&quot;local&quot;注入?(context:property-override不允许子标签存在)</p>
<h3 id="beandefinition">BeanDefinition</h3>
<p>保存的BeanDefinition的beanClass为PropertyOverrideConfigurer，其类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/PropertyOverrideConfigurer.jpg" alt="PropertyOverrideConfigurer类图"></p>
<h2 id="运行-1">运行</h2>
<p>入口当然是BeanFactoryPostProcessor.postProcessBeanFactory(PropertyResourceConfigurer):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">postProcessBeanFactory</span><span style="color:#f92672">(</span>ConfigurableListableBeanFactory beanFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
         <span style="color:#75715e">// 属性加载
</span><span style="color:#75715e"></span>        Properties mergedProps <span style="color:#f92672">=</span> mergeProperties<span style="color:#f92672">();</span>

        <span style="color:#75715e">// Convert the merged properties, if necessary.
</span><span style="color:#75715e"></span>        convertProperties<span style="color:#f92672">(</span>mergedProps<span style="color:#f92672">);</span>

        <span style="color:#75715e">// Let the subclass process the properties.
</span><span style="color:#75715e"></span>        processProperties<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">,</span> mergedProps<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BeanInitializationException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Could not load properties&#34;</span><span style="color:#f92672">,</span> ex<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="属性加载">属性加载</h3>
<p>PropertiesLoaderSupport.mergeProperties:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> Properties <span style="color:#a6e22e">mergeProperties</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
    Properties result <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Properties<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">localOverride</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Load properties from file upfront, to let local properties override.
</span><span style="color:#75715e"></span>        loadProperties<span style="color:#f92672">(</span>result<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">localProperties</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Properties localProp <span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">localProperties</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            CollectionUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">mergePropertiesIntoMap</span><span style="color:#f92672">(</span>localProp<span style="color:#f92672">,</span> result<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">localOverride</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Load properties from file afterwards, to let those properties override.
</span><span style="color:#75715e"></span>        loadProperties<span style="color:#f92672">(</span>result<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，对local-override的支持是通过改变local和文件两者的加载顺序来实现的。</p>
<h3 id="属性转换">属性转换</h3>
<p>convertProperties是个空实现，因为这里并不需要，在bean实际生成的时候才会转换。</p>
<h3 id="属性设置">属性设置</h3>
<p>就是逐个属性调用PropertyOverrideConfigurer.applyPropertyValue:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">applyPropertyValue</span><span style="color:#f92672">(</span>
        ConfigurableListableBeanFactory factory<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">,</span> String property<span style="color:#f92672">,</span> String value<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

    BeanDefinition bd <span style="color:#f92672">=</span> factory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanDefinition</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>bd<span style="color:#f92672">.</span><span style="color:#a6e22e">getOriginatingBeanDefinition</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        bd <span style="color:#f92672">=</span> bd<span style="color:#f92672">.</span><span style="color:#a6e22e">getOriginatingBeanDefinition</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    PropertyValue pv <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PropertyValue<span style="color:#f92672">(</span>property<span style="color:#f92672">,</span> value<span style="color:#f92672">);</span>
    pv<span style="color:#f92672">.</span><span style="color:#a6e22e">setOptional</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ignoreInvalidKeys</span><span style="color:#f92672">);</span>
    bd<span style="color:#f92672">.</span><span style="color:#a6e22e">getPropertyValues</span><span style="color:#f92672">().</span><span style="color:#a6e22e">addPropertyValue</span><span style="color:#f92672">(</span>pv<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>addPropertyValue会遍历PropertyValue链表，找到name相同的进行value替换。</p>
<h1 id="property-placeholder">property-placeholder</h1>
<p>这个怎么用已经喜闻乐见了</p>
<h2 id="解析-1">解析</h2>
<p>解析的实现类是PropertyPlaceholderBeanDefinitionParser，此类的父类继承体系和property-override的PropertyOverrideBeanDefinitionParser完全一样，所以整体的处理套路也是基本一致。为什么会一致呢，查看此配置拥有的属性就会发现，和property-override很多都是一样的，所以这里只对不一样的而进行说明。</p>
<p>PropertyPlaceholderBeanDefinitionParser.doParse:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doParse</span><span style="color:#f92672">(</span>Element element<span style="color:#f92672">,</span> BeanDefinitionBuilder builder<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">doParse</span><span style="color:#f92672">(</span>element<span style="color:#f92672">,</span> builder<span style="color:#f92672">);</span>
    builder<span style="color:#f92672">.</span><span style="color:#a6e22e">addPropertyValue</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ignoreUnresolvablePlaceholders&#34;</span><span style="color:#f92672">,</span>
            Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ignore-unresolvable&#34;</span><span style="color:#f92672">)));</span>
    String systemPropertiesModeName <span style="color:#f92672">=</span> element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>SYSTEM_PROPERTIES_MODE_ATTRIBUTE<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasLength</span><span style="color:#f92672">(</span>systemPropertiesModeName<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
            <span style="color:#f92672">!</span>systemPropertiesModeName<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>SYSTEM_PROPERTIES_MODE_DEFAULT<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        builder<span style="color:#f92672">.</span><span style="color:#a6e22e">addPropertyValue</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;systemPropertiesModeName&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;SYSTEM_PROPERTIES_MODE_&#34;</span>
            <span style="color:#f92672">+</span> systemPropertiesModeName<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>element<span style="color:#f92672">.</span><span style="color:#a6e22e">hasAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value-separator&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        builder<span style="color:#f92672">.</span><span style="color:#a6e22e">addPropertyValue</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;valueSeparator&#34;</span><span style="color:#f92672">,</span> element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value-separator&#34;</span><span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>element<span style="color:#f92672">.</span><span style="color:#a6e22e">hasAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;trim-values&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        builder<span style="color:#f92672">.</span><span style="color:#a6e22e">addPropertyValue</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;trimValues&#34;</span><span style="color:#f92672">,</span> element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;trim-values&#34;</span><span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>element<span style="color:#f92672">.</span><span style="color:#a6e22e">hasAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;null-value&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        builder<span style="color:#f92672">.</span><span style="color:#a6e22e">addPropertyValue</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;nullValue&#34;</span><span style="color:#f92672">,</span> element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;null-value&#34;</span><span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="system-properties-mode">system-properties-mode</h3>
<p>Spring会将java的System.getProperties也当做属性的来源，此配置用于设置系统的和本地文件的同名属性的覆盖方式(谁覆盖谁)，自己看文档去。</p>
<h3 id="value-separator">value-separator</h3>
<p>用于配置默认的值的分隔符:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;student&#34;</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;base.Student&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;name&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;${student.name:skywalker}&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/bean&gt;</span>
</code></pre></div><p>如果属性文件里没有student.name，那么就是skywalker。默认就是:。</p>
<h3 id="null-value">null-value</h3>
<p>遇到哪些值应该当做空处理，比如可以把空串&quot;&ldquo;设为这个，默认不对任何值进行处理。</p>
<h3 id="trim-values">trim-values</h3>
<p>是否移除开头和结尾的空格，按理说应该是布尔值，但是Spring没有提供可以选择的值，经过测试发现设为true或是false都会把空格干掉，不知道什么鬼。</p>
<h3 id="beandefinition-1">BeanDefinition</h3>
<p>这次是PropertySourcesPlaceholderConfigurer，其类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/PropertySourcesPlaceholderConfigurer.jpg" alt="PropertySourcesPlaceholderConfigurer类图"></p>
<h2 id="运行-2">运行</h2>
<p>PropertySourcesPlaceholderConfigurer.postProcessBeanFactory：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">postProcessBeanFactory</span><span style="color:#f92672">(</span>ConfigurableListableBeanFactory beanFactory<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> BeansException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">propertySources</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">propertySources</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MutablePropertySources<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">environment</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">propertySources</span><span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span>
                <span style="color:#66d9ef">new</span> PropertySource<span style="color:#f92672">&lt;</span>Environment<span style="color:#f92672">&gt;(</span>ENVIRONMENT_PROPERTIES_PROPERTY_SOURCE_NAME<span style="color:#f92672">,</span> 
                    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">environment</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#a6e22e">@Override</span>
                    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span>String key<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">source</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        PropertySource<span style="color:#f92672">&lt;?&gt;</span> localPropertySource <span style="color:#f92672">=</span>
                <span style="color:#66d9ef">new</span> PropertiesPropertySource<span style="color:#f92672">(</span>LOCAL_PROPERTIES_PROPERTY_SOURCE_NAME<span style="color:#f92672">,</span> mergeProperties<span style="color:#f92672">());</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">localOverride</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">propertySources</span><span style="color:#f92672">.</span><span style="color:#a6e22e">addFirst</span><span style="color:#f92672">(</span>localPropertySource<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">propertySources</span><span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span>localPropertySource<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    processProperties<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> PropertySourcesPropertyResolver<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">propertySources</span><span style="color:#f92672">));</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">appliedPropertySources</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">propertySources</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>从源码中可以看出，如果其内部的propertySources属性不为空(当然默认是空)，那么属性文件和系统属性都会被忽略。它的使用场景应该是这样:</p>
<p>不使用property-placeholder标签，以显式的bean定义代替。</p>
<h3 id="处理">处理</h3>
<p>处理的过程就是遍历全部BeanDefinition，替换${}，不再详细进行详细说明。</p>
<h1 id="load-time-weaver--spring-configured">load-time-weaver &amp; spring-configured</h1>
<p>这两个配置是紧密相关的，所以在一起说了。</p>
<p>load-time-weaver用以开启aspectj类加载期织入，实际上是利用jdk1.6提供的instrument API实现的，原理就是jvm会在类加载之前将class暴露给我们制定的类，允许我们在此时对类进行修改。aspectj便利用此机会根据我们的配置生成对应的满足需求的子类。</p>
<p>可以参考:</p>
<p><a href="http://sexycoding.iteye.com/blog/1062372">Spring之LoadTimeWeaver——一个需求引发的思考</a></p>
<p><a href="http://www.iteye.com/topic/481813">Spring LoadTimeWeaver 的那些事儿</a></p>
<h2 id="javaagent">javaagent</h2>
<p>要想使用此功能需要配置jvm参数javaagent指定代理类的jar包，示例:</p>
<p>-javaagent:D:\Software\maven-repos\org\springframework\spring-agent\2.5.6.SEC03\spring-agent-2.5.6.SEC03.jar</p>
<p>此jar包的META-INF/MANIFEST.MF文件需要配置如下一行:</p>
<p>Premain-Class: org.springframework.instrument.InstrumentationSavingAge
nt</p>
<p>Spring的这个jar包只有这一个类，premain方法便是jvm调用的入口，方法参数是固定的。源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InstrumentationSavingAgent</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">volatile</span> Instrumentation instrumentation<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">premain</span><span style="color:#f92672">(</span>String agentArgs<span style="color:#f92672">,</span> Instrumentation inst<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        instrumentation <span style="color:#f92672">=</span> inst<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Instrumentation <span style="color:#a6e22e">getInstrumentation</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> instrumentation<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>	
</code></pre></div><p>所以，Spring在这里把Instrumentation给暴露了出来，供其它的类使用。</p>
<h2 id="解析-2">解析</h2>
<p>解析的实现类是LoadTimeWeaverBeanDefinitionParser，其继承体系和property-override的PropertyOverrideBeanDefinitionParser类似。</p>
<h3 id="loadtimeweaver">LoadTimeWeaver</h3>
<p>此接口用于向ClassLoader添加ClassFileTransformer对象，其继承体系:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/LoadTimeWeaver.jpg" alt="LoadTimeWeaver继承体系"></p>
<p>LoadTimeWeaverBeanDefinitionParser的父类初始化了一个DefaultContextLoadTimeWeaver类型的BeanDefinition放入容器，类型的决定位于LoadTimeWeaverBeanDefinitionParser.getBeanClassName:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">getBeanClassName</span><span style="color:#f92672">(</span>Element element<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 如果配置了weaver-class属性，那么使用其值
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>element<span style="color:#f92672">.</span><span style="color:#a6e22e">hasAttribute</span><span style="color:#f92672">(</span>WEAVER_CLASS_ATTRIBUTE<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>WEAVER_CLASS_ATTRIBUTE<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// org.springframework.context.weaving.DefaultContextLoadTimeWeaver
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> DEFAULT_LOAD_TIME_WEAVER_CLASS_NAME<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>那么这个BeanDefinition的id/name又是什么呢?</p>
<p>LoadTimeWeaverBeanDefinitionParser.resolveId:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">resolveId</span><span style="color:#f92672">(</span>Element element<span style="color:#f92672">,</span> AbstractBeanDefinition definition<span style="color:#f92672">,</span> ParserContext 	parserContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// loadTimeWeaver
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> ConfigurableApplicationContext<span style="color:#f92672">.</span><span style="color:#a6e22e">LOAD_TIME_WEAVER_BEAN_NAME</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>DefaultContextLoadTimeWeaver其实是个包装类，包装了真正的LoadTimeWeaver，使用这层包装的目的就是可以根据外部环境(服务器代理或是Spring自己的代理)确定内部LoadTimeWeaver的实现，具体参见后面运行-BeanClassLoaderAware-setBeanClassLoadery一节。</p>
<h3 id="loadtimeweaverbeandefinitionparser">LoadTimeWeaverBeanDefinitionParser</h3>
<p>LoadTimeWeaverBeanDefinitionParser.doParse:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doParse</span><span style="color:#f92672">(</span>Element element<span style="color:#f92672">,</span> ParserContext parserContext<span style="color:#f92672">,</span> BeanDefinitionBuilder builder<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    builder<span style="color:#f92672">.</span><span style="color:#a6e22e">setRole</span><span style="color:#f92672">(</span>BeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">ROLE_INFRASTRUCTURE</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isAspectJWeavingEnabled<span style="color:#f92672">(</span>element<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttribute</span><span style="color:#f92672">(</span>ASPECTJ_WEAVING_ATTRIBUTE<span style="color:#f92672">),</span> parserContext<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getRegistry</span><span style="color:#f92672">().</span><span style="color:#a6e22e">containsBeanDefinition</span><span style="color:#f92672">(</span>ASPECTJ_WEAVING_ENABLER_BEAN_NAME<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            RootBeanDefinition def <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RootBeanDefinition<span style="color:#f92672">(</span>ASPECTJ_WEAVING_ENABLER_CLASS_NAME<span style="color:#f92672">);</span>
            parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">registerBeanComponent</span><span style="color:#f92672">(</span>
                    <span style="color:#66d9ef">new</span> BeanComponentDefinition<span style="color:#f92672">(</span>def<span style="color:#f92672">,</span> ASPECTJ_WEAVING_ENABLER_BEAN_NAME<span style="color:#f92672">));</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isBeanConfigurerAspectEnabled<span style="color:#f92672">(</span>parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getReaderContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getBeanClassLoader</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">new</span> SpringConfiguredBeanDefinitionParser<span style="color:#f92672">().</span><span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>element<span style="color:#f92672">,</span> parserContext<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="aspectj-weaving">aspectj-weaving</h3>
<p>这里便是加载其织入的开关，共有三个选项: on, off, autodect。前两个自不必说，autodect表示自动去检测/META-INF下是否存在aop.xml，如果有，那么开启。</p>
<p>此功能依赖于spring-aspectj包，此jar包下有aop.xml，所以autodect也是开启的。</p>
<h3 id="是否开启">是否开启</h3>
<p>isAspectJWeavingEnabled方法用于判断是否启用:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isAspectJWeavingEnabled</span><span style="color:#f92672">(</span>String value<span style="color:#f92672">,</span> ParserContext parserContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;on&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>value<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;off&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>value<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 寻找aop.xml
</span><span style="color:#75715e"></span>        ClassLoader cl <span style="color:#f92672">=</span> parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getReaderContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getResourceLoader</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>cl<span style="color:#f92672">.</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span>AspectJWeavingEnabler<span style="color:#f92672">.</span><span style="color:#a6e22e">ASPECTJ_AOP_XML_RESOURCE</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="aspectjweavingenabler">AspectJWeavingEnabler</h3>
<p>从源码中可以看出，Spring向容器放了一个这东西，名字叫org.springframework.context.config.internalAspectJWeavingEnabler。这东西用来向LoadTimeWeaver设置aspectj的ClassPreProcessorAgentAdapter对象。其类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/AspectJWeavingEnabler.jpg" alt="AspectJWeavingEnabler类图"></p>
<h3 id="springconfiguredbeandefinitionparser">SpringConfiguredBeanDefinitionParser</h3>
<p>如果isBeanConfigurerAspectEnabled方法返回true，那么将会生成一个此对象并调用其parse方法，查看ContextNamespaceHandler的init方法源码可以发现，spring-configured对应的解析器其实就是它:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">registerBeanDefinitionParser<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;spring-configured&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> SpringConfiguredBeanDefinitionParser<span style="color:#f92672">());</span>
</code></pre></div><p>其parse方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> BeanDefinition <span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>Element element<span style="color:#f92672">,</span> ParserContext parserContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// org.springframework.context.config.internalBeanConfigurerAspect
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getRegistry</span><span style="color:#f92672">().</span><span style="color:#a6e22e">containsBeanDefinition</span><span style="color:#f92672">(</span>BEAN_CONFIGURER_ASPECT_BEAN_NAME<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        RootBeanDefinition def <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RootBeanDefinition<span style="color:#f92672">();</span>
         <span style="color:#75715e">// org.springframework.beans.factory.aspectj.AnnotationBeanConfigurerAspect
</span><span style="color:#75715e"></span>        def<span style="color:#f92672">.</span><span style="color:#a6e22e">setBeanClassName</span><span style="color:#f92672">(</span>BEAN_CONFIGURER_ASPECT_CLASS_NAME<span style="color:#f92672">);</span>
        def<span style="color:#f92672">.</span><span style="color:#a6e22e">setFactoryMethodName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;aspectOf&#34;</span><span style="color:#f92672">);</span>
        def<span style="color:#f92672">.</span><span style="color:#a6e22e">setRole</span><span style="color:#f92672">(</span>BeanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">ROLE_INFRASTRUCTURE</span><span style="color:#f92672">);</span>
        def<span style="color:#f92672">.</span><span style="color:#a6e22e">setSource</span><span style="color:#f92672">(</span>parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">extractSource</span><span style="color:#f92672">(</span>element<span style="color:#f92672">));</span>
        parserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">registerBeanComponent</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> BeanComponentDefinition
            <span style="color:#f92672">(</span>def<span style="color:#f92672">,</span> BEAN_CONFIGURER_ASPECT_BEAN_NAME<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>很明显，把org.springframework.beans.factory.aspectj.AnnotationBeanConfigurerAspect添加到容器里了，这其实是一个切面，其类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/AnnotationBeanConfigurerAspect.jpg" alt="AnnotationBeanConfigurerAspect类图"></p>
<p>AnnotationBeanConfigurerAspect及其父类其实是由aspectj源文件(.aj)编译而来，所以在spring-aspectj的源码包中看到的是.aj文件而不是.java。</p>
<p>下面就去aj文件中看看到底定义了哪些pointcut以及advise。</p>
<p>语法可以参考:</p>
<p><a href="http://jinnianshilongnian.iteye.com/blog/1415606">Spring 之AOP AspectJ切入点详解</a></p>
<h4 id="切点pointcut">切点(pointcut)</h4>
<h5 id="inconfigurablebean">inConfigurableBean</h5>
<p>在AnnotationBeanConfigurerAspect中定义，源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> pointcut <span style="color:#a6e22e">inConfigurableBean</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">@this</span><span style="color:#f92672">(</span>Configurable<span style="color:#f92672">);</span>
</code></pre></div><p>@this没找到相关说明，结合@以及this的语义，猜测是匹配<strong>带有@Configurable注解(以及作为元注解)的类</strong>。</p>
<h5 id="beanconstruction">beanConstruction</h5>
<p>源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> pointcut <span style="color:#a6e22e">beanConstruction</span><span style="color:#f92672">(</span>Object bean<span style="color:#f92672">)</span> <span style="color:#f92672">:</span>
            initialization<span style="color:#f92672">(</span>ConfigurableObject<span style="color:#f92672">+.</span><span style="color:#a6e22e">new</span><span style="color:#f92672">(..))</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">(</span>bean<span style="color:#f92672">);</span>
</code></pre></div><p>initialization表示匹配构造器的调用，ConfigurableObject+表示ConfigurableObject及其子类，这就说明可以用实现ConfigurableObject接口的方式代替@Configurable注解。this(bean)表示this必须满足this instanceof bean，也就是说被代理的对象必须是bean的子类。</p>
<h5 id="preconstructioncondition">preConstructionCondition</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> pointcut <span style="color:#a6e22e">preConstructionCondition</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span>
            leastSpecificSuperTypeConstruction<span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> preConstructionConfiguration<span style="color:#f92672">();</span>
</code></pre></div><p>由两个pointcut与运算而来。</p>
<h5 id="leastspecificsupertypeconstruction">leastSpecificSuperTypeConstruction</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> pointcut <span style="color:#a6e22e">leastSpecificSuperTypeConstruction</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> initialization<span style="color:#f92672">(</span>ConfigurableObject<span style="color:#f92672">.</span><span style="color:#a6e22e">new</span><span style="color:#f92672">(..));</span>
</code></pre></div><h5 id="preconstructionconfiguration">preConstructionConfiguration</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> pointcut <span style="color:#a6e22e">preConstructionConfiguration</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> preConstructionConfigurationSupport<span style="color:#f92672">(*);</span>
<span style="color:#66d9ef">private</span> pointcut <span style="color:#a6e22e">preConstructionConfigurationSupport</span><span style="color:#f92672">(</span>Configurable c<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">@this</span><span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>c<span style="color:#f92672">.</span><span style="color:#a6e22e">preConstruction</span><span style="color:#f92672">());</span>
</code></pre></div><p>preConstruction表示@Configurable注解的preConstruction属性，此属性表示是否注入操作可以发生在构造之前，默认false。</p>
<h5 id="postconstructioncondition">postConstructionCondition</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> pointcut <span style="color:#a6e22e">postConstructionCondition</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span>
            mostSpecificSubTypeConstruction<span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>preConstructionConfiguration<span style="color:#f92672">();</span>
</code></pre></div><p>mostSpecificSubTypeConstruction:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> pointcut <span style="color:#a6e22e">mostSpecificSubTypeConstruction</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>thisJoinPoint<span style="color:#f92672">.</span><span style="color:#a6e22e">getSignature</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDeclaringType</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> thisJoinPoint<span style="color:#f92672">.</span><span style="color:#a6e22e">getThis</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">());</span>
</code></pre></div><p>advise可以声明JoinPoint类型的方法参数，thisJoinpoint指的就是这个。此pointcut的目的是匹配接口/抽象类的最具体的实现。</p>
<h4 id="advise">advise</h4>
<h5 id="前置">前置</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">before<span style="color:#f92672">(</span>Object bean<span style="color:#f92672">)</span> <span style="color:#f92672">:</span>
    beanConstruction<span style="color:#f92672">(</span>bean<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> preConstructionCondition<span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> inConfigurableBean<span style="color:#f92672">()</span>  <span style="color:#f92672">{</span>
    configureBean<span style="color:#f92672">(</span>bean<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="运行-3">运行</h2>
<p>AspectJWeavingEnabler.postProcessBeanFactory:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">postProcessBeanFactory</span><span style="color:#f92672">(</span>ConfigurableListableBeanFactory beanFactory<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> BeansException <span style="color:#f92672">{</span>
    enableAspectJWeaving<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">loadTimeWeaver</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanClassLoader</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>enableAspectJWeaving:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">enableAspectJWeaving</span><span style="color:#f92672">(</span>LoadTimeWeaver weaverToUse<span style="color:#f92672">,</span> ClassLoader beanClassLoader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 不为空
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>weaverToUse <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>InstrumentationLoadTimeWeaver<span style="color:#f92672">.</span><span style="color:#a6e22e">isInstrumentationAvailable</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            weaverToUse <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InstrumentationLoadTimeWeaver<span style="color:#f92672">(</span>beanClassLoader<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;No LoadTimeWeaver available&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    weaverToUse<span style="color:#f92672">.</span><span style="color:#a6e22e">addTransformer</span><span style="color:#f92672">(</span>
            <span style="color:#66d9ef">new</span> AspectJClassBypassingClassFileTransformer<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ClassPreProcessorAgentAdapter<span style="color:#f92672">()));</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="loadtimeweaveraware">LoadTimeWeaverAware</h3>
<p>AspectJWeavingEnabler实现了LoadTimeWeaverAware接口，那么何时由谁进行注入的呢?</p>
<p>当Context初始化时，AbstractApplicationContext.prepareBeanFactory部分源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// loadTimeWeaver
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">containsBean</span><span style="color:#f92672">(</span>LOAD_TIME_WEAVER_BEAN_NAME<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">addBeanPostProcessor</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> LoadTimeWeaverAwareProcessor<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">));</span>
    <span style="color:#75715e">// Set a temporary ClassLoader for type matching.
</span><span style="color:#75715e"></span>    beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">setTempClassLoader</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ContextTypeMatchClassLoader<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanClassLoader</span><span style="color:#f92672">()));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>很明显，关键在于LoadTimeWeaverAwareProcessor，类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/LoadTimeWeaverAwareProcessor.jpg" alt="LoadTimeWeaverAwareProcessor类图"></p>
<p>postProcessBeforeInitialization方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">postProcessBeforeInitialization</span><span style="color:#f92672">(</span>Object bean<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#66d9ef">instanceof</span> LoadTimeWeaverAware<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        LoadTimeWeaver ltw <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">loadTimeWeaver</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ltw <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                <span style="color:#e6db74">&#34;BeanFactory required if no LoadTimeWeaver explicitly specified&#34;</span><span style="color:#f92672">);</span>
             <span style="color:#75715e">// 去容器找 
</span><span style="color:#75715e"></span>            ltw <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>
                ConfigurableApplicationContext<span style="color:#f92672">.</span><span style="color:#a6e22e">LOAD_TIME_WEAVER_BEAN_NAME</span><span style="color:#f92672">,</span> LoadTimeWeaver<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#f92672">((</span>LoadTimeWeaverAware<span style="color:#f92672">)</span> bean<span style="color:#f92672">).</span><span style="color:#a6e22e">setLoadTimeWeaver</span><span style="color:#f92672">(</span>ltw<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，如果本地的loadTimeWeaver为空，那么会去容器找，调用了getBean方法，也就是说DefaultContextLoadTimeWeaver就是在这里初始化的。</p>
<p>BeanFactoryPostProcessor也是一个bean，所以它的初始化也会BeanPostProcessor的处理。不过注意一点:</p>
<p>BeanPostProcessor的注册是在BeanFactoryPostProcessor的调用之后进行的:</p>
<p>AbstractApplicationContext.refresh:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// Invoke factory processors registered as beans in the context.
</span><span style="color:#75715e"></span>invokeBeanFactoryPostProcessors<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">);</span>
<span style="color:#75715e">// Register bean processors that intercept bean creation.
</span><span style="color:#75715e"></span>registerBeanPostProcessors<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">);</span>
</code></pre></div><p>那么BeanFactoryPostProcessor初始化的时候执行处理的BeanPostProcessor是哪里来的?</p>
<p>AbstractAutowireCapableBeanFactory.applyBeanPostProcessorsBeforeInitialization源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">applyBeanPostProcessorsBeforeInitialization</span><span style="color:#f92672">(</span>Object existingBean<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Object result <span style="color:#f92672">=</span> existingBean<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>BeanPostProcessor beanProcessor <span style="color:#f92672">:</span> getBeanPostProcessors<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        result <span style="color:#f92672">=</span> beanProcessor<span style="color:#f92672">.</span><span style="color:#a6e22e">postProcessBeforeInitialization</span><span style="color:#f92672">(</span>result<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>getBeanPostProcessors:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>BeanPostProcessor<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getBeanPostProcessors</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanPostProcessors</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，并没有查找容器的过程，所以此处并不会导致BeanPostProcessor的初始化。问题的关键就在于LoadTimeWeaverAwareProcessor的添加方式:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">addBeanPostProcessor</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> LoadTimeWeaverAwareProcessor<span style="color:#f92672">(</span>beanFactory<span style="color:#f92672">));</span>
</code></pre></div><p>直接将实例添加到BeanFactory中，所以可以得出结论:</p>
<p><strong>我们自定义的BeanPostProcessor不会对BeanFactoryPostProcessor的初始化造成影响，除非使用调用BeanFactory.addBeanPostProcessor的方式进行添加</strong>。</p>
<h3 id="beanclassloaderaware">BeanClassLoaderAware</h3>
<h4 id="入口-3">入口</h4>
<p>DefaultContextLoadTimeWeaver同样实现了此接口，那么哪里调用的呢?</p>
<p>AbstractAutowireCapableBeanFactory.initializeBean调用了invokeAwareMethods方法，源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invokeAwareMethods</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> Object bean<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#66d9ef">instanceof</span> Aware<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#66d9ef">instanceof</span> BeanNameAware<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#f92672">((</span>BeanNameAware<span style="color:#f92672">)</span> bean<span style="color:#f92672">).</span><span style="color:#a6e22e">setBeanName</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#66d9ef">instanceof</span> BeanClassLoaderAware<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#f92672">((</span>BeanClassLoaderAware<span style="color:#f92672">)</span> bean<span style="color:#f92672">).</span><span style="color:#a6e22e">setBeanClassLoader</span><span style="color:#f92672">(</span>getBeanClassLoader<span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#66d9ef">instanceof</span> BeanFactoryAware<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#f92672">((</span>BeanFactoryAware<span style="color:#f92672">)</span> bean<span style="color:#f92672">).</span><span style="color:#a6e22e">setBeanFactory</span><span style="color:#f92672">(</span>AbstractAutowireCapableBeanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="setbeanclassloader">setBeanClassLoader</h4>
<p>这个方法很关键，对instrument的获取就是在这里。源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setBeanClassLoader</span><span style="color:#f92672">(</span>ClassLoader classLoader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    LoadTimeWeaver serverSpecificLoadTimeWeaver <span style="color:#f92672">=</span> createServerSpecificLoadTimeWeaver<span style="color:#f92672">(</span>classLoader<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>serverSpecificLoadTimeWeaver <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">loadTimeWeaver</span> <span style="color:#f92672">=</span> serverSpecificLoadTimeWeaver<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>InstrumentationLoadTimeWeaver<span style="color:#f92672">.</span><span style="color:#a6e22e">isInstrumentationAvailable</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">loadTimeWeaver</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InstrumentationLoadTimeWeaver<span style="color:#f92672">(</span>classLoader<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">loadTimeWeaver</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ReflectiveLoadTimeWeaver<span style="color:#f92672">(</span>classLoader<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>很明显分为三部分。</p>
<h5 id="服务器agent">服务器agent</h5>
<p>Spring首先会去检测是否存在服务器的agent代理。按照Spring doc里说的，支持下列服务器:</p>
<blockquote>
<pre><code>Oracle WebLogic 10,GlassFish 3, Tomcat 6, 7 and 8, JBoss AS 5, 6 and 7, IBM WebSphere 7 and 8.
</code></pre></blockquote>
<p>createServerSpecificLoadTimeWeaver源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> LoadTimeWeaver <span style="color:#a6e22e">createServerSpecificLoadTimeWeaver</span><span style="color:#f92672">(</span>ClassLoader classLoader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String name <span style="color:#f92672">=</span> classLoader<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>name<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;weblogic&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> WebLogicLoadTimeWeaver<span style="color:#f92672">(</span>classLoader<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>name<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.glassfish&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> GlassFishLoadTimeWeaver<span style="color:#f92672">(</span>classLoader<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>name<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.catalina&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> TomcatLoadTimeWeaver<span style="color:#f92672">(</span>classLoader<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>name<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.jboss&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> JBossLoadTimeWeaver<span style="color:#f92672">(</span>classLoader<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>name<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;com.ibm&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> WebSphereLoadTimeWeaver<span style="color:#f92672">(</span>classLoader<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看出，<strong>对于服务器的判断是通过检测当前的类加载器来实现的，因为这些服务器都使用了自己的类加载器实现</strong>。</p>
<p>这也从侧面说明，如果当前处于以上服务器所在的web应用环境，不需要spring-agent.jar便可以实现LTW(载入期织入)。</p>
<h5 id="spring-agent">Spring agent</h5>
<p>这个也是测试时使用的。InstrumentationLoadTimeWeaver.isInstrumentationAvailable：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isInstrumentationAvailable</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>getInstrumentation<span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Instrumentation <span style="color:#a6e22e">getInstrumentation</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>AGENT_CLASS_PRESENT<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> InstrumentationAccessor<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstrumentation</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>AGENT_CLASS_PRESENT是一个布尔变量，就是判断org.springframework.instrument.InstrumentationSavingAgent是否存在，这个便是spring-agent.jar中唯一的类。</p>
<p>InstrumentationAccessor是InstrumentationLoadTimeWeaver的内部类:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InstrumentationAccessor</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Instrumentation <span style="color:#a6e22e">getInstrumentation</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> InstrumentationSavingAgent<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstrumentation</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这里便是获取spring-agent.jar暴露的Instrumentation对象的地方了。</p>
<h5 id="反射">反射</h5>
<p>在这种情况中，Spring寄托于当前的ClassLoader实现了LoadTimeWeaver的功能，也就是必须有addTransformer方法，如果有，Spring便会把LoadTimeWeaver的职责委托给ClassLoader，如果没有只能抛异常了(抱歉，我们没法支持LTW&hellip;)，检测的源码位于ReflectiveLoadTimeWeaver的构造器:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ReflectiveLoadTimeWeaver</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">(</span>ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getDefaultClassLoader</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ReflectiveLoadTimeWeaver</span><span style="color:#f92672">(</span>ClassLoader classLoader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">notNull</span><span style="color:#f92672">(</span>classLoader<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;ClassLoader must not be null&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">classLoader</span> <span style="color:#f92672">=</span> classLoader<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">addTransformerMethod</span> <span style="color:#f92672">=</span> ClassUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getMethodIfAvailable</span><span style="color:#f92672">(</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">classLoader</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> ADD_TRANSFORMER_METHOD_NAME<span style="color:#f92672">,</span> ClassFileTransformer<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">addTransformerMethod</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="总结">总结</h5>
<p>其实可以不用Spring，只使用aspectj自己便可以实现LTW，只需要把代理jar包设为aspect-weaver.jar，并自己编写aop.xml文件以及相应的aspect类即可。可以参考官方文档:</p>
<p><a href="http://www.eclipse.org/aspectj/doc/released/devguide/ltw-configuration.html#enabling-load-time-weaving">Chapter 5. Load-Time Weaving</a></p>
<h3 id="classfiletransformer">ClassFileTransformer</h3>
<p>从enableAspectJWeaving方法的源码可以看出，实际上就是向DefaultContextLoadTimeWeaver添加了一个AspectJClassBypassingClassFileTransformer对象。根据java instrument API的定义，每当一个Class被加载的时候都会去调用挂在Instrumentation上的ClassFileTransformer的transform方法。所以LTW的核心便在这里了。</p>
<p>AspectJClassBypassingClassFileTransformer.transform:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">transform</span><span style="color:#f92672">(</span>ClassLoader loader<span style="color:#f92672">,</span> String className<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;</span> classBeingRedefined<span style="color:#f92672">,</span>
        ProtectionDomain protectionDomain<span style="color:#f92672">,</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> classfileBuffer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// aspectj自身的类无需检测(织入)，直接跳过
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>className<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.aspectj&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> className<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org/aspectj&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> classfileBuffer<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delegate</span><span style="color:#f92672">.</span><span style="color:#a6e22e">transform</span><span style="color:#f92672">(</span>loader<span style="color:#f92672">,</span> className<span style="color:#f92672">,</span> classBeingRedefined<span style="color:#f92672">,</span> 
        protectionDomain<span style="color:#f92672">,</span> classfileBuffer<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>delegate是一个org.aspectj.weaver.loadtime.ClassPreProcessorAgentAdapter对象。这是一个适配器模式，其类图:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ClassPreProcessorAgentAdapter.jpg" alt="ClassPreProcessorAgentAdapter类图"></p>
<p>根据Aspectj的doc，ClassPreProcessor用于将Aspectj 5对于jdk5依赖代码抽取出来以便可以支持jdk1.3/1.4.</p>
<h3 id="aj">Aj</h3>
<p>Aj的preProcess方法很长，其实只干了两件事，都是围绕着WeavingAdaptor进行的。对类的处理也转交给WeavingAdaptor的weaveClass方法。</p>
<h4 id="缓存">缓存</h4>
<p>Aj使用了WeavingAdaptor缓存机制，确保一个ClassLoader只有一个WeavingAdaptor对象，因为其初始化的成本很高，缓存利用一个key为AdaptorKey(包装了ClassLoader), value为WeavingAdaptor的HashMap来实现。</p>
<h4 id="weavingadaptor初始化">WeavingAdaptor初始化</h4>
<p>初始化就是ClassLoaderWeavingAdaptor.initialize方法，初始化分部分来进行说明。Aspectj部分不再详细展开，只对关键的部分进行说明。</p>
<h5 id="aopxml">aop.xml</h5>
<h6 id="解析-3">解析</h6>
<p>aop.xml的解析便是在这里进行。解析的过程无非是xml的解析，下面是其结果如何存储的:</p>
<p>以org.aspectj.weaver.loadtime.definition.Definition为载体，我们以spring-aspects.jar下的aop.xml为例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;aspectj&gt;</span>
    <span style="color:#f92672">&lt;aspects&gt;</span>
        <span style="color:#f92672">&lt;aspect</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;org.springframework.beans.factory.aspectj.AnnotationBeanConfigurerAspect&#34;</span><span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;aspect</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;org.springframework.scheduling.aspectj.AnnotationAsyncExecutionAspect&#34;</span><span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;aspect</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;org.springframework.transaction.aspectj.AnnotationTransactionAspect&#34;</span><span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;aspect</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;org.springframework.transaction.aspectj.JtaAnnotationTransactionAspect&#34;</span><span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;aspect</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;org.springframework.cache.aspectj.AnnotationCacheAspect&#34;</span><span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;aspect</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;org.springframework.cache.aspectj.JCacheCacheAspect&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/aspects&gt;</span>
<span style="color:#f92672">&lt;/aspectj&gt;</span>
</code></pre></div><p>那么解析后的结果:</p>
<p><img src="/images/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/aop_xml_parse.png" alt="aop.xml解析结果"></p>
<h6 id="注册">注册</h6>
<p>入口方法在ClassLoaderWeavingAdaptor.registerDefinitions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">registerDefinitions</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> BcelWeaver weaver<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> ClassLoader loader<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>Definition<span style="color:#f92672">&gt;</span> definitions<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//对应&lt;weaver options=&#34;-verbose&#34;&gt;
</span><span style="color:#75715e"></span>    registerOptions<span style="color:#f92672">(</span>weaver<span style="color:#f92672">,</span> loader<span style="color:#f92672">,</span> definitions<span style="color:#f92672">);</span>
    <span style="color:#75715e">//对应&lt;exclude&gt;标签
</span><span style="color:#75715e"></span>    registerAspectExclude<span style="color:#f92672">(</span>weaver<span style="color:#f92672">,</span> loader<span style="color:#f92672">,</span> definitions<span style="color:#f92672">);</span>
    <span style="color:#75715e">//对应&lt;include&gt;标签
</span><span style="color:#75715e"></span>    registerAspectInclude<span style="color:#f92672">(</span>weaver<span style="color:#f92672">,</span> loader<span style="color:#f92672">,</span> definitions<span style="color:#f92672">);</span>
    <span style="color:#75715e">// &lt;aspect&gt;
</span><span style="color:#75715e"></span>    success <span style="color:#f92672">=</span> registerAspects<span style="color:#f92672">(</span>weaver<span style="color:#f92672">,</span> loader<span style="color:#f92672">,</span> definitions<span style="color:#f92672">);</span>
    registerIncludeExclude<span style="color:#f92672">(</span>weaver<span style="color:#f92672">,</span> loader<span style="color:#f92672">,</span> definitions<span style="color:#f92672">);</span>
    <span style="color:#75715e">//对应&lt;dump&gt;标签
</span><span style="color:#75715e"></span>    registerDump<span style="color:#f92672">(</span>weaver<span style="color:#f92672">,</span> loader<span style="color:#f92672">,</span> definitions<span style="color:#f92672">);</span>
    <span style="color:#75715e">//忽略返回
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><h4 id="总结-1">总结</h4>
<p>Spring将切面以编译过的Aspectj语言形式定义，不过也可以用原生java类。spring-aspectj包定义的是供各个模块进行LTW的切面。Aspectj部分不再继续向下深入探究。</p>
        </div>
        <footer class="article-footer">
    <a data-url="https://dijun.cf/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" data-id="e7ce2275fb2667042c1be3be5ad7e858" class="article-share-link">
        <i class="fa fa-share"></i>
        Share
    </a>
    

    <script>
    (function ($) {
        
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
    </script>
</footer>

    </div>

    
<nav id="article-nav">
    
    <a href="https://dijun.cf/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">
          Older
      </strong>
      <div class="article-nav-title">Spring Aop源码分析</div>
    </a>
    

    
    <a href="https://dijun.cf/spring-transaction%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">
          Newer
      </strong>
      <div class="article-nav-title">Spring Transaction源码分析</div>
    </a>
    
</nav>


</article>



    </section>

   	
    	<aside id="sidebar">
    
<div class="widget-wrap">
    <h3 class="widget-title">
        Recents
    </h3>
    <div class="widget">
      <ul id="recent-post">
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/spring-task%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner2.jpg)" alt="Spring Context源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/spring">
                        spring
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/spring-task%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="title">Spring Task源码分析</a></p>
                    <p class="item-date">
                        <time datetime="2018-06-26 14:40:31 &#43;0000 UTC" itemprop="datePublished">2018-06-26</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/spring-mvc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner4.jpg)" alt="Spring Context源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/spring">
                        spring
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/spring-mvc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="title">Spring Mvc源码分析</a></p>
                    <p class="item-date">
                        <time datetime="2018-06-25 15:03:57 &#43;0000 UTC" itemprop="datePublished">2018-06-25</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/spring-transaction%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner1.jpg)" alt="Spring Context源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/spring">
                        spring
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/spring-transaction%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="title">Spring Transaction源码分析</a></p>
                    <p class="item-date">
                        <time datetime="2018-06-15 14:57:50 &#43;0000 UTC" itemprop="datePublished">2018-06-15</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner1.jpg)" alt="Spring Context源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/spring">
                        spring
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/spring-context%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="title">Spring Context源码分析</a></p>
                    <p class="item-date">
                        <time datetime="2018-06-06 23:19:43 &#43;0000 UTC" itemprop="datePublished">2018-06-06</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://dijun.cf/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="thumbnail">
                    
                        
                        <span style="background-image:url(/banners/banner4.jpg)" alt="Spring Context源码分析" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://dijun.cf/categories/spring">
                        spring
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://dijun.cf/spring-aop%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="title">Spring Aop源码分析</a></p>
                    <p class="item-date">
                        <time datetime="2018-06-06 12:08:31 &#43;0000 UTC" itemprop="datePublished">2018-06-06</time>
                    </p>
                </div>
            </li>
            
        </ul>
    </div>
</div>


    


<div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
        <ul class="category-list">
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/categories/java">
                    java
                </a>
                <span class="category-list-count">3</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/categories/java%E8%99%9A%E6%8B%9F%E6%9C%BA">
                    java虚拟机
                </a>
                <span class="category-list-count">6</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/categories/spring">
                    spring
                </a>
                <span class="category-list-count">7</span>
            </li>
            
        </ul>
    </div>
</div>




    


<div class="widget-wrap">
    <h3 class="widget-title">
        Tags
    </h3>
    <div class="widget">
        <ul class="category-list">
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/java">
                    java
                </a>
                <span class="category-list-count">9</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/java%E8%99%9A%E6%8B%9F%E6%9C%BA">
                    java虚拟机
                </a>
                <span class="category-list-count">6</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/jvm">
                    jvm
                </a>
                <span class="category-list-count">6</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/spring">
                    spring
                </a>
                <span class="category-list-count">7</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://dijun.cf/tags/%E5%AE%B9%E5%99%A8">
                    容器
                </a>
                <span class="category-list-count">3</span>
            </li>
            
        </ul>
    </div>
</div>




    


<div class="widget-wrap">
    <h3 class="widget-title">
        Tag cloud
    </h3>
    <div class="widget tagcloud">
        
        
        <a href="https://dijun.cf/tags/java" style="font-size: 12px;">java</a>
        
        
        <a href="https://dijun.cf/tags/java%E8%99%9A%E6%8B%9F%E6%9C%BA" style="font-size: 12px;">java虚拟机</a>
        
        
        <a href="https://dijun.cf/tags/jvm" style="font-size: 12px;">jvm</a>
        
        
        <a href="https://dijun.cf/tags/spring" style="font-size: 12px;">spring</a>
        
        
        <a href="https://dijun.cf/tags/%E5%AE%B9%E5%99%A8" style="font-size: 12px;">容器</a>
        
    </div>
</div>





    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

    
	</div>
</div>

<footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020
      <a href="https://dijun.cf">狄俊</a>. All rights reserved.
    </div>
  </div>
</footer>


<script src="https://dijun.cf/fancybox/jquery.fancybox.pack.js"></script>
<script src="https://dijun.cf/js/script.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>


<script>hljs.initHighlightingOnLoad();</script>





</body>
</html>